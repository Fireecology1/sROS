---
title: "Simple models for conifer surface fires"
author: "D. D. B. Perrakis S. W. Taylor"
Output:
  word_document:
    fig_width: 6.3
    fig_height: 6.3
  pdf_document: default
output: word_document
bibliography: 'C:/Dan/Zotero/My library.bib'
csl: "ecological-applications.csl"
---

#ok - references are working; just need to fix all citations! Use the keys found in Zotero, not here

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,root.dir = 'c:/Dan/_Remote_projects/ccp-sROS')

#setwd("c:/Dan/_Remote_projects/ccp-sROS/files")

#.libPaths("C:/Dan/RPackages")

library(tidyverse)

#Get data frame, ready to query 
#Import data frame
fd <- read.csv('./files/fire_data_may2024.csv')  # with corrected SFC from McRae, Sharp p#16 to sharp.th, PNFI R5 MC.SA

#FWI and moisture functions 
load(file='./files/wbmc5.rda')
load(file='./files/mcF.rda')
load(file='./files/ISI.rda')
load(file='./files/gr-cf.rda')

#set variables for modelling
fd4 <- mutate(fd, 
              CFI=CFI1, #lower CFI only for multi-story stands
              FSG=FSG1)  #same for FSG

#Deciduous data
d1 <- read.csv('./files/fire_data_d1_apr2024.csv')

#Combine conifer data with D1
fd.all <- bind_rows(fd4 %>% select(
  num:RH, Grass.Cure, Plot.Wd) %>%
    mutate(Date=ymd(Date)), 
  d1 %>% select(num:RH, Grass.Cure, Plot.Wd) %>%
    mutate(Date=ymd(Date)))  

```

## Abstract

Fire behaviour in conifer forests can be overshadowed by the problem of crown fire, though surface fire occurrence is more common. Surface fire behaviour models can help predict fire spread below the crowning threshold, under moderate fire danger conditions or under most conditions in forest stands with a high crown base. We used a database of conifer-dominated experimental surface fires (n=91) to fit simple empirical models of rate of spread (ROS) that can be readily integrated within operational decision support systems. Final models include wind speed along with optional additional variables for estimated fine fuel moisture content and surface fuel consumption - positively, negatively, and positively correlated with ROS, respectively. While imprecise, these models are usually accurate enough (within +/- 1â€“3 m min^-1^) for most forecasting and fire management purposes.

### [Process - get SF data]

```{r label=site.indexes, echo=FALSE, message=FALSE}

#Index numbers for different sites
porters <- filter(fd4, str_detect(fire, "PORTER")) %>% pull(num)
sc <- filter(fd4, str_detect(fire, "PNFI SC")) %>% pull(num) #south corner fire is low dens.
pg.low <- filter(fd4, str_detect(fire, "PRINCE")) %>%
  filter(str_detect(fire, "# 4")) %>% pull(num)   #select shorter stands at PG site only
pg.high <- filter(fd4, str_detect(fire, "PRINCE")) %>% 
  filter(str_detect(fire, "# 1")) %>% pull(num)
kenshoe <- filter(fd4, str_detect(fire, "KENSHOE")) %>% pull(num)
sharp <- filter(fd4, str_detect(ExpProject, "Sharpsand IM")) %>% pull(num)  #original Sharpsand Immature stands only
sharp.th <- filter(fd4, str_detect(ExpProject, "Sharpsand TH")) %>% pull(num)
sharp.sm <- filter(fd4, str_detect(ExpProject, "Sharpsand SM")) %>% pull(num)
rp <- filter(fd4, str_detect(fire, "PNFI RP")) %>% pull(num)
darwin <- filter(fd4, str_detect(fire, "DARWIN")) %>% pull(num)  #1, 2, 6, 7 are  low density plots
darwin.low <- c(66, 67, 90, 91)
bigfish <- filter(fd4, str_detect(fire, "BIG FISH")) %>% pull(num)
icfme <- 77:87 #order is A, 1, 2, 3, 4, 5, 6, 7, 8a, 8b, 9; fixed in icfme process
icfme.hd <- c(77:79, 82:87)  #all but p3, p4
#archer <- 109:117
pelican <- 109:110  #Changed for Mar2023; was 123-124
#fpft <- c(119:122, 125:126)
dewdrop <- filter(fd4, str_detect(ExpProject, 'Dewdrop')) %>% pull(num)

#function to calculate isi.m
isi.mcsa <- function(mcsa, ws) {
  m=mcsa
  f_w= exp(0.05039*ws)
  f_f= (91.9*exp(-0.1386*m))*(1+(m^5.31)/(4.93*10^7))
  return(0.208*f_w*f_f)
}

#surface fires - extract all CFI1==0, calculate isi.m
s.fires <- mutate(rowwise(fd.all), 
                  isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>% #get ISI using MC.SA
  filter(CFI1==0) %>% 
  select(-CFI2) %>%
  mutate(FT=as.factor(case_when(
           str_detect(ExpProject, 'D1') ~ 'Decid',
           str_detect(ExpProject, 'Dewdrop') ~ 'PPDF',
           TRUE ~ 'Con'))
         ) %>%
  ungroup() %>% as.data.frame()
 
#Add FBP database missing VW fires: 2 C4, 2 C5
s.miss0 <- data.frame(num=122:125, 
                      fire=c('PNFI #1 13 yr ONT',
                             'PNFI #2 12 yr ONT',
                             'PNFI RW #1-41-2', 
                             'Carp Lk PNFI WF QC'),
                     CFI1=0, Fire.type='S', 
                     ROS=c(7.6, 4.3, 3, 7.5),
                     SFC=c(1.6, 0.59, 0.3, 0.9), #only 0.59 was meaasured
      #Estimated SFC for 3/4 obs: C4 est: 1.64 (BUI 57); C5 est: 0.28 (BUI 25), 0.85 (BUI 45)
                     CFC=c(0, 1.0, 0, 0), 
                     Date=c('1977-05-19', '1976-08-04', 
                            '1976-05-10', '1963-07-03') %>% ymd(),
      ws=c(19, 10, 18, 25),
      FFMC=c(91.7, 89.9, 90.4, 90.7), 
      ISI=c(14.2, 7, 11.2, 16.7), 
      DMC=c(57, 26, 20, 45), 
      DC=c(107, 276, 86, 81), 
      BUI=c(57, 42, 25, 45), 
      MC.SA_season=c(1, 2, 1, 2), 
      MC.SA_dens=2, 
      MC.SA_stand=4, FT='Con') #consider all 4 to be pine stands (conifer type)

#with ISI.mcsa values for the first two C4 PNFI fires
s.miss <- mutate(rowwise(s.miss0), 
                 MC.SA=wbmc5(FFMC, DMC, MC.SA_stand, 
                             MC.SA_dens, MC.SA_season),
                 isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>%
  as.data.frame() 
  

s.fires2 <- bind_rows(s.fires, s.miss)

#calculate my own r2 function
r2nls <- function(model){
  RSS=sum(residuals(model)^2)
  augmod=broom::augment(model)
  TSS=sum(augmod$ROS^2)
  r2=1-(RSS/TSS)
  return(r2)
}


```

### [Proc. SF models]

```{r label=sROS, echo=FALSE, message=FALSE, warning=FALSE}
#ROS models 

#original ccp (2019) sf formula
sros.st <- function(isi) {
  0.6308 + 0.056*isi + 0.0086*isi^2
}

#Original unaltered conifer SF only - excludes D1, PPDF fires
s.fires.con <- filter(s.fires2, FT=='Con') 

#conifer-only isi.mcsa^2 ROS model
con.lm.mod <- lm(data=s.fires.con, formula=ROS~I(isi.m^2)-1)

#prediction function for simple lm using isi.m
sf.con.fun <- function(isim) {
  predict(con.lm.mod, newdata=list(isi.m=isim))
}

#Noted - fires with some torching seem to be anomalous
#Exceptions: fires with torching, CFC >1
except <- filter(s.fires, CFC > 0.1 | num==48) %>%
  mutate(FT='Torch')  #using this in fuel type variable for graphs

wildfires <- filter(s.fires2, num %in% c(68, 69, 76,
                                        125)) %>%
  mutate(FT='WF')
#filter out fires with CFC; somewhat anomalous
#first convert all NA CFC values to 0
s.fires3 <- s.fires2 %>% 
  mutate(
    CFC=ifelse(num==48, 0.2, CFC),   #assume R3 torching
    CFC=ifelse(is.na(CFC), 0, CFC)) %>%
            filter(CFC <= 0.1)

#Curing and C7 fires
ppdf <- filter(s.fires3, num %in% dewdrop & !is.na(Grass.Cure))

c7.fullcuring <- 100  #
fc.cf <- gr.cf(c7.fullcuring)

#grass curing function
s.fires.mod <- s.fires3 %>%
  mutate(CF=gr.cf(curing=Grass.Cure),
         ROS=ifelse(is.na(Grass.Cure), ROS,
            ROS/2+ROS*fc.cf*(1/CF)/2)) #0.5 actual ROS plus 0.5
                 #of 'full curing' ROS if it was all grass

#show exceptions, other issues
# ggplot(s.fires, aes(x=ISI, y=ROS)) + 
#  geom_point() + geom_point(data=except, shape=21, size=4)


#So far these models involve - 
# - Cutting out data with CFC > 1
# - 'Detrending' PIPO fires to simulate 100% grass curing, half
# - including substantial percentage of D1 fires

#linear model using ISI^2
sros.ISI2.mod <- lm(ROS ~ I(ISI^2)-1, data=s.fires.mod)
#r^2=0.7217 with s.fires3
#r^2=0.692 with s.fires.mod

#lm using isi.m^2
sros.isim2.mod <- lm(ROS ~ I(isi.m^2)-1, data=s.fires.mod)
#r^2=0.708 with s.fires2
#r^2=0.7605 with s.fires.mod

#lm using isi.m AND SFC - best simple model overall
sros.isim2SFC.mod <- lm(ROS ~ I(isi.m^2) + SFC-1, data=s.fires.mod)
#r^2=0.75 with s.fires2
#r^2=0.8025 with s.fires.mod
#r^2=0.617 with s.fires.con


#similar model with ISI (sros.ISI2SFC.mod) is also good, but not as good
sros.ISI2SFC.mod <- lm(ROS ~ I(ISI^2) + SFC - 1, data=s.fires.mod)
#r^2=0.7501

#prediction functions
sf.lin.fun <- function(ws) {
  predict(sros.lin.mod, newdata=list(ws=ws))
}

#nls model and prediction function: ax^b format
sf.axb.isi.mod <- nls(data=s.fires.mod, formula= 
               ROS ~ a * ISI^b, start=list(a=1, b=2))

sf.axbisi.fun <- function(isi) {
  predict(sf.axb.isi.mod, newdata=list(ISI=isi))
}


#fake data for lines - isim2SFC / IsaSFC model; fros1 is at SFC=1.34, fros2 is at SFC=2
#also ISI2SFC model and 
f.sfires0 <- data.frame(fisim=seq(0:30), fsfc1=1.34, fsfc2=2)
f.sfires <-mutate(rowwise(f.sfires0),
              fros1=predict(sros.isim2SFC.mod, 
              newdata=list(isi.m=fisim, SFC=fsfc1)),
              fros2=predict(sros.isim2SFC.mod, 
              newdata=list(isi.m=fisim, SFC=fsfc2)))

#sigmoidal curve like FBP; try c6s to start
#then vary b and c params
c6s <- function(isi) {
  ros=30 * (1-exp(-0.08*isi))^3
  return(ros)
}

#vw 1993 surface model for c4 immature pine stands
sf.vw93i <- function(isi) {
 20*(1-exp(-0.2*isi))^5 
}

#vw 1993 surface model for c3 mature pine stands
sf.vw93m <- function(isi) {
 15*(1-exp(-0.05*isi))^2 
}

#D1
sf.d1 <- function(isi) {
  30*(1-exp(-0.0232*isi))^1.6 
}


#fit Chapman-Richards function to surface fire data
#This will be prediction model going forward
sf.crisim.mod <- nls(data=s.fires.mod, formula= 
               ROS ~ 25 * (1-exp(-b*isi.m))^c, 
               start=list(b=0.08, c=3))


#just need to make a function from the model
sf.crisim.fun <- function(isim) {
  predict(sf.crisim.mod, newdata=list(isi.m=isim))
}
  
#Using ISI
sf.crisi.mod <-nls(data=s.fires.mod, formula= 
               ROS ~ 25 * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

#CR nls function using ISI
sf.crisi.fun <- function(isi) {
  predict(sf.crisi.mod, newdata=list(ISI=isi)) %>% unname()
}

#Conifer obs only!
sf.crisiCon.mod <-nls(data=s.fires.mod %>% filter(FT=='Con'), 
                formula= 
               ROS ~ 25 * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

sf.crisiCon.fun <- function(isi) {
  predict(sf.crisiCon.mod, newdata=list(ISI=isi)) %>% unname()
}

#isi.m
sf.crisimCon.mod <-nls(data=s.fires.mod %>% filter(FT=='Con'), 
                formula= 
               ROS ~ 25 * (1-exp(-b*isi.m))^c, 
               start=list(b=0.1, c=3))

sf.crisimCon.fun <- function(isim) {
  predict(sf.crisimCon.mod, newdata=list(isi.m=isim)) %>% unname()
}


#Add function for ISI2SFC and ISI.mSFC models
sf.isi2sfc.fun <- function(isi, sfc) {
  predict(sros.ISI2SFC.mod, newdata=list(ISI=isi, SFC=sfc)) %>% 
    unname()
}

sf.isim2sfc.fun <- function(isim, sfc) {
  predict(sros.isim2SFC.mod, newdata=list(isi.m=isim, 
                                          SFC=sfc)) %>%
    unname()
}

#SFC=0.75
sf.isim2sfc075.fun <- function(isim) {
  sfc_vals=rep(0.75, length(isim))  #required for stat_function
  predict(sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=1.5
sf.isim2sfc15.fun <- function(isim) {
  sfc_vals=rep(1.5, length(isim))  #required for stat_function
  predict(sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=3
sf.isim2sfc3.fun <- function(isim) {
  sfc_vals=rep(3.0, length(isim))  #required for stat_function
  predict(sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#Fernandes sf model
sf.fernandes <- function(ws, mc, fd) {
  ROS=0.773*ws^0.707*exp(-0.039*mc)*fd^0.188
  return(ROS)
}

#Add ISI-FT and isim-FT models

```

### [More SF mods]

```{r Model list, echo=FALSE}
#Model list

#add sros.st, 
mod.list <- list(con.lm.mod, 
              sros.ISI2.mod,
              sros.ISI2SFC.mod,
              sros.isim2.mod,
              sros.isim2SFC.mod,
              sf.crisi.mod,
              sf.crisim.mod,
              sf.axb.isi.mod,
              sf.crisiCon.mod,
              sf.crisimCon.mod)

modnames <-c('isim2.con', 
              'ISI2.agg',
              'ISI2SFC.agg',
              'isim2.agg',
              'isim2SFC.agg',
              'crisi.agg',
              'crisim.agg',
              'axb.isi.agg',
              'crisi.con',
              'crisim.con')

#generate table of evaluation metrics
acc.table <- lapply(mod.list, broom::glance) 

#extract vars from lists for AIC, nobs
acc.tab2 <- lapply(acc.table, `[`, c('nobs', 'AIC' )) %>%
  list_rbind()

efron.r2.vals <- lapply(mod.list, r2nls) %>%
  unlist()

acc.tab3 <- mutate(acc.tab2, 
                   Model=modnames, 
                   efron.r2=efron.r2.vals) %>%
  select(Model, nobs, efron.r2, AIC)

#write.csv(acc.tab3, 'acc_table.csv')

#ROS table at ISI (ISIm)=4, 8, 12
isi.vals=c(5, 10, 15)
mod.order.isim<- c(1, 4, 7, 10)

#create blank list
pred.list <- vector('list', length(mod.list))
names(pred.list) <- modnames

for (i in seq_along(mod.list)) {
  pred.list[[i]] <- predict(mod.list[[i]], 
                            newdata=data.frame(ISI=isi.vals,
                                               isi.m=isi.vals,
                                               SFC=1.5))
}

pred.df <- data.frame(ISI=isi.vals, pred.list) %>%
  mutate_all(round, 3) 
#names(pred.df) <- c('isi.vals', paste0(modnames))

#transpose
pred2.df <- as.matrix(pred.df) %>% t() %>% as.data.frame() %>%
  mutate(Model=colnames(pred.df)) %>%
  slice(2:ncol(pred.df)) %>%
  select(Model, everything())
row.names(pred2.df) <- NULL
colnames(pred2.df)[2:4] <- c('ISI.5', 'ISI.10', 'ISI.15' ) 

pred2.df %>% mutate(S)

##Then try rpart models
rp.mods <-rpart::rpart(ROS ~ ., data=s.fires.mod %>% 
                  select(ROS, ws, FFMC, ISI, MC.SA, isi.m, SFC, FT),
                  method='anova')
#Hmmm. 

#leaps
#first make dataset with squared terms
s.fires.squared <- s.fires.mod %>%
  mutate(ws2=ws^2, 
         ISI2=ISI^2,
         isi.m2=isi.m^2,
         SFC2=SFC^2,
         SFC.sqrt=sqrt(SFC),
         ) %>%
  select(ROS, ws, ws2, FFMC, ISI, ISI2, MC.SA, isi.m, isi.m2, 
         SFC, SFC2, SFC.sqrt, FT, MC.SA_dens, DMC)

lp.mods <- leaps::regsubsets(ROS ~ ., 
                             data=s.fires.squared, force.out='DMC', 
                             nbest=1, nvmax=4)

best2 <- lm(ROS ~ isi.m2+FFMC-1, data=s.fires.squared)
#DMC factor was illogical, so excluded
#'exhaustive' search for all var combinations revealed models dominated by isi.m2; alone (1 var), with FFMC (2), with FFMC and ISI(3), or with FFMC, ISI, ws2 (4). Gains compared with isi.m2 model alone are very slight, suggesting overfitting. 

#All this effort to say that the best model includes isi.m probably alone as a squared term

#con dataset
s.fires.cosquared <- s.fires.con %>%
  mutate(ws2=ws^2, 
         ISI2=ISI^2,
         isi.m2=isi.m^2,
         SFC2=SFC^2,
         SFC.sqrt=sqrt(SFC),
         ) %>%
  select(ROS, ws, ws2, FFMC, ISI, ISI2, MC.SA, isi.m, isi.m2, 
         SFC, SFC2, SFC.sqrt, MC.SA_dens, DMC)

lp.mods.con <- leaps::regsubsets(ROS ~ ., 
                        data=s.fires.cosquared, force.out='DMC',
                             nbest=1, nvmax=4)  #DMC was bogus
#DMC estimate again negative, so excluded
#test MC.SA_season factor?

best2c <- lm(ROS ~ ISI2 + ISI -1, data=s.fires.cosquared) #no good


#kinda useless function
get.mod.formula <- function(id, object, outcome) {
  models<-summary(object)$which[id,-1]
  predictors <- names(which(models==TRUE))
  predictors <-paste(predictors, collapse ="+")
  as.formula(paste0(outcome, "~"))
}



```

### [graphs]

```{r label=graphs, echo=FALSE}
#more graphs
#plotted data and best model; 
#sf.isim2sfc075.fun function doesn't work yet
fig4 <- ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=isi.m, y=ROS)) +  
  geom_point(aes(colour=FT, size=SFC), alpha=0.5) +    
  geom_point(data=s.fires3 %>% filter(!is.na(SFC)) %>% 
               filter(FT=='PPDF'), 
             aes(size=SFC), shape=21, color='darkgray', 
             fill='darkgray', alpha=0.5) +
#  geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray')+
  stat_function(fun=sf.isim2sfc15.fun, color='pink') +
#  stat_function(fun=sf.isim2sfc3.fun, color='red') +
  stat_function(fun=sf.crisim.fun, color='blue') +
  stat_function(fun=sf.crisimCon.fun, colour='turquoise') +
#  stat_function(fun=sf.con.fun, colour='gray') +
  geom_text(x=24, y=sf.crisim.fun(24)-1, label='CR.ISI_sa') +
  geom_text(x=23, y=sf.isim2sfc15.fun(23)+2, label='ISI_sa.SFC') +
  #geom_text(x=28, y=sf.isim2sfc075.fun(28)+3, 
  #          label='IsaSFC') +
  theme_classic()

fig4

#Graph with vw functions, ISI
fig5 <- ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=ISI, y=ROS)) + 
  geom_point(aes(colour=FT, size=SFC), alpha=0.5) +    
  geom_point(data=s.fires3 %>% filter(FT=='PPDF'), aes(size=SFC), shape=21, size=4, fill='darkgray', alpha=0.5) +
  #geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray') + #IsaSFC model
#  stat_function(fun=sf.axbisi.fun, color='grey') +
  stat_function(fun=sf.crisi.fun, color='black') +
  stat_function(fun=sf.crisiCon.fun, color='gray') +  
  stat_function(fun=sf.vw93i, color='turquoise', linetype='dashed') +
  stat_function(fun=sf.vw93m, color='purple', linetype='dashed') +
  stat_function(fun=c6s, color='darkred') +
  geom_text(x=7, y=sf.vw93i(7)+3, label='VW93i') +
 # geom_text(x=21, y=c6s(21)-1, label='C6s') +
  geom_text(x=25, y=sf.crisi.fun(25)+1, label='CR_Agg') +
  geom_text(x=20, y=sf.vw93m(20)-1, label='VW93m') +
  geom_text(x=26, y=sf.crisiCon.fun(26)-1.5, label='CR_Con')+
  geom_text(x=15, y=c6s(15)+1.5, label='C6S') +
  theme_classic()

fig5

```

## 1. Introduction

The rate of spread, or rate of forward advance, of a wildfire is recognized as its most important descriptive characteristic for fire managers [@VanWagner1965; @Sullivan.Gould2020]. Fire behaviour in the conifer forests of Canada is often a story about crown fire â€“ high intensity, rapidly spreading fires with flames overtopping the trees and ember spotting ahead of the front [@alexanderCrownFireDynamics2016]. And yet in the chronology of fire events, most days between ignition and extinction feature only ground or surface fire behaviour [@Wang.etal2014]. Surface fires can often be safely and routinely actioned by suppression crews and equipment [@Wheatley.etal2022], and managers need to be able to estimate the speed and intensity of fires even when crown fire activity is unlikely.

### Surface fire spread in the Canadian Fire Behavior Prediction System

Surface fire spread models have not been the primary focus of past Canadian fire behaviour modelling efforts, though they have made appearances. The present Fire Behavior Prediction System (FBPS) features fuel-type specific models encompassing the full range of surface through crown fire behaviour for a small number of conifer fuel complexes [@ForestryCanadaFireDangerGroup1992; @Tymstra.etal2010]. Thus, the majority of conifer ROS models do not discriminate between surface and crown fire behaviour but rather assume a gradual transition between fire types; a deliberate decision discussed by Van Wagner [-@VanWagner1989]. However, more recent and flexible conifer modelling schemes exist that are specific in terms of the type of fire predicted under given weather and moisture inputs; these include CFIS (Crown Fire Initiation and Spread), Conifer Pyrometrics, and the forthcoming 'next generation' Fire Behavior Prediction System [@Alexander2006; @perrakis2020; @cfsfiredangergroup2021]. These models beg the question of what to expect (ROS, fire intensity, etc.) if crown fire behaviour is not predicted to occur. Pure surface fire models do exist in the FBPS for fuel complexes that do not exhibit crown fire behaviour: deciduous forests, open (treeless; i.e. grassland) communities, and scattered logging slash, in the form of the D-1, O-1 and slash (S-1 through S-3) fuel types, respectively [@ForestryCanadaFireDangerGroup1992]. As with the conifer fuel types, spread rate equations for surface fire are based on the Chapman-Richards function [@VanWagner1989]:

$ROS=a(1-e^{-b\cdot ISI})^c$ [1],

with the a, b, and c parameters assigned or fitted for each fuel type. Newer models have also been developed for grass [@Wotton2009; @Kidnie.Wotton2015] and atlantic shrublands [@Pepin.Wotton2020]. A few models were previously published for predicting surface fire spread in conifer stands based on sparse observations at individual research sites [e.g., @Lawson1972], but these data were eventually incorporated into the broader-scope FBP fuel type functions.

As the FBP System was being developed, a more flexible theoretical dual equilibrium conifer crown fire model concept was also proposed by CE Van Wagner. This involved a function for the expected rate of spread of crown fires, RSC, as well as a separate function, RSS, representing "all possible surface fires"[@VanWagner1989], with a crown fire initiation model representing the transition point between the two functions [@vanwagner1977a]. Suggested parameters for the RSS function appeared in the FBPS report in the form of the C-6S model, for the surface fire portion of the 'Conifer Plantation' fuel type: *a*=30, *b*=0.080, *c*=3; no explanation was provided as to their origin [@ForestryCanadaFireDangerGroup1992]. Two additional sets of RSS parameters were published shortly thereafter, associated with surface fire spread in immature and mature jack pine stands in Ontario [@VanWagner1993]. The immature stand was the source of many observations from the C-4 fuel type [@Stocks1987] and we presently refer to this RSS equation as C-4S, with the following parameters: *a*=20, *b*=0.20, *c*=5. The mature pine stand RSS model is associated with several C-3 fuel type observations [@Stocks1989] and will be named C-3S: *a*=15, *b*=0.05, *c*=2. Again, no source was given for the origin of these parameters. Given the theoretical basis of these models, we presently assume they were derived by visual inspection using the limited underlying data. Figure 1 compares these notional conifer surface fire ROS models along with the D-1 model for comparison (*a*=30, *b*=0.0232, *c*=1.6).

### [Fig1]

```{r label=Fig1, message=FALSE}

fig1 <- ggplot(data=s.fires, aes(x=ISI, y=ROS)) +
  stat_function(fun=c6s, colour='darkred') +
  stat_function(fun=sf.vw93i, colour='turquoise') +
  stat_function(fun=sf.vw93m, colour='purple') +
  stat_function(fun=sf.d1, colour='green') +
  geom_text(x=10, y=sf.vw93i(10)+3, label='C-4S') +
  geom_text(x=15, y=c6s(15)-2, label='C-6S') +
  geom_text(x=26, y=sf.d1(26)+1, label='D-1') +
  geom_text(x=24, y=sf.vw93m(24)-1, label='C-3S') +
  theme_classic() 
  

fig1

```

### Experimental burning database

The source data for much of the FBPS, including the observations described above, is a growing database of field-scale experimental burns conducted at various sites across Canada since the 1960s. These data have been previously described and analyzed [e.g., @Alexander.Quintilio1990; @cruz1999; @perrakis2023], but never before for the purpose of examining generalized surface fire models. The present database contains over 120 conifer observations of experimental fire behaviour in stands of various sizes, but primarily 0.1-1.0 ha (median size: 0.4 ha). In addition to the boreal conifer data, 32 experimental fire observations were available in deciduous stands, based on original studies described by Van Wagner [-@VanWagner1973a; aspen stands], Alexander and Sando [@Alexander.Sando1989], and Quintilio et al. [-@quintilio1991]. A small number of experimental plots burned in open Ponderosa pine â€“ Douglas-fir stands have also been added due to their unique importance in British Columbia [@Nyberg1979; @Smaill1980], although these involve some further discussion and analysis.

The objective of this study was to use the database of experimental fires to produce simple and rapid models for estimating the ROS of surface fires burning in generalized pine or spruce conifer stands. Since fires spreading under higher danger conditions in conifer stands tend to be crown fires [@vanwagner1977a; @Beverly.etal2020; @Cruz.etal2022], the majority of surface fires involve occurred during moderate-level fire danger indices and wind speeds, or under high danger conditions in stands with high crown base height (\> 6 m) in a few cases. Such models can be used to inform dynamic fire behaviour predictions sytems, where surface fire, crown fire initiation, and crown fire spread are modelled as separate but related processes [@Scott.Reinhardt2001 ; @perrakis2020a; @CFSFireDangerGroup2021]. In contrast with previous studies,

## 2. Methods

#### Fire database

The Canadian experimental fire database was the primary source of surface fire observations. As previously described, varying sizes of square or rectangular plots were ignited from an exposed windward edge using line ignition techniques.

We used the surface fire data to fit empirical rate of spread (ROS) models based on the fire environment variables. Consistent with the established theoretical understanding of surface fire spread [@Curry.Fons1940; @Campbell-Lochrie.etal2021] and the majority of existing empirical models [@fernandes2009; @Sullivan2009a], we focused on wind speed and fuel moisture content as primary variables of interest. Our starting point for operational models was the Initial Spread Index (ISI) [@vanwagner1987a] that combines these two factors according to the Fire Weather Index (FWI) and FBP System conventions [@fcfdg1992; @cfsfiredangergroup2021]. Variables including fuel type and surface fuel consumption were also examined.

### ISI and ISI~SA~

As noted previously, the main independent variable used to predict ROS in the FBP System is the initial spread index (ISI), as originally described by Van Wagner [@vanWagner1987a; @ForestryCanadaFireDangerGroup1992]. The ISI represents a combination of empirical functions representing wind speed and fuel moisture influences, scaled for user convenience; as described, the ISI was designed both as an intermediate step in the calculation of the fire weather index (FWI) [@vanwagner1987a] as well as a key predictor of initial ROS in all fuel types [RSI; @ForestryCanadaFireDangerGroup1992].

For modelling surface ROS, we sought to maintain the single variable utility of the ISI while also exploring a more recent and flexible fuel moisture estimate. We utilized the stand-adjusted moisture content (mc~SA~) model of Wotton and Beverly [-@Wotton.Beverly2007] that combines the effects of the FFMC and DMC indices along with stand type, density, and season for predicting the moisture content of dead litter, based on several thousand measurements at several sites across Canada. In order to leverage the additional flexibility of the mc~SA~, we calculated an alternative spread index based on the ISI equation, the stand-adjusted ISI (ISI~SA~). The ISI~SA~ involved the same ISI formulation as originally described by Van Wagner [-@vanwagner1987], but substituting the mc~SA~ value in place of the mc~FFMC~ for representing estimated litter moisture content. The full equation is provided for clarity and completeness:

$$ ISI_{SA}=0.208\cdot [e^{0.05039\cdot WS_{10}}] \cdot (91.9 \cdot e^{-0.1386\cdot mc}) \cdot \left[ 1+\frac{mc^{5.31}}{(4.93\cdot 10^7)}) \right]  $$ , [5], with *WS~10~* representing the 10 metre open wind speed and *mc* representing mc~SA~ in this case. Both the ISI and the ISI~SA~ were tested in a variety of surface ROS model forms, discussed below.

## 4. Results

#### Dataset description and input ranges

Our database of `r nrow(fd.all)` observations resulted in `r nrow(filter(fd.all, CFI1==1))` crown fires and 92 surface fires. Among `r nrow(fd.all)-nrow(d1)` fires in conifer fuel types, a clear relationship is evident between fire type and rate of spread predicted by wind speed (Fig. 2).

### [Fig 2 simple ROS graph by fire type]

```{r label=Fig2}
#Call all 'midstory passive crown fires' surface fires if
#CFC is less than 0.1
fd.ros0 <- mutate(fd4,
                 FiT2=case_when(
                   Fire.type=='PCM' & CFC < 0.1 ~ 'S',
                   Fire.type=='PCM' & CFC >= 0.1 ~ 'PC',
                   TRUE ~ Fire.type)) %>%
  select(num, fire, ws, ROS, ISI, SFC, FiT2)
  
fd.ros1 <- bind_rows(
  fd.ros0, s.miss %>% select(num, fire, ws, 
                        ROS, ISI, SFC, FiT2=Fire.type))

fd.ros <- fd.ros1 %>%
  filter(!num %in% c(68, 69, 76, 125))

ggplot(fd.ros, aes(x=ws, y=ROS, colour=FiT2))+
  geom_point(alpha=0.7)+
  xlim(0, 35)+
  scale_colour_manual(values=c('red', 'orange', 'green')) +
  geom_smooth(method='lm', se=TRUE, level=0.95) +
  theme_classic()

#simple linear sROS model from graph:
sf.lin <- lm(ROS ~ ws, data=fd.ros %>% filter(FiT2=='S'))

```

Surface fire ROS in conifer stands ranged from `r min(fd.ros$ROS)` â€“ `r max(fd.ros %>% filter(FiT2=='S') %>% pull(ROS))` m min^-1^, with most fires' sROS values well below the maximum (95th percentile sROS of `r quantile(filter(fd.ros, FiT2=='S')$ROS , 0.95)` m min^-1^.). The linear trend shown in Fig 2 (green line) represents a very simple, albeit weak, baseline linear surface ROS model:

$$ROS=0.4911 + 0.1263 \cdot WS_{10}$$

with *P*\<0.01 and adjusted *R^2^* =0.122.

If we focus on surface fire observations, Figure 3 represents surface fires classified by fuel type and surface fuel consumption level. Despite identifying these fires as surface fires in primary sources, a few observations appeared anomalous; a closer examination identified several fires with significant estimated levels of canopy fuel consumption (CFC). Fires with estimated CFC \> 0.1 (mean CFC: 0.35 kg m\^2) were then removed from the surface model-fitting, as these fires with canopy fuel involvement were considered transitional to passive crown fire. Other questionable inclusions included fires in open Ponderosa pine / Douglas-fir stands, with partly cured understory grass [@nyberg1979; see Box 1] as well as fires observations in deciduous stands.

### [Fig3]

```{r label=Fig3}
#Show data, exceptions (CFC >0.1), PPDF orig. 
Fig3 <- ggplot(s.fires3 %>% 
                 filter(!is.na(SFC)), #s.fires3
       aes(x=ISI, y=ROS)) +  
  geom_point(aes(colour=FT, size=SFC), alpha=0.6) +    
  geom_point(data=except, aes(colour=FT, size=SFC), shape=22) +
  geom_point(data=wildfires, colour='black', size=1, 
             shape=1) +
#  geom_point(data=ppdf, aes(size=SFC), shape=21) +
  stat_smooth(data=s.fires.con, method=lm, formula=y~I(x^2)-1, #same as sros.isi2.mod
              se=FALSE, colour='black') +    
  stat_smooth(data=s.fires.con, method=lm, 
              formula=y~x-1, se=FALSE, colour='gray') +
  theme_classic()

Fig3

###Finish adding, identifying wildfires in Fig3
```

After testing various models of wind speed, ISI, and ISI~SA~ , the following models were produced [table: ]

$$ROS=0.02249 \cdot ISI_{SA} ^2$$ [6], ##fix

with adjusted r^2^ =0.689 ##fix.

Figure 4.

```{r label=Fig4}
fig4
```

Figure 5 shows the surface ROS observations plotted against wind speed, along with the Equation 5 sROS model at three estimated moisture content levels. Calculation of Cook's Distance (D~c~) identified one observation as particularly influential in the regression - the fastest sROS observation in the dataset, with D~c~= 0.530. This observation represented the initial surface fire under jack pine in the Gwatkin Lake wildfire ('GL-A'). Although it appears unduly influential, deleting this observation and refitting Equation 6 produced a model (Equation 6') with an only marginally altered slope coefficient (0.02097). Comparing the two models, Equation 6 predicts ROS for the GL-A observation (ws = 23.0, mc~SA~=7.22) of 11.3 m min^-1^, an underprediction of 5.8 % compared to observed ROS (12.0 m min^-1^); in contrast, Equation 6' predicts ROS of 10.5 m min^-1^, 0.8 m min^-1^ lower than the Equation 6 result.

#### Surface rate of spread

In contrast to CFI models, the mc~SA~-based sROS model (using an ISI function based on mc~SA~) was not superior to the simple ISI-based model. This suggests that the mc~SA~ performance with the parameters we inferred and assigned was not universally superior to the simpler FFMC in capturing additional variation in our fire data. For its sensitivity to additional fire environment variables (density, DMC, species), the mc~SA~ based model may still have some advantages. Neither overstory genus (pine vs spruce) nor stand density were significant predictors of ROS on their own; however, the sROS model using ISI~SA~ incorporates the effects of stand density and DMC on mc~SA~, thereby providing some degree of influence of stand density on sROS via effects on estimated litter moisture. This is in line with findings from physical modelling studies that suggest, for instance, that thinning treatments can increase surface ROS via higher effective in-stand wind speed in more open stands [e.g., @parsons2018; @marshall2020].

The major limitation of the sROS models and dataset are the paucity of observations at higher danger conditions (ws or ISI) and the aforementioned influence of the GL-A data point. The reconstruction of the Gwatkin Lake wildfire [@vanwagner1965; @hummel1979 ] suggested about 300 m of spread under a tall jack pine stand, scorching the pine crowns 12 m above while torching 'a few trees here and there' [@vanwagner1965], but generally qualifying as a surface fire spreading under 23 km h^-1^ winds. While we assumed that those inputs were reconstructed as accurately as possible, additional surface fire observations under high indices, necessarily with high LCBH and-or low SFC to avoid crowning, will help greatly to improve the accuracy and confidence in the surface ROS model. Some of the variability in the data is undoubtedly due to the varying canopy influence (including edge effects) on in-stand wind speed and turbulence, as previously discussed. These factors, potentially exacerbated by varying plot sizes, are not accounted in our models. The present sROS models appear crude, but will likely provide a useful first approximation decision support tool for fire managers based on real-world fire data. Surface ROS errors of 1-3 m min^-1^ or more should be expected in real-world use.

## 

## 5. Discussion

Although the most relevant value related to wind velocity might be the mid-flame wind speed (as per [@rothermel1972]), the 10-m open wind speed is commonly measured at fire weather stations across Canada and internationally [@Lawson.Armitage2008], and avoids the major challenge of in-stand wind speed modelling. We tested other associated forest structure variables, including canopy closure class, FSG, and ignition line exposure, in order to account for wind reduction between 10-m open conditions and flame-level (\~1 m) sub-canopy conditions.

While physical fire spread models attempt to represent heat transfer and combustion processes, empirical and

One question is possibly most important for operational use: are these models credible, and would they be reasonably effective (+/- 50 %) for predicting fire spread within and outside the data range? We have already established that extreme conditions (e.g., ISI \> 20) are associated with crown fire behaviour in most stands, demanding a different set of models. Extreme conditions in conifer forests where surface fire behaviour is expected (and appropriate models were needed) might be associated with very high canopy structure (e.g., LCBH \> 10 m), such as in a mature pine or Douglas-fir stand, possibly together with fuel treatment work to remove smaller trees and other ladder fuels (e.g. Fig. x [pic. from Sooke - moderate stand, LCBH of 13-15 m]). Alternatively, high danger conditions (not extreme), including ISI values of \~10-15 would be a more common concern for sROS models.
