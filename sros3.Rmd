---
title: "Simple spread models for conifer surface fires"
author: "D.D.B. Perrakis and S.W. Taylor"
output:
  word_document: 
    fig_width: 6.3
    fig_height: 6.3
  pdf_document: default
bibliography: 'C:/Dan/Zotero/My library.bib'
csl: "multidisciplinary-digital-publishing-institute.csl"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,root.dir = 'c:/Dan/_Remote_projects/ccp-sROS')

#setwd("c:/Dan/_Remote_projects/ccp-sROS/files")

#.libPaths("C:/Dan/RPackages")

library(tidyverse)
library(broom)

#Get data frame, ready to query 
#Import data frame
fd <- read.csv('./files/fire_data_June2024.csv')  # with corrected SFC from McRae, Sharp p#16 to sharp.th, PNFI R5 MC.SA, Dewdrop SFC corrected

#FWI and moisture functions 
load(file='./files/wbmc5.rda')
load(file='./files/mcF.rda')
load(file='./files/ISI.rda')
load(file='./files/gr-cf.rda')

#set variables for modelling
fd4 <- mutate(fd, 
              CFI=CFI1, #lower CFI only for multi-story stands
              FSG=FSG1)  #same for FSG

#Deciduous data
d1.fires <- read.csv('./files/fire_data_d1_apr2024.csv')

#Combine conifer data with D1
fd.all <- bind_rows(fd4 %>% select(
  num:RH, Grass.Cure, Plot.Wd) %>%
    mutate(Date=ymd(Date)), 
  d1.fires %>% select(num:RH, Grass.Cure, Plot.Wd) %>%
    mutate(Date=ymd(Date)))  

```

## Abstract

Surface fire behaviour is the most frequent type of wildfire activity that occurs in conifer forests. Surface rate of spread (ROS) models can provide guidance under conditions less conducive to crown fire: wildfires spreading in moist or low wind conditions or in forest stands with a high crown base. We used a database of primarily experimental surface fires in conifer stands to fit simple empirical models of fire ROS under light-to-dense canopy that can be readily integrated within operational decision support systems. Final models are based on the Canadian Initial Spread Index (ISI) or stand-adjusted ISI (ISI~sa~), with options for including other predictors such as estimated surface fuel consumption (SFC) or fuel type. The simplest model finds surface ROS equal to 1.5 % of open 10 m wind speed. While imprecise, these models are usually accurate enough (within +/- 2â€“4 m min^-1^) for many forecasting purposes, including designing fuel treatments.

### [Process - get SF data]

```{r label=site.indexes, echo=FALSE, message=FALSE}

#Index numbers for different sites
porters <- filter(fd4, str_detect(fire, "PORTER")) %>% pull(num)
sc <- filter(fd4, str_detect(fire, "PNFI SC")) %>% pull(num) #south corner fire is low dens.
pg.low <- filter(fd4, str_detect(fire, "PRINCE")) %>%
  filter(str_detect(fire, "# 4")) %>% pull(num)   #select shorter stands at PG site only
pg.high <- filter(fd4, str_detect(fire, "PRINCE")) %>% 
  filter(str_detect(fire, "# 1")) %>% pull(num)
kenshoe <- filter(fd4, str_detect(fire, "KENSHOE")) %>% pull(num)
sharp <- filter(fd4, str_detect(ExpProject, "Sharpsand IM")) %>% pull(num)  #original Sharpsand Immature stands only
sharp.th <- filter(fd4, str_detect(ExpProject, "Sharpsand TH")) %>% pull(num)
sharp.sm <- filter(fd4, str_detect(ExpProject, "Sharpsand SM")) %>% pull(num)
rp <- filter(fd4, str_detect(fire, "PNFI RP")) %>% pull(num)
darwin <- filter(fd4, str_detect(fire, "DARWIN")) %>% pull(num)  #1, 2, 6, 7 are  low density plots
darwin.low <- c(66, 67, 90, 91)
bigfish <- filter(fd4, str_detect(fire, "BIG FISH")) %>% pull(num)
icfme <- 77:87 #order is A, 1, 2, 3, 4, 5, 6, 7, 8a, 8b, 9; fixed in icfme process
icfme.hd <- c(77:79, 82:87)  #all but p3, p4
#archer <- 109:117
pelican <- 109:110  #Changed for Mar2023; was 123-124
#fpft <- c(119:122, 125:126)
dewdrop <- filter(fd4, str_detect(ExpProject, 'Dewdrop')) %>% pull(num)

#function to calculate isi.m
isi.mcsa <- function(mcsa, ws) {
  m=mcsa
  f_w= exp(0.05039*ws)
  f_f= (91.9*exp(-0.1386*m))*(1+(m^5.31)/(4.93*10^7))
  return(0.208*f_w*f_f)
}

#surface fires - extract all CFI1==0, calculate isi.m
s.fires <- mutate(rowwise(fd.all), 
                  isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>% #get ISI using MC.SA
  filter(CFI1==0) %>% 
  select(-CFI2) %>%
  mutate(FT=as.factor(case_when(
           str_detect(ExpProject, 'D1') ~ 'Decid',
           str_detect(ExpProject, 'Dewdrop') ~ 'PPDF',
           TRUE ~ 'Con'))
         ) %>%
  ungroup() %>% as.data.frame()
 
#Add FBP database missing VW fires: 2 C4, 2 C5
s.miss0 <- data.frame(num=122:125, 
                      fire=c('PNFI #1 13 yr ONT',
                             'PNFI #2 12 yr ONT',
                             'PNFI RW #1-41-2', 
                             'Carp Lk PNFI WF QC'),
                     CFI1=0, Fire.type='S', 
                     ROS=c(7.6, 4.3, 3, 7.5),
                     SFC=c(1.6, 0.59, 0.3, 0.9), #only 0.59 was meaasured
      #Estimated SFC for 3/4 obs: C4 est: 1.64 (BUI 57); C5 est: 0.28 (BUI 25), 0.85 (BUI 45)
                     CFC=c(0, 1.0, 0, 0), 
                     Date=c('1977-05-19', '1976-08-04', 
                            '1976-05-10', '1963-07-03') %>% ymd(),
      ws=c(19, 10, 18, 25),
      FFMC=c(91.7, 89.9, 90.4, 90.7), 
      ISI=c(14.2, 7, 11.2, 16.7), 
      DMC=c(57, 26, 20, 45), 
      DC=c(107, 276, 86, 81), 
      BUI=c(57, 42, 25, 45), 
      MC.SA_season=c(1, 2, 1, 2), 
      MC.SA_dens=2, 
      MC.SA_stand=4, 
      FT='Con', #all 4 considered pine stands (conifer type)
      ExpProject=c('PNFI (JP)', 'PNFI (JP)', 'PFNI (WRP)', 'PNFI (WRP)')) 

#with ISI.mcsa values for the first two C4 PNFI fires
s.miss <- mutate(rowwise(s.miss0), 
                 MC.SA=wbmc5(FFMC, DMC, MC.SA_stand, 
                             MC.SA_dens, MC.SA_season),
                 isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>%
  as.data.frame() 
  

s.fires2 <- bind_rows(s.fires, s.miss)
```

### [Proc. SF models and PPDF]

```{r label=sROS, echo=FALSE, message=FALSE, warning=FALSE}
#ROS models 

#original ccp (2019) sf formula
sros.st <- function(isi) {
  0.6308 + 0.056*isi + 0.0086*isi^2
}

#Original unaltered conifer SF only - excludes D1, PPDF fires
s.fires.con <- filter(s.fires2, FT=='Con') 

#conifer-only isi.mcsa^2 ROS model
con.lm.mod <- lm(data=s.fires.con, formula=ROS~I(isi.m^2)-1)

#conifer-only ISI^2 model
con.ISI.mod <- lm(data=s.fires.con, formula=ROS~I(ISI^2)-1)
#use for testing fuel type significance


#prediction function for simple lm using isi.m
sf.con.fun <- function(isim) {
  predict(con.lm.mod, newdata=list(isi.m=isim))
}

#Noted - fires with some torching seem to be anomalous
#Exceptions: fires with torching, CFC >1
except <- filter(s.fires, CFC > 0.2 | num==48) %>%
  mutate(FT='Torch')  #using this in fuel type variable for graphs

wildfires <- filter(s.fires2, num %in% c(68, 69, 76,
                                        125, 232)) %>%
  mutate(FT='WF')
#filter out fires with CFC; somewhat anomalous
#first convert all NA CFC values to 0
s.fires3 <- s.fires2 %>% 
  mutate(
    CFC=ifelse(num==48, 0.2, CFC),   #assume R3 torching
    CFC=ifelse(is.na(CFC), 0, CFC)) %>%
            filter(CFC <= 0.2)

#Curing and C7 fires
ppdf <- filter(s.fires3, num %in% dewdrop & !is.na(Grass.Cure))

c7.fullcuring <- 95  #
fc.cf <- gr.cf(c7.fullcuring)

#grass curing function
#0.5 actual ROS plus 0.5 of 'full curing' ROS if it was all grass
#mean(0.67, 0.47, 0.83)
#set SFC p8 to mean above

s.fires.mod0 <- s.fires3 

#fire 8 gets mean SFC from fires close to same time of yr, BUI
s.fires.mod0$SFC[which(str_detect(s.fires.mod0$fire, 'JOHNSON EXP FIRE 8'))] <- 
  sum(0.67, 0.47, 0.83)/3

#Fire 9, Sept. 17
s.fires.mod0$Grass.Cure[
   which(str_detect(s.fires.mod0$fire, 'JOHNSON EXP FIRE 9'))] <- 
   80 #was 85

s.fires.mod <- s.fires.mod0 %>%
  mutate(CF=gr.cf(curing=Grass.Cure),  #calculate curing factor
         ROS=ifelse(is.na(Grass.Cure), ROS,  #obs with no %C are unchanged
            ROS/2+ROS*fc.cf*(1/CF)/2))   
#ROS is half from original, half increased using inverse of curing factor

#So far these models involve - 
# - Cutting out data with CFC > 1
# - 'Detrending' PIPO fires to simulate high grass curing, half
# - including substantial percentage of D1 fires

#linear model using ISI^2
sros.ISI2.mod <- lm(ROS ~ I(ISI^2)-1, data=s.fires.mod)
#r^2=0.7217 with s.fires3
#r^2=0.692 with s.fires.mod

#wind speed squared only
sros.ws2.mod <- lm(ROS ~ I(ws^2)-1, data=s.fires.mod)

#lm using isi.m^2
sros.isim2.mod <- lm(ROS ~ I(isi.m^2)-1, data=s.fires.mod)
#r^2=0.708 with s.fires2
#r^2=0.7605 with s.fires.mod

#lm using isi.m AND SFC - best simple model overall
sros.isim2SFC.mod <- lm(ROS ~ I(isi.m^2) + sqrt(SFC)-1, 
                        data=s.fires.mod)
#r^2=0.75 with s.fires2
#r^2=0.8025 with s.fires.mod
#r^2=0.617 with s.fires.con


#similar model with ISI (sros.ISI2SFC.mod) is also good, but not as good
sros.ISI2SFC.mod <- lm(ROS ~ I(ISI^2) + sqrt(SFC) - 1, 
                       data=s.fires.mod)
#r^2=0.7501

#prediction functions
sf.lin.fun <- function(ws) {
  predict(sros.lin.mod, newdata=list(ws=ws))
}

#nls model and prediction function: ax^b format
sf.axb.isi.mod <- nls(data=s.fires.mod, formula= 
               ROS ~ a * ISI^b, start=list(a=1, b=2))

sf.axbisi.fun <- function(isi) {
  predict(sf.axb.isi.mod, newdata=list(ISI=isi))
}


#fake data for lines - isim2SFC / IsaSFC model; fros1 is at SFC=1.34, fros2 is at SFC=2
#also ISI2SFC model and 
f.sfires0 <- data.frame(fisim=seq(0:30), fsfc1=1.34, fsfc2=2)
f.sfires <-mutate(rowwise(f.sfires0),
              fros1=predict(sros.isim2SFC.mod, 
              newdata=list(isi.m=fisim, SFC=fsfc1)),
              fros2=predict(sros.isim2SFC.mod, 
              newdata=list(isi.m=fisim, SFC=fsfc2)))

#FBP/Van Wagner models:
c6s <- function(isi) {
  ros=30 * (1-exp(-0.08*isi))^3
  return(ros)
}

#vw 1993 surface model for c4 immature pine stands; changed to c4s
#sf.vw93i
c4s <- function(isi) {
 20*(1-exp(-0.2*isi))^5 
}

#vw 1993 surface model for c3 mature pine stands
#sf.vw93m
c3s <- function(isi) {
 15*(1-exp(-0.05*isi))^2 
}

#D1
#sf.d1 
d1 <- function(isi) {
  30*(1-exp(-0.0232*isi))^1.6 
}

#c3 if needed
c3 <- function(isi) {
  110*(1-exp(-0.0444*isi))^3
}


#fit Chapman-Richards function to surface fire data
#This will be prediction model going forward
a.value <- 25 

sf.crisim.mod <- nls(data=s.fires.mod, formula= 
               ROS ~ a.value * (1-exp(-b*isi.m))^c, 
               start=list(b=0.08, c=3))


#just need to make a function from the model
sf.crisim.fun <- function(isim) {
  predict(sf.crisim.mod, newdata=list(isi.m=isim))
}
  
#Using ISI
sf.crisi.mod <-nls(data=s.fires.mod, formula= 
               ROS ~ a.value * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

#CR nls function using ISI
sf.crisi.fun <- function(isi) {
  predict(sf.crisi.mod, newdata=list(ISI=isi)) %>% unname()
}

#Conifer obs only!
###################
#recall con.lm.mod and con.ISI.mod
s.con <- s.fires.mod %>% filter(FT=='Con') #same as s.fires.con

sf.crisiCon.mod <-nls(data=s.con, 
                formula= 
               ROS ~ a.value * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

sf.crisiCon.fun <- function(isi) {
  predict(sf.crisiCon.mod, newdata=list(ISI=isi)) %>% unname()
}

#isi.m
sf.crisimCon.mod <-nls(data=s.con, 
                formula= 
               ROS ~ a.value * (1-exp(-b*isi.m))^c, 
               start=list(b=0.1, c=3))

sf.crisimCon.fun <- function(isim) {
  predict(sf.crisimCon.mod, newdata=list(isi.m=isim)) %>% unname()
}

#test for pine/spruce/other difference
s.con2 <- mutate(s.con, 
                 FT2=str_extract(ExpProject, "\\([^()]*\\)"), #all inside ()
                 FTsp=str_detect(FT2, 'S') %>% as.factor(),
                 FT3=case_when(
                   str_detect(FT2, '/') ~ 's',  #mix of pine /spruce
                   str_detect(FT2, 'S') ~ 's',  #spruce only
                   str_detect(FT2, '(JP)') ~ 'jp',         #jack pine only
                   TRUE ~ 'op') %>% as.factor())  #other pines
                 
#test for sig. of Fuel type factors
con.ft2 <- lm(ROS ~ I(ISI^2) + FTsp -1, data=s.con2) #NS
con.ft3 <- lm(ROS ~ I(ISI^2) + FT3 -1, data=s.con2) 
#FT3 is actually significant, with 'other pine sp' sig. lower ROS than jp
#testing contrast:
#emmeans_output <- emmeans(con.ft3, ~FT3)
#cld(emmeans_output, alpha=0.05, Letters=letters)
#shows op <> jp (op=s and s=jp though)

#summary(update(sros.ISI2SFC.mod, ~ I(ISI^2) + sqrt(SFC) + FT3 - 1, data=s.con2))
#SFC models are NS when applied to conifer-only dataset; Fuel type then also 
#becomes NS (P > 0.05)


#Add function for ISI2SFC and ISI.mSFC models
sf.isi2sfc.fun <- function(isi, sfc) {
  predict(sros.ISI2SFC.mod, newdata=list(ISI=isi, SFC=sfc)) %>% 
    unname()
}

sf.isim2sfc.fun <- function(isim, sfc) {
  predict(sros.isim2SFC.mod, newdata=list(isi.m=isim, 
                                          SFC=sfc)) %>%
    unname()
}

#SFC=0.75
sf.isim2sfc075.fun <- function(isim) {
  sfc_vals=rep(0.75, length(isim))  #required for stat_function
  predict(sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=1.5
sf.isim2sfc15.fun <- function(isim) {
  sfc_vals=rep(1.5, length(isim))  #required for stat_function
  predict(sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=3
sf.isim2sfc3.fun <- function(isim) {
  sfc_vals=rep(3.0, length(isim))  #required for stat_function
  predict(sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=1.5 with ISI function
sf.isi2sfc15.fun <- function(isi) {
  sfc_vals=rep(1.5, length(isi))  #required for stat_function
  predict(sros.ISI2SFC.mod, 
          newdata=list(ISI=isi, SFC=sfc_vals))
}

#FT model 15 below


#Fernandes sf (Fernandes et al. 2009) model for 
#maritime pine stands based on ws, litter mc, fuel depth
#not clear what height for ws measurements...
sf.fernandes <- function(ws, mc, fd) {
  ROS=0.773*ws^0.707*exp(-0.039*mc)*fd^0.188
  return(ROS)
}

#Add ISI-FT and isim-FT models
# sf.nope <- nls(data=s.fires.mod %>% filter(FT=='Con'), 
#                ROS ~ 0.5*ws^a*exp(-b*MC.SA)^c, 
#                start=list(a=0.7, b=0.1, c=3))  #gives error

#All this stuff to try to do a Tukey test but it's almost all NS anyway
#only sig. difference is between PPDF and other 2 FTs (but screwy because of 
#the 'normalizing' to 95% curing)
s.fires.mod2 <- mutate(s.fires.mod, FT=as.factor(FT))

sf.ft <- lm(ROS ~ I(isi.m^2) + SFC + FT -1, 
              data=s.fires.mod2) #SFC NS
sf.ftim <- lm(ROS ~ I(isi.m^2) + FT-1, 
              data=s.fires.mod2) #SFC NS

sf.ftisi <- lm(ROS ~ ISI * FT -1, 
              data=s.fires.mod2) #linear w/ interaction

sf.ftisi2 <- lm(ROS ~ I(ISI^2) + FT -1, 
              data=s.fires.mod2) #squared, no interaction

sf.ftisi3 <- lm(ROS ~ I(ISI^2) * FT -1, 
              data=s.fires.mod2) #ISI squared, with interaction

#Multiple comparisons - Tukey test
#try 'emmeans' package
# require(emmeans)
# ##require(multcomp) #note - this screws up dplyr::select !!
# 
# emmeans_output <- emmeans(sf.ftisi, ~ FT)
# emmeans_output <- emmeans(sf.ftisi2, ~ FT)

# multcomp::cld(emmeans_output, alpha = 0.05, Letters = letters)
# or
# contrast(emmeans_output, method = "revpairwise", adjust = "tukey")

#FT differences sig. (sf.ftisi only) 


#Consider adding one:
# sf.ftisi  
ft.isi.fun <- function(isi, ft='Con', mod=1) {
  ft_vals=rep(ft, times=length(isi))
  mod_vals=rep(mod, times=length(isi))
  return(case_when(mod==1 
                   ~ predict(sf.ftisi, newdata=list(
                     ISI=isi, FT=ft_vals)),
                   mod==2 
                   ~ predict(sf.ftisi2, newdata=list(
                     ISI=isi, FT=ft_vals)),
                   mod==3
                   ~ predict(sf.ftisi3, newdata=list(
                     ISI=isi, FT=ft_vals))))
  #FT levels: Con, PPDF, Decid
  #mod1: linear; mod2: squared, not inter; mod3: squared, with inter
}

# ft.isi2.fun <- function(isi, ft='Con') {
#   ft_vals=rep(ft, times=length(isi))
#   predict(sf.ftisi2, newdata=list(ISI=isi, FT=ft_vals))
#   #FT levels: Con, PPDF, Decid
# }

#save(sf.ftisi, file='C:/Dan/_Remote_projects/ccp-sROS/files/sf_ftisi.rda')
#save(ft.isi.fun, file='C:/Dan/_Remote_projects/ccp-sROS/files/ftisi_fun.rda')
#write.csv(s.fires.mod, file='C:/Dan/_Remote_projects/ccp-sROS/files/sfires_mod.csv')
#write.csv(s.fires3, file='C:/Dan/_Remote_projects/ccp-sROS/files/sfires3.csv')


```

### [Complex modelling attempts]

```{r fancy modeling attempts, echo=FALSE}

##Then try rpart models
rp.mods <-rpart::rpart(ROS ~ ., data=s.fires.mod %>% 
                  select(ROS, ws, FFMC, ISI, MC.SA, isi.m, SFC, FT),
                  method='anova')
#Hmmm. Tree models. Too complicated to make sense of

#leaps
#first make dataset with squared terms
s.fires.squared <- s.fires.mod %>%
  mutate(ws2=ws^2, 
         ISI2=ISI^2,
         isi.m2=isi.m^2,
         SFC2=SFC^2,
         SFC.sqrt=sqrt(SFC),
         ) %>%
  select(ROS, ws, ws2, FFMC, ISI, ISI2, MC.SA, isi.m, isi.m2, 
         SFC, SFC2, SFC.sqrt, FT, MC.SA_dens, DMC)

lp.mods <- leaps::regsubsets(ROS ~ ., 
                             data=s.fires.squared, #force.out='DMC', 
                             nbest=1, nvmax=4)

lp.mods2 <- leaps::regsubsets(ROS ~ ., 
                             data=s.fires.squared, #force.out='DMC', 
                             nbest=3, nvmax=4, intercept=FALSE)


best2 <- lm(ROS ~ I(isi.m^2)+MC.SA_dens -1, data=s.fires.squared)

#DMC factor was illogical, so excluded
#'exhaustive' search for all var combinations revealed models dominated by isi.m2; alone (1 var), with FFMC (2), with FFMC and ISI(3), or with FFMC, ISI, ws2 (4). Gains compared with isi.m2 model alone are very slight, suggesting overfitting. 

#All this effort to say that the best model includes isi.m probably alone as a squared term

#con dataset
s.fires.cosquared <- s.fires.con %>%
  mutate(ws2=ws^2, 
         ISI2=ISI^2,
         isi.m2=isi.m^2,
         SFC2=SFC^2,
         SFC.sqrt=sqrt(SFC),
         ) %>%
  select(ROS, ws, ws2, FFMC, ISI, ISI2, MC.SA, isi.m, isi.m2, 
         SFC, SFC2, SFC.sqrt, MC.SA_dens, DMC)

lp.mods.con <- leaps::regsubsets(ROS ~ ., 
                        data=s.fires.cosquared, force.out='DMC',
                             nbest=3, nvmax=4, intercept=FALSE)  #DMC was bogus
#DMC estimate again negative, so excluded
#test MC.SA_season factor?

best2c <- lm(ROS ~ ISI2 + ISI -1, data=s.fires.cosquared) #no good


```

### [graphs and functions]

```{r label=graphs, echo=FALSE}

fig4 <- ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=isi.m, y=ROS)) +  
  scale_colour_manual(values=c(
    'red2',
    'green3',
    'blue4')) +
  geom_point(aes(colour=FT, size=SFC), alpha=0.5) + #main fires, adj. PPDF
  geom_point(data=s.fires3 %>% filter(!is.na(SFC)) %>% 
               filter(FT=='PPDF'), 
             aes(size=SFC), shape=21, color='darkgray', 
             fill='darkgray', alpha=0.5) + #PPDF original
  geom_point(data=wildfires, colour='black', fill='black', size=1, 
             shape=21) +
#  geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray')+
  stat_function(fun=sf.isim2sfc15.fun, color='purple', 
                linetype='dashed') +
#  stat_function(fun=sf.isim2sfc3.fun, color='red') +
  stat_function(fun=sf.crisim.fun, color='purple') +
  stat_function(fun=sf.crisimCon.fun, colour='pink') +
  theme_classic()
#  stat_function(fun=sf.con.fun, colour='gray') +
  #geom_text(x=28, y=sf.isim2sfc075.fun(28)+3, 
  #          label='IsaSFC') +
  

#fig4

#Graph with vw functions, ISI
fig5 <- ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=ISI, y=ROS)) + 
    scale_colour_manual(values=c(
    'red2',
    'green3',
    'blue4')) +
  geom_point(aes(colour=FT, size=SFC), alpha=0.5) +    
  geom_point(data=s.fires3 %>% filter(FT=='PPDF'), aes(size=SFC), shape=21, size=4, fill='darkgray', alpha=0.5) + #PPDF original
  geom_point(data=wildfires, colour='black', fill='black', size=1, 
             shape=21) + #wildfires
  #geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray') + #IsaSFC model
#  stat_function(fun=sf.axbisi.fun, color='grey') +
  stat_function(fun=c4s, color='turquoise', linetype='dashed') +
  stat_function(fun=c3s, color='purple', linetype='dashed') +
  stat_function(fun=c6s, color='darkred', linetype='dashed') +
   # geom_text(x=21, y=c6s(21)-1, label='C6s') +
  theme_classic()

#fig5

```

## 1. Introduction

The rate of spread (ROS), or rate of forward advance, of a wildfire is probably its most important descriptive characteristic for fire managers [@vanwagner1965; @Sullivan.Gould2020]. Fire behaviour in the conifer forests of Canada is often a story about crown fire, featuring high spread rate and intensity, a rain of lofted embers and few suppression options [@alexanderCrownFireDynamics2016]. And yet in the chronology of fire events, most days between ignition and extinction feature only ground or surface fire behaviour [@Wang.etal2014]. Surface fires can often be safely and routinely actioned by suppression crews and equipment [@wheatley2022], and managers need to be able to estimate the speed and intensity of fires even when crown fire activity is unlikely.

### Surface fire spread in the Canadian Fire Behavior Prediction System

Surface fire spread models have not been the primary focus of past Canadian fire behaviour modelling efforts, though they have made appearances. The present Fire Behavior Prediction (FBP) System features fuel-type specific models encompassing the full range of surface through crown fire behaviour for a small number of distinct conifer fuel complexes [@forestrycanadafiredangergroup1992a; @tymstra2010]. Thus, the majority of conifer ROS models do not discriminate between surface and crown fire behaviour but rather assume a gradual transition between fire types â€“ a deliberate decision discussed during the system's development [@vanwagner1989a]. However, more flexible conifer modelling schemes are emerging that specify the type of fire predicted under given weather and moisture inputs. These include CFIS (Crown Fire Initiation and Spread), Conifer Pyrometrics, and the forthcoming 'next generation' Fire Behavior Prediction System [@Alexander.etal2006a; @perrakis2020a; @cfsfiredangergroup2021]. These systems beg the question of what fire behaviour to expect (ROS, fire intensity, etc.) when crown fire behaviour is not predicted to occur. Pure surface fire models do exist in the FBPS for fuel types lacking a flammable overstory: leafless deciduous forests (D-1), open vegetation (i.e. grassland; O-1), and scattered logging slash (S-1 through S-3) [@forestrycanadafiredangergroup1992a]. As with the conifer fuel types, surface ROS (sROS) equations are based on the sigmoidal Chapman-Richards function [@vanwagner1989a]:

$$ROS=a(1-e^{-b\cdot ISI})^c$$ [1],

with the *a* parameter representing the horizontal asymptote ('levelling off value'), b, and c parameters assigned or fitted from data [@forestrycanadafiredangergroup1992], and *ISI* representing the Initial Spread Index from the Fire Weather System [@vanwagner1987]. Newer surface fire models have also been developed for grass [@wotton2009d; @Kidnie.Wotton2015] and Atlantic shrublands [@Pepin.Wotton2020]. A few older sROS models were previously published based on individual field experiments [e.g., @Lawson1972], but these data were eventually incorporated into the broader-scope FBP fuel type functions.

### CE Van Wagner's surface fire models

As the FBP System was being developed, CE Van Wagner proposed a more flexible theoretical dual equilibrium conifer crown fire model concept. This involved two notional functions for a given conifer stand describing the expected ROS of crown fires, RSC, and "all possible surface fires", RSS [@vanwagner1989a], with a crown fire initiation model representing the transition point between the two [@vanwagner1977a]. The RSS function appeared in the FBPS report in the form of the C-6s model, for the surface fire portion of the 'Conifer Plantation' fuel type: *a*=30, *b*=0.080, *c*=3 [@forestrycanadafiredangergroup1992]. Two additional RSS models and parameters were suggested shortly thereafter, associated with surface fire spread in immature and mature jack pine stands in Ontario [@vanwagner1993a]. The immature stand was the source of many observations from the C-4 fuel type [@stocks1987b] ("C-4s"): *a*=20, *b*=0.20, *c*=5; while surface fire observations from mature pine stands [C-3; @stocks1989] were used to form another RSS model ("C-3s"): *a*=15, *b*=0.05, *c*=2 [@vanwagner1993a]. No statistics or other source were provided for the origin of these models (C-3s, C-4s, C-6s). Figure 1 compares these notional conifer surface fire ROS models along with the D-1 and C-3 models for comparison (calculated from [@forestrycanadafiredangergroup1992a]). These existing surface ROS models will be used as benchmarks to compare with new formulations.

### [Fig1]

```{r label=Fig1, message=FALSE, echo=FALSE}

fig1 <- ggplot(data=s.fires, aes(x=ISI, y=ROS)) +
  stat_function(fun=c6s, colour='darkred') +
  stat_function(fun=c4s, colour='turquoise') +
  stat_function(fun=c3s, colour='purple') +
  stat_function(fun=d1, colour='green') +
  stat_function(fun=c3, colour='gray') +
  geom_text(x=10, y=c4s(10)+3, label='C-4s') +
  geom_text(x=15, y=c6s(15)-2, label='C-6s') +
  geom_text(x=24, y=d1(24)+1, label='D-1') +
  geom_text(x=22, y=c3s(22)-1, label='C-3s') +
  geom_text(x=20, y=c3(20)+1.5, label='C-3') +
  coord_cartesian(x=c(2, 25), y=c(0, 35)) +
  theme_classic() +
  labs(y='ROS (m/min)')
  

fig1

```

*Caption: Figure 1. Comparison of surface fire rate of spread (ROS) models from the FBP System and associated research; the C-3 model (continuum of surface to crown fire ROS) is included for comparison purposes. The D-1 and C-6s models are a core part of the FBP System. C-4s and C-3s refer to surface fire models proposed by C.E. Van Wagner for immature and mature jack pine fires, respectively. ISI refers to the Initial Spread Index. See text for references.*

### Objectives

The objective of this study was to use the Canadian database of experimental fires to produce simple empirically-based models for estimating the ROS of surface fires burning beneath the canopy of conifer or boreal and sub-boreal forest stands. Such models can be incorporated into dynamic fire behaviour predictions systems, where surface fire, crown fire initiation, and crown fire spread are modelled as separate but related processes [@scott2001; @perrakis2020a; @cfsfiredangergroup2021].

It has long been known that wind speed near the affected fuel is one of the most important predictors of ROS [e.g., @VanWagner1968; @catchpole1998; @rothermel1972]. However, beneath a forest canopy, predicting wind speed at the microclimate level involves detailed studies of wind interactions with fuel structure, including edge effects [@moon2019; @schlegel2015], which is seldom available with any degree of certainty in operational situations. The present models therefore rely only on the standard 10 m open wind speed, as was measured in field experiments and is typically used for wildfire weather forecasts [@lawson2008]. This is appropriate for such tools as can be readily adapted to operational use, but means they are less accurate due to the significant influence of forest structure, including the effects of edges and openings on moisture and ground-level winds [@chen1999; @ma2010].

## 2. Methods

### Fire database

The source data for these analyses is a slowly growing database of field-scale experimental burns conducted at various sites across Canada since the 1960s. These data have previously been described and analyzed [e.g. @alexander1990; @cruz1999a; @perrakis2023], but never before for the purpose of developing generalized surface fire models. The present database contains over 120 conifer observations of experimental fire behaviour in stands of \~0.1-4.0 ha (median size: 0.4 ha). In addition to the boreal conifer data, 39 additional experimental fire observations were available and provide additional insight for general sub-canopy fires. These include fires in deciduous stands, originally described by Alexander and Sando [@alexander1989a], featuring 6 fires from northeastern US aspen stands; 14 fires in aspen near Hondo, Alberta [@quintilio1991]; and aspen (9), oak (2), and aspen-dominated mixedwood (1) fires at Petawawa, Ontario [@vanwagner1973]. Finally, seven experimental fires in Ponderosa pine- Douglas-fir (PPDF) stands in British Columbia were also included, analyzed uniquely to incorporate grass curing effects (see Appendix A).

Some models were fitted solely to the boreal conifer data, while the deciduous and PPDF data were included in other models in order to explore more generic tools for surface fire prediction across a range of forest fuel types. This generated a full database of `r nrow(fd.all)` observations, of which `r nrow(fd.all %>% filter(CFI1==0))` were surface fires, as described in primary sources, though with some nuances involving torching trees and crown fuel consumption are discussed below.

### Modelling and spread indices

Consistent with longstanding theoretical understanding of fire processes [@curry1940; @VanWagner1968; @Campbell-Lochrie.etal2021] and the majority of existing empirical models [@fernandes2009; @sullivan2009], we anticipated that wind speed and dead fuel moisture content would be primary variables of interest. In particular, the aforementioned unitless *ISI* that combines empirical functions representing wind speed and fuel moisture influences [@vanwagner1987] was already the main independent variable used for predicting ROS in the FBP System [@forestrycanadafiredangergroup1992]. Other variables we examined for significance included moisture indices from the FWI System (the Fine Fuel Moisture Code, FFMC, and Duff Moisture Code, DMC), and surface fuel consumption (SFC), which must be estimated or modelled separately for prediction purposes.

In addition to the basic ISI, we also explored a modification using a more flexible fuel moisture model, the stand-adjusted moisture content (*mc~sa~*) model of Wotton and Beverly [@wotton2007; @perrakis2023]. The *mc~sa~* combines the effects of the FFMC and DMC indices along with categorical stand type, density, and season variables for directly predicting the moisture content of dead litter. The *mc~sa~* was combined with wind speed using the identical formula as originally described for the ISI, but with the *mc~sa~* in place of *m*, the simple FFMC-based estimate for dead fuel moisture [@vanwagner1987]. The full *ISI~sa~* equation is provided here for completeness:

$$ ISI_{sa}=0.208\cdot (e^{0.05039\cdot WS_{10}}) \cdot (91.9 \cdot e^{-0.1386\cdot mc_{sa}}) \cdot \left[ 1+\frac{mc_{sa}^{~~~5.31}}{(4.93\cdot 10^7)}) \right]  $$ [2].

For model feature selection, we tested all combinations of predictors: *WS~10~*, *FFMC*, *mc~sa~*, *DMC*, *ISI*, *ISI~sa~*, *SFC*, fuel type, and stand density class ('light', 'moderate', and 'dense' classes, as defined by [@wotton2007]); this included transformed terms: *WS~10~*^2^, *ISI^2^*, *ISI~sa~^2^*, *SFC^2^*, and *sqrt(SFC)*. All variable combinations (1-4 predictors) were tested using the 'leaps' package in R [@lumley2024]. We also tested two types of non-linear responses. The first was the simple nonlinear $a \cdot ISI ^{b}$ form. The second used a modification of the sigmoidal Chapman-Richards form previously described (eq. 1). The horizontal asymptote, a, was replaced with a linear function, $y=m \cdot ISI+i$ [3], such that at high ISI values, ROS approaches the value of y:

$$
ROS=(m \cdot ISI + i) \cdot (1-e^{-b \cdot ISI})^c
$$

[3].

This is believed to be more realistic for representing subcanopy ROS under more extreme conditions compared with a fixed asymptote value as in the original Chapman-Richards function. All analyses were performed in RStudio 2024.04 (Posit Software, Boston, MA, USA) with R version 4.2.1.

### Grass curing in Ponderosa Pine fires

For the PPDF fires, we sought to incorporate the effects of understory grass curing effects, as herbaceous vegetation is an important part of the understory fuelbed in these forests [@ducherer2009; @ducherer2013]. Although an empirical model involving variable curing levels would require much more data, we estimated how fire spread in these stands under peak seasonal conditions based on certain assumptions from known grassland fire spread mechanisms. We first normalized all observations, following [@cheney1995], to a nearly fully cured grass condition (95 % C) in order to represent late summer conditions associated with high fire danger. Although the grass biomass in these stands only represented a fraction (\~3 %) of the total available surface fuel [@nyberg1979], grass curing is has been observed by operational practitioners to have a strong influence on ROS [@beck2003]. We assumed that understory grass and forb curing would be 50 % as influential compared to a true grassland, and calculated new 95% C estimated ROS (*ROS'*) values for these plots, as follows:

$$ ROS'=\frac {ROS_0}{2} \cdot \left[ {1 + \frac {cf(95)} {cf(C)}} \right]  $$

[6], where *ROS~0~* represents the observed rate of spread with measured curing *C* (see Appendix A), and *cf(C)* and *cf(95)* represent the calculated curing factors [@wotton2009] at measured % C values and 95% C, respectively. *ROS'* values for these seven PPDF fires were then used in fitting the 'aggregate' model analyses and fuel type-based models, but excluded from the boreal conifer models.

## 4. Results

### Initial data exploration and model building

Simple inspection of our fire database [@perrakis2023] revealed certain obvious patterns. Among `r nrow(fd.all)-nrow(d1)` fires in conifer fuel types (surface and crown), a clear, though noisy relationship is evident between fire type and rate of spread predicted by wind speed (Fig. 2).

### [Fig 2 simple ROS graph by fire type and eval for m25 and FBP mods]

```{r label=Fig2, message=FALSE, echo=FALSE}
#Call all 'midstory passive crown fires' surface fires if
#CFC is less than 0.1
fd.ros0 <- mutate(fd4,
                 FiT2=case_when(
                   Fire.type=='PCM' & CFC < 0.1 ~ 'S',
                   Fire.type=='PCM' & CFC >= 0.1 ~ 'PC',
                   TRUE ~ Fire.type)) %>%
  select(num, fire, ws, ROS, ISI, SFC, FiT2)
  
fd.ros1 <- bind_rows(
  fd.ros0, s.miss %>% select(num, fire, ws, 
                        ROS, ISI, SFC, FiT2=Fire.type))

#remove wildfires - don't do this
fd.ros <- fd.ros1 
#%>%
#  filter(!num %in% c(68, 69, 76, 125))

#25% rule?
m25 <- function(x) {0.25*x}

fig2 <-ggplot(fd.ros, aes(x=ws, y=ROS, colour=FiT2))+
  geom_point(alpha=0.7)+
  xlim(0, 35)+
  stat_function(fun= m25, colour='black') +
  scale_colour_manual(values=c('red', 'orange', 'green')) +
  geom_smooth(method='lm', se=TRUE, level=0.95) +
  theme_bw() +
  labs(x='WS (km/h)', y='ROS (m/min)', colour='Type of fire') +
  theme(legend.position=c(0.1, 0.8)) +
  theme(legend.background=element_rect(fill='white', colour='black'))


#simple linear sROS model from graph:
sf.lin.ws <- lm(ROS ~ ws, data=fd.ros %>% filter(FiT2=='S'))

```

```{r label=m.25percent, echo=FALSE }

#get predictions for assigned function models:
#At this point, 65 obs from boreal conifer looks good
df.funs <- s.con %>%
#  fd.ros %>% filter(FiT2=='S') %>% 
  select(fire, ws, ISI, ROS) %>% 
  filter(!str_detect(fire, 'DEWDROP')) %>%
  mutate(num=row_number(),
         c3s = c3s(ISI),
         c4s=c4s(ISI),
         c6s=c6s(ISI),
         d1=d1(ISI),
         m25 = m25(ws)) %>%
  select(-c(fire, ws, ISI)) %>% select(num, everything()) #num then everything else


#spread data out for easy summarizing
df.funs.longer <- tidyr::pivot_longer(df.funs, 
                                      cols=c(ROS, c3s, c4s, c6s, d1, m25), 
                                      names_to='model', values_to='value')

fig2
```

*Caption: Figure 2. Overview of experimental burn observations by wind speed (WS), rate of spread (ROS) and type of fire showing simple linear trends. S, PC, and AC refer to surface, passive crown, and active crown fire behaviour types, respectively. The black line represents the '25 % model' for surface fire behaviour: ROS=0.25 \* WS (ROS in m/min; WS in km/h).*

Surface fire ROS in conifer stands ranged from `r min(fd.ros$ROS)` â€“ `r max(fd.ros %>% filter(FiT2=='S') %>% pull(ROS))` m min^-1^, with most fires' sROS values well below the maximum (95th percentile sROS of `r quantile(filter(fd.ros, FiT2=='S')$ROS, 0.95)` m min^-1^.). Surface and passive crown fire observations overlap above ROS of approximately 4 m min^-1^. The fitted linear trend shown in Fig 2 (green line) represents a very simple, albeit weak, baseline linear surface ROS model for conifer observations (Model 1, n= `r fd.ros %>% filter(FiT2=='S') %>% nrow()` ; adjusted *R^2^* = 0.319), with a slope of 0.2459. We noted that this is quite close to a slope of 0.25, a model conducive to mental arithmetic and rapid emergency use, particularly if forced through the intercept.

### Model evaluation

Potential fitted models were compared using common evaluation metrics for linear and non-linear models: root mean squared error (RMSE), mean absolute error (MAE), mean absolute percentage error (MAPE), and Ephron's pseudo r-squared (ER2). Ephron's r-squared is appropriate for comparing the variability captured by a models when widely-divergent linear, non-linear, and forced-intercept models are being compared [@Mangiafico2015].

The extensive search revealed *ISI* and *ISI~sa~* to be strong predictors of ROS, as expected. The best 1-4 variable sROS predictor combinations all contained one of these variables as linear or squared terms or in non-linear form*.* These were forced through the origin due to the known lack of fire spread potential during high moisture conditions (e.g. ISI \< 2) and in order to produce models usable across the full range of possible wildfire conditions (i.e., *ISI* or *ISI~sa~* values of 0â€“20 or higher). In particular, *ISI~sa~^2^* was the best single predictor and part of all 2-4 variable combinations using the aggregate dataset. For the conifer-only data, *ISI* was slightly superior, with *ISI^2^* being the single strongest predictor variable.

We evaluated the most promising model forms based on search results in terms of variable significance and simplicity for users. Figure 3 shows the ROS of surface fires classified by fuel type (FT) and surface fuel consumption level, displayed by ISI value, along with a few simple fitted models and the D-1 FBP model. While all fires were initially classed as surface fires, several observations appeared anomalous, particularly those with significant levels of canopy fuel consumption (CFC), suggesting canopy fuel involvement. Fires with estimated CFC \> 0.2 kg m^-2^ (mean CFC: 0.35 kg m^-2^; Fig. 3) were then removed from the dataset as these were considered transitional to crown fire. Figure 3 also shows a linear sROS model based on *ISI* (Model 2: ER2=0.469), as well as the better-fitting model forced through the origin using *ISI^2^* (Model 3: ER2=0.613).

### [Prep for fig3]

```{r label=PrepFig3, ech=FALSE}
#Show data, exceptions (CFC >0.1), PPDF orig. 
s.fires4 <- s.fires3 %>%
  mutate(
                 FT2=str_extract(ExpProject, "\\([^()]*\\)"), #all inside ()
                 FTsp=str_detect(FT2, 'S') %>% as.factor(), #T/F spruce
                 FT3=case_when(
                   str_detect(FT2, '/') ~ '2. S',  #mix of pine /spruce
                   str_detect(FT2, 'S') ~ '2. S',  #spruce only
                   str_detect(FT2, '(JP)') ~ '1. JP',         #jack pine only
                   str_detect(FT2, 'PPDF') ~ '5. PPDF',  #dewdrop ppdf
                   str_detect(FT2, 'D1') ~ '4. Decid', #D1 stands
                   str_detect(FT2, 'P') ~ '3. OP') %>% #should cover other pines
    as.factor())


#asymtote function - not used; see 'slope asymptote' section below
# asym <- function(isi) {
#   0.33333*isi #ROS 10 at ISI 30
# }

```

### [slope asymtote CR models]

```{r label=slope asymtote, echo=FALSE}

#make asymtote as linear function
#For aggregate 'level off' (CR) model, Should cross ROS=20 at around ISI=65
#very similar to current sf.crisi.fun(65)
#combine that with a shallow slope, say 0.15
asy.slope1 <- 0.15 #m
asy.yInt1 <- 10 #i

asym1 <- function(isi) {
  asy.slope1*isi +asy.yInt1
}

# New Aggregate CR equation with slope asymptote
sf.agg.asy<- nls(data=s.fires.mod, formula= #substitute for sf.crisi.mod
               ROS ~ (asy.slope1 * ISI + asy.yInt1) * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

#fitted asymptote?
sf.agg.asyfit<- nls(data=s.fires.mod, formula= #substitute for sf.crisi.mod
               ROS ~ (m1 * ISI + asy.yInt1) * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3, m1=0.15))
##fitted m and i didn't converge; fitted m1 gave NS model, with m1=~0.22


sf.asy.fun <- function(isi) {  #substitute for sf.crisi.fun; M10
  predict(sf.agg.asy, newdata=list(ISI=isi))
}

#exploratory graph to show that this works - asymptote graph, aggregate data, ISI
ag <- ggplot(s.fires4, aes(x=ISI, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asy.fun, xlim=c(0, 70), colour='green') + 
  stat_function(fun=sf.crisi.fun, xlim=c(0, 70), colour='black') +
  stat_function(fun=asym1, xlim=c(0, 70), colour='blue') +
  coord_cartesian(ylim=c(0, 25))

#yessss!!

#Conifer, ISI
#For start, use same asymptote as Aggregate model- no, shift upwards a bit
asy.slope2 <-0.15
asy.yInt2 <-13

#New Conifer model with slope asymptote
sf.con.asy <-nls(data=s.con, formula=
                 ROS ~ (asy.slope2 * ISI + asy.yInt2) * (1-exp(-b*ISI))^c,
                 start=list(b=0.1, c=3))

#fitted asymptote?
# sf.con.asyfit <-nls(data=s.con, formula=
#                  ROS ~ (asy.slope2 * ISI + i2) * (1-exp(-b*ISI))^c,
#                  start=list(b=0.1, c=3, i2=13))
#did not converge/infinity produced

#prediction function
sf.asyCon.fun <- function(isi) {  #substitute for sf.crisiCon.fun; M13
  predict(sf.con.asy, newdata=list(ISI=isi))
}

asym2 <- function(isi) {
  asy.slope2*isi +asy.yInt2
}

#Exploratory asymptote graph
ag2 <- ggplot(s.con, aes(x=ISI, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asyCon.fun, xlim=c(0, 70), colour='green4') + 
  stat_function(fun=sf.crisiCon.fun, xlim=c(0, 70), colour='gray4') +
  stat_function(fun=asym2, xlim=c(0, 70), colour='blue') +
  coord_cartesian(ylim=c(0, 25))

#ISI.mcsa - Aggregate; same asymptote to start with
asy.slope3 <- 0.15
asy.yInt3 <- 10

asym3 <- function(isi.m) {
  asy.slope3*isi.m +asy.yInt3
}

# New Aggregate CR equation with slope asymptote
sf.aggM.asy<- nls(data=s.fires.mod, formula= #substitute for sf.crisim.mod
               ROS ~ (asy.slope3 * isi.m + asy.yInt3) * (1-exp(-b*isi.m))^c, 
               start=list(b=0.1, c=3))

#fitted asymptote?
# sf.aggM.asyfit<- nls(data=s.fires.mod, formula= #substitute for sf.crisim.mod
#                ROS ~ (asy.slope3 * isi.m + i3) * (1-exp(-b*isi.m))^c, 
#                start=list(b=0.1, c=3, i3=10))
#did not converge/infitity produced when fitting m3 or i3

sf.asyM.fun <- function(isi.m) {  #substitute for sf.crisi.fun; M10
  predict(sf.aggM.asy, newdata=list(isi.m=isi.m))
}

ag3 <- ggplot(s.fires4, aes(x=isi.m, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asyM.fun, xlim=c(0, 70), colour='green4') + 
  stat_function(fun=sf.crisim.fun, xlim=c(0, 70), colour='gray6') +
  stat_function(fun=asym3, xlim=c(0, 70), colour='blue3') +
  coord_cartesian(ylim=c(0, 30))


#ISI.mcsa - Conifer
asy.slope4 <-0.15
asy.yInt4 <-13

#New Conifer model with slope asymptote
sf.conM.asy <-nls(data=s.con, formula=
                 ROS ~ (asy.slope4 * isi.m + asy.yInt4) * (1-exp(-b*isi.m))^c,
                 start=list(b=0.1, c=3))

#prediction function
sf.asyMCon.fun <- function(isi.m) {  #substitute for sf.crisiCon.fun; M13
  predict(sf.conM.asy, newdata=list(isi.m=isi.m))
}

asym4 <- function(isi.m) {
  asy.slope4*isi.m +asy.yInt4
}

#Exploratory asymptote graph
ag4 <- ggplot(s.con, aes(x=isi.m, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asyMCon.fun, xlim=c(0, 70), colour='turquoise') + 
  stat_function(fun=sf.crisimCon.fun, xlim=c(0, 70), colour='gray5') +
  stat_function(fun=asym4, xlim=c(0, 70), colour='purple') +
  coord_cartesian(ylim=c(0, 30))

#new models to replace old CR (fixed asymptote mods):
#sf.agg.asy - aggregate, ISI
#sf.con.asy - conifer, ISI
#sf.aggM.asy - aggregate, isi.m
#sf.ConM.asy - conifer, isi.m

```

### [Fig3]

```{r label=Fig3, echo=FALSE}

Fig3 <- ggplot(s.fires4 %>% 
                 filter(!is.na(SFC)), 
       aes(x=ISI, y=ROS)) +  
  scale_colour_manual(values=c(
    'red3',
    'orange2',
    'yellow3', 
    'darkgreen',
    'turquoise4',
    'darkorchid4')) +
  geom_point(aes(colour=FT3, size=SFC), alpha=0.6) + #main fires    
  geom_point(data=except, aes(colour=FT, size=SFC), shape=22) + #torching
  geom_point(data=wildfires, colour='black', fill='black', size=1, 
             shape=21) + #wildfires
#  geom_point(data=ppdf, aes(size=SFC), shape=21) +
  stat_smooth(data=s.fires.con, method=lm, formula=y~I(x^2)-1, 
              se=FALSE, colour='black') + #same as sros.isi2.mod   
  stat_smooth(data=s.fires.con, method=lm, 
              formula=y~x, se=FALSE, colour='gray') + #linear fit
  stat_function(fun=d1, colour='green3', linewidth=1) +
  theme_bw() +
  #theme(legend.position='none') +
  labs(y='ROS (m/min)', colour='Fuel Type & Torching')
  
  
Fig3


sf.lin.isi <- lm(ROS~ISI, data=s.fires.con)
#linear ISI model like in graph

```

*Caption: Figure 3. Fire observations showing rate of spread (ROS) by ISI. Most symbols represent experimental fires except those with a black centre are wildfires. Colours indicate fuel type and fire characteristics as follows: JP: jack pine; S: black spruce or pine-spruce mix; OP: other pine; Decid: deciduous; PPDF: ponderosa pine-Douglas-fir; Torch: torching or passive crown fire behaviour (removed from surface model analysis). Size indicates relative surface fuel consumption (SFC, kg m^-2^). The lines represent linear (Model 2: gray) and squared (Model 3: black) ISI models fitted to conifer observations (JP, S, OP), along with the FBP D-1 model (green).*

### [DewdropWFC]

```{r label=DewdropLargeWFC, echo=FALSE, warnings=FALSE}
#difference between Stocks' sites and Dewdrop:
stockssfc <- filter(fd.all, num %in% c(sharp, kenshoe)) %>%
  filter(num !=40 & num !=24) %>% pull(SFC)

stocks.lwfc <- c(
0.049,
0.042,
0.086,
0,
0.047,
0.01,
0,
0,
0.231,
0.045,
0.074,
0.132, #end Kenshoe
  0.037,
0.024,
0.047,
0.085,
0.259,
0.153,
0.345,
#0.345,  #no duplicating p11
0.34,
0.374,
0.488,
0.061,
0.223  #end sharpsand
)

#large WFC proportion
stocks.prop <- stocks.lwfc/stockssfc

#Dewdrop burns - need to add 
dewdrop.lwfc <- c(
1.139,
0.061,
0.681,
1.545,
0.693,
2.188,
3.892
)

dewdropsfc <- filter(fd.all, num %in% dewdrop) %>%
  filter(num !=120)  %>% #filter out 1980 burn, no info
  pull(SFC) + dewdrop.lwfc

#large wfc proportion
dewdrop.prop <- dewdrop.lwfc/dewdropsfc

#Wilcoxon rank-sum test (Mann-Whitney U-test)
prop.data <- data.frame(LWFC.prop=c(
  stocks.prop, dewdrop.prop),
            site=as.factor(
            c(rep(1, times=length(stocks.prop)),
              rep(2, times=length(dewdrop.prop)))))
                        
# wilcox.result <- prop.data %>%
  # with(wilcox.test(LWFC.prop ~ site)) 
# W=9, p-value=0.0004296
                                       
                                       
```

The influence of conifer fuel type (FT) was only significant when combined with *ISI^2^* or *ISI~sa~^2^* in the boreal conifer fires. The lone surface fire observation in black spruce was grouped with five observations in mixed jack pine- black spruce in order to separate spruce-containing observations (S) from the pine-type fires. There were 19 fires in jack pine (JP), and 26 in stands dominated by other pine species (OP); see [@perrakis2023] for details. Although FT was significant, the only significant contrast (Tukey HSD: $\alpha=0.05$) was between OP and JP, with OP fires exhibiting slightly slower ROS compared with JP fires (Fig. 3). FT was not significant in the aggregate data models.

Most model forms using \> 2 predictors were non-significant ($\alpha=0.05$) owing to the modest sample size and high variability. Stand density class was not significant in any models.

### [Table 1: Model summary]

```{r Mod sum table, echo=FALSE, warning=FALSE}
#Model list

#New CR replacements
#sf.agg.asy - aggregate, ISI
#sf.con.asy - conifer, ISI
#sf.aggM.asy - aggregate, isi.m
#sf.ConM.asy - conifer, isi.m


#add sros.st, 
mod.list.long <- list(sf.lin.ws,
              sf.lin.isi,
              con.ISI.mod,
              con.lm.mod,
              sros.ws2.mod,
              sros.ISI2.mod,
              sros.ISI2SFC.mod,
              sros.isim2.mod,
              sros.isim2SFC.mod,
              sf.agg.asy,  #slope asymptote model, aggregate ISI
        #      sf.crisi.mod,
              sf.aggM.asy, #slope asymptote for aggregate, isi.m
        #      sf.crisim.mod,  #
              sf.axb.isi.mod, 
              sf.con.asy, #slope asymptote, conifer ISI
        #      sf.crisiCon.mod,
              sf.conM.asy, #slope asymptote, conifer isi.m     
        #      sf.crisimCon.mod, #
              sf.ftisi,
              c3s,
              c4s, 
              c6s,
              d1,
              m25)

modnames <-c('wslin.con',
             'isilin.con',
             'ISI2.con',
              'isim2.con',
              'WS2.agg',
              'ISI2.agg',
              'ISI2SFC.agg',
              'isim2.agg',
              'isim2SFC.agg',
              'crisi.asy.agg', #replaces crisi.agg
              'crisim.agg',
              'axb.isi.agg',
              'crisi.asy.con',  #replaces crisi.con
              'crisim.con',
             'ftisi',
             'c3s', 'c4s', 'c6s', 'd1', '25 perc') #last 5 are functions

#models only (not functions)
mod.list <- mod.list.long[1:(length(mod.list.long)-5)]

#formulae from model list
formulae0 <- lapply(mod.list, FUN=formula) %>% 
  as.character() %>%
  str_extract(pattern="~(.*)") %>% #keep everything right of the tilde
  str_remove('~ ') 

#edit formula strings
process_string <- function(s) {
  if (str_ends(s, "- 1")) { # Remove "- 1" from the end
    return(str_remove(s, "- 1$"))
  } else {
    if(str_ends(s, '\\^c') | str_ends(s, '\\^b'))
       {return(s)} else {
    return(str_c("b0 +", s))      # Add "b0 +" to the beginning
  }}
}

formulae <- sapply(formulae0, process_string) %>% unname() %>%
   #get ride of the tilde
  append(c(  #add the manual and Van Wagner models at the end
    'C-3s', #c3s
    'C-4s', #c4s
    'C-6s', #c6s
    'D-1', #d1
    '25 % WS_10')) %>% #m25 model
  str_replace_all('I\\(ISI\\^2\\)', 'ISI2') %>%  #clean up squared terms
  str_replace_all('I\\(isi.m\\^2\\)', 'ISIsa2') %>%
  str_replace_all('I\\(ws\\^2\\)', 'WS2') %>%
  str_replace_all('\\(asy[^)]*\\)', 'SlAsy') %>%
  # str_replace_all('a.value', str_c('Asy', as.character(a.value))) %>%
  # str_replace('b0 \\+Sl', 'Sl') %>% #fix extraneous  b0 term for m12
  str_replace_all('isi.m', 'ISIsa')

#generate table of evaluation metrics
#MAE, MAPE, MSE
acc.table2 <- rcompanion::accuracy(mod.list) %>% 
  as.data.frame() %>%
  mutate(num=1:length(mod.list))

#get AIC, num of obs - repeat glance function across all models
acc.glance <- lapply(mod.list, broom::glance)

#pull nobs and AIC from glance operation
acc.glance2 <- lapply(acc.glance, `[`, c('nobs', 'AIC' )) %>%
  list_rbind() %>% round(1) %>%
  mutate(num=1:length(acc.glance))

#metrics for pre-determined model functions:
#mae.manual(actual=df.m25$ROS, pred=df.m25$pred25) # etc.
load(file='./files/mae.rda')
load(file='./files/mape.rda')
load(file='./files/Efr2.rda')

#calculate some metrics for m25 and the FBP model functions:
#FBP/VW models
df.eval <- df.funs.longer %>% group_by(model) %>%
    summarize(MAE=mae.manual(actual=df.funs$ROS, pred=value) %>% round(2),
              MAPE=mape.manual(actual=df.funs$ROS, pred=value) %>% round(2),
              ER2=ef.r.squared(actual=df.funs$ROS, pred=value) %>% round(2)
              ) %>%
  filter(model != 'ROS') %>%
  mutate(num=(length(mod.list)+1):(length(mod.list)+5),nobs=NA, RMSE=NA) %>%
  rename(Model=model)

#combine the two column groups, two evaluation tables, clean up
acc.table3 <- left_join(acc.glance2, acc.table2, 
                        by='num') %>%
  mutate(Model=modnames[1:(length(modnames)-5)]) %>%
  rename(MAE=Fit.criteria.MAE,
         MAPE=Fit.criteria.MAPE,
         RMSE=Fit.criteria.RMSE,
         ER2=Fit.criteria.Efron.r.squared
        ) %>%
  select(num, Model, nobs, RMSE, MAE, MAPE, ER2, AIC) %>%
  #add FBP and m25 metrics
  bind_rows(df.eval)

#ROS table at ISI (ISIm)=5, 10, 15
isi.vals=c(5, 10, 15)
ffmc.val=91
ws.vals=c(1, 14, 22)
mod.order.isim<- c(1, 4, 7, 10)

#create blank list
pred.list <- vector('list', length(mod.list))
names(pred.list) <- modnames[1:(length(modnames)-5)]

for (i in seq_along(mod.list)) {  #predict all mods in mod.list
  pred.list[[i]] <- predict(mod.list[[i]], 
                            newdata=
                              data.frame(ISI=isi.vals,
                                        isi.m=isi.vals,
                                        FFMC=ffmc.val,
                                        ws=ws.vals,
                                        SFC=1.5,
                                        FT='Con'))
}

pred.df <- data.frame(ISI=isi.vals, pred.list) %>%
  mutate_all(round, 1)

#transpose
pred2.df <- as.matrix(pred.df) %>% 
  t() %>% as.data.frame() %>%
  mutate(Model=colnames(pred.df)) %>%
  slice(2:ncol(pred.df)) %>%
  select(Model, everything())

row.names(pred2.df) <- NULL
isi.colnames <- c('ISI=5', 'ISI=10', 'ISI=15' ) 
colnames(pred2.df)[2:4] <- isi.colnames

#get c6, c4s, c3s d1 predictions
#ws vals at FFMC 91: 0.2162, 13.972, 22.019
ws.vals <- c(0.2162, 13.972, 22.019)

#predict ROS at 5, 10, 15 for FBP models, 25% model
v1 <- c3s(isi.vals)
v2 <- c4s(isi.vals)
v3 <- c6s(isi.vals)
v4 <- d1(isi.vals)
v5 <- m25(ws.vals)

#transpose
v15vals <- data.frame(v1, v2, v3, v4, v5) %>%
  as.matrix %>% t() %>%
  as.data.frame()

#A lot of effort to make a table of predictions at 3 values, but it works
predAdd.df <- data.frame(Model=df.eval$Model, 
                         ISI.5=v15vals[,1] %>% round(1),
                         ISI.10=v15vals[,2] %>% round(1),
                         ISI.15=v15vals[,3] %>% round(1))
colnames(predAdd.df) <- c('Model', isi.colnames)

#combine sROS models, FBP models
pred3.df <- rbind(pred2.df, predAdd.df)

acc.tab4 <- left_join(pred3.df, acc.table3, by='Model') %>%
  mutate(Num=1:max(nrow(pred3.df), nrow(acc.table3)),
         Formula=formulae) %>%
  select(Num, Model, Formula, N=nobs, everything(), -num)

######################
#write.csv(acc.tab4, 'acc_table.csv')

#acc.tab4

#generate formatted table using gt
require(gt)

acc.tab4 %>% select(-Model) %>%
  #mutate(Formula = if_else(row_number() <= 9, 
  #                         map_chr(Formula, format_formula), 
  #                         Formula)) %>%
  gt() %>%
  tab_header(
    title = "Table 1" #,
#    subtitle = "Your subtitle (if needed)"
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  cols_width(
    Num ~ px(50),
    Formula ~ px(100),
    everything() ~ px(60)
  ) %>%
  tab_spanner(
    label='Predicted ROS (m/min)',
    columns=4:6
  ) %>%
  tab_spanner(
    label='Evaluation metrics',
    columns=7:11
  ) %>%
  tab_style(
    style = cell_borders(
      sides = 'bottom',
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(100),
    column_labels.border.top.width = 2,
    column_labels.border.top.color = "black",
    column_labels.border.bottom.width = 2,
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table.border.bottom.width = 2,
    data_row.padding = px(3),
    column_labels.border.bottom.style = 'none',
    table_body.hlines.color = 'white'
  ) %>%
  opt_horizontal_padding(scale = 0.5) %>%
  opt_vertical_padding(scale = 0.5) %>%
  tab_source_note(
    source_note = "Your source note or additional information here"
  ) %>%
  opt_table_font(font = "Arial") #%>% gtsave("your_table.html")


```

*Caption: Table 1. Model forms and evaluation metrics for the fitted sROS models. Formulae include variables representing 10-metre wind speed (WS~10~), initial spread index (ISI), stand-adjusted ISI (ISI~sa~), surface fuel consumption (SFC, kg m^-2^), and fuel type (FT). ISI/ISI~sa~ columns represent predicted ROS (m min^-1^) for given models at each predictor level. Constants used in prediction calculations include FFMC 91 (Models 1, 5, 19), SFC of 1.5 kg m^-2^ (Models 7 and 9), and fuel type 'Conifer' (Model 15). Evaluation metrics are unitless and include root mean squared error (RMSE), mean absolute error (MAE), mean absolute percentage error (MAPE), Efron's R-squared (ER2), and Akaike's Information Criterion (AIC). Predefined functions (not fitted) include C-3S, C-4S, C-6S, D-1, and M25, which were evaluated against the 51 boreal conifer fire observations.*

### Final fitted models

Table 1 shows evaluation metrics for the list of fitted models, as well as *ROS* predictions at three levels of *ISI* or *ISI~sa~* (5, 10, 15). Other variables (FFMC, SFC, FT) were assigned values for calculation purposes, as noted. Also shown are evaluation results using the previously described Van Wagner and FBP surface fire models. As the table indicates, the datasets used varied from `r min(acc.tab4$N, na.rm=T)` to `r max(acc.tab4$N, na.rm=T)` observations. Models using the SFC predictor excluded observations without estimated SFC, resulting in slightly smaller datasets. 'Aggregated data' models included all surface fire observations except those with canopy fuel involvement, as noted previously; this included fires in boreal conifer, deciduous-mixed, and PPDF stands as well as three well-documented wildfires. Boreal conifer models used only the aforementioned fires in spruce, pine-spruce, or boreal/sub-boreal pine [for site and experimental descriptions see @perrakis2023]. Models 2â€“4 included all such fires, while models 5â€“15 excluded fires that exhibited more significant torching, as noted.

Models forms 1â€“4 and 13â€“14, using the boreal conifer observations, had lower variability and thus better performance (higher Efron's r-squared, lower MAE and MAPE) than analogous models fitted to the larger aggregated dataset (Models 5 â€“ 12, 15). Non-linear model forms had insufficient data to automatically fit the asymptote parameters, using either a fixed value asymptote (eq. [2]) or linear function asymptote (eq. [3]). Rather than setting an arbitrary asymptote for extrapolation purposes (e.g., a=20 was initially tested), we set an oblique asymptote (eq. [) ]based on visual inspection and an assumed gradual ROS rise beyond the range of data. Aggregate models: *m*=0.15, *i*=10; conifer models: m=0.15, i=13. The remaining parameters were fitted to the data, producing relatively high-performing models, particularly for the boreal conifer dataset (Models 13, 14: ER2 \> 0.7, MAE \< 0.9 m min^-1^); the corresponding aggregated forest data models performed adequately, but reflected greater variability in the source data at higher wind and *ISI* or *ISI~sa~* levels. In contrast, when using the broader aggregated dataset, the best performance included *ISI~sa~* and *SFC* predictors (Model 9: ER2 of 0.662, MAE \<1 m min^-1^).

The evaluation measures in Table 1 show how the older Van Wagner [@vanwagner1993a] and FBP surface fire functions, as well as the '25%' model ('M25'), compare to the new fitted models for precting ROS of the boreal conifer data. High MAE and MAPE values, and negative values for Efron's R-squared, suggest very poor performance by (especially) the C-4s and C-6s models compared to the fire observations. The C-3s, D1, and 25% models, in contrast, are in the lower end of the range of model performance, but otherwise appear to produce acceptable results. When fitted to the deciduous data alone, the D-1 model had the following diagnostics: RMSE=0.568; MAE=1.297; MAPE=0.988; ER2=0.543.[^1] There were no advantages to the $a \cdot ISI ^{b}$ model (Model 12) over other model forms.

[^1]: Note: the dataset for the D-1 model originally described by [@forestrycanadafiredangergroup1992] differs only from present deciduous database by two additional wildfires, excluded here to a lack of documentation.

### [Table 2: Extended SFC predictions]

```{r Table 2, echo=FALSE}
#
#extra table for SFC-based models
multiv.names <- c(rep(c('ISI2SFC.agg', 'isim2SFC.agg'), each=4), rep('ftISI', 3))
sfc.levels <- c(0.7, 1.5, 3, 5)
ft.levels <- c('Decid', 'Con', 'PPDF')

#sf.isi2sfc.fun and sf.isim2sfc.fun - calc ROS for 3 ISI vals, 4 SFC vals
sfc.isivals <- mapply(FUN=sf.isi2sfc.fun, isi=rep(isi.vals, 4), 
                 sfc=rep(sfc.levels, each=3)) %>%
  matrix(nrow=4, ncol=3, byrow=TRUE) %>%  #calculate ROS for each
  as.data.frame() 
colnames(sfc.isivals) <- isi.colnames

sfc.isimvals <- mapply(FUN=sf.isim2sfc.fun, 
                       isim=rep(isi.vals,4),
                sfc=rep(sfc.levels, each=3)) %>%
  matrix(nrow=4, ncol=3, byrow=TRUE) %>%
  as.data.frame()
colnames(sfc.isimvals) <- isi.colnames

ftisi.vals <- mapply(FUN=ft.isi.fun,
                       isi=rep(isi.vals, 3),
                ft=rep(ft.levels, each=3)) %>%
  matrix(nrow=3, ncol=3, byrow=TRUE) %>%
  as.data.frame()
colnames(ftisi.vals) <- isi.colnames

#combine df for both models
sfc.allvals <- rbind(sfc.isivals, sfc.isimvals, ftisi.vals) %>%
  round(2)

ex.sfc.tab <- mutate(sfc.allvals, 
                     Model=multiv.names, 
                     SFC=c(rep(sfc.levels, 2),NA, NA, NA),
                     FT=c(rep('Agg', 8), ft.levels),
                     num=1:11) %>%
  select(num, Model, SFC, FT, everything())

#####################################



#ex.sfc.tab table, formatted using gt

extended.sfc.final <-ex.sfc.tab %>% 
  mutate(Model=c(rep(c('7 (ISI, SFC)', '9 (ISI_sa, SFC)'), each=4), 
                 rep('15 (ISI, FT)', 3))) %>%
  select(-num) %>%
  rename('SFC \n (kg/m2)'=SFC, 'Model (predictors)'=Model) %>%
  gt() %>%
  tab_header(
    title = "Extended prediction table for multivariate models" #,
#    subtitle = "Your subtitle (if needed)"
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  cols_width(
    'Model (predictors)' ~ px(100),
    everything() ~ px(60)
  ) %>%
  tab_spanner(
    label='Predicted ROS (m/min)',
    columns=4:6
  ) %>%
  tab_style(
    style = cell_borders(
      sides = 'bottom',
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(100),
    column_labels.border.top.width = 2,
    column_labels.border.top.color = "black",
    column_labels.border.bottom.width = 2,
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table.border.bottom.width = 2,
    data_row.padding = px(3),
    column_labels.border.bottom.style = 'none',
    table_body.hlines.color = 'white'
  ) %>%
  opt_horizontal_padding(scale = 0.5) %>%
  opt_vertical_padding(scale = 0.5) %>%
  #tab_source_note(
  #  source_note = "Your source note or additional information here"
  #) %>%
  opt_table_font(font = "Arial") #%>% gtsave("your_table.html")

#compare SFC to sqrt(SFC)
ef.sfc.mod1 <- ef.r.squared(actual=augment(sros.ISI2SFC.mod) %>% pull(ROS), 
             pred=augment(sros.ISI2SFC.mod) %>% pull(.fitted))

ef.sfc.mod2 <- ef.r.squared(actual=augment(sros.isim2SFC.mod) %>% pull(ROS), 
             pred=augment(sros.isim2SFC.mod) %>% pull(.fitted))

ef.sfc.mod10 <- ef.r.squared(
  actual=augment(update(sros.ISI2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(ROS),
  pred=augment(update(sros.ISI2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(.fitted))

ef.sfc.mod20 <- ef.r.squared(
  actual=augment(update(sros.isim2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(ROS), pred=augment(update(sros.isim2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(.fitted))



```

*Caption: Table 2. Extended predictions for models 7 and 9, using varying values of predicted Surface Fuel Consumption (SFC; Models 7 and 9) from 0.7 kg m^-2^ to 5.0 kg m^-2^, fuel types (FT; Model 15) Deciduous (Decid), Conifer (Con) or Ponderosa pine-Douglas-fir (PPDF, adjusted to 95% cured), and ISI or ISI~sa~ values from 5 to 15. See Table 1 for model predictor forms.*

Extended ROS predictions were also compared for the three aggregated data models with two predictors: *ISI* (or *ISI~sa~*) and *SFC,* and *ISI* and fuel type (Table S1). SFC-based models used a *sqrt(SFC)* term, which performed slightly better (*ISI*: Efron's R^2^=`r ef.sfc.mod1 %>% round(4)`); *ISI~sa~*: adjusted R^2^=`r ef.sfc.mod2 %>% round(4)`) than an untransformed *SFC* term (*ISI*: `r ef.sfc.mod10 %>% round(4)` ; *ISI~sa~*: `r ef.sfc.mod20 %>% round(4)` , respectively).

#move to discussion While the inclusion of SFC in these models offers a helpful second predictor for ROS that can be predicted from fuel loading and indices of moisture deficit [@degroot2009], the influence of SFC was highest at low *ISI* (or *ISI~sa~*) values, and became negligible under higher ISI conditions.

### [Figure 4]

```{r label=Fig4, echo=FALSE}
#Do nlstools jackknife resampling to identify overly influential obs
#do this on crisiCon, crisimCon, 

jack.crisiCon <- nlstools::nlsJack(sf.crisiCon.mod)
#summary(jack.crisiCon)
jack.crisimCon <-nlstools::nlsJack(sf.crisimCon.mod)
#summary(jack.crisimCon)
#crisiCon: rows 10, 28, 49, 51 (s.con2)
#crisimCon: rows 10, 28, 51
#num: 20, 68, 122, 125

#for lm models, use broom::augment to run Cook's D
#high influence: D >1, or 0.5, or 4/n
cook.isim2sfc <- broom::augment(sros.isim2SFC.mod)
cook.ISI2sfc <- broom::augment(sros.isim2SFC.mod)

#cook.isim2sfc %>% top_n(.cooksd, n=10) %>% arrange(desc(.cooksd))
#cook.ISI2sfc %>% top_n(.cooksd, n=10) %>% arrange(desc(.cooksd))
#isim2sfc: rows 52, 28, 88, 60
#num: 117, 68, 232, 204
#ISI2sfc: rows 58, 28, 88, 59, 60

#model labels
lab1 <- 'M9' #change to dynamic label 
lab2 <- 'M11'
lab3 <- 'M14'  #crisim.con


fig4 +
  geom_text(x=23, y=sf.isim2sfc15.fun(23)+1, label=lab1, 
            colour='purple', size=4) +
  geom_text(x=24, y=sf.crisim.fun(24)-1, label=lab2,
            colour='purple') +
  geom_text(x=19, y=sf.crisimCon.fun(19)+1, label=lab3,
            colour='pink') +
  labs(x=expression(ISI[sa]), y='ROS (m/min)', size=expression(SFC~(kg/m^{2})), 
       colour='Fuel type') +
  theme(legend.position='none')
  
```

*Caption: Figure 4. Surface fire rate of spread (ROS) observations and selected fitted models, using the stand-adjusted initial spread index (ISI~sa~). Colours indicate fuel type as follows: red: boreal conifer; blue: ponderosa pine-Douglas-fir (PPDF) adjusted to seasonally cured condition; green: deciduous; gray: original PPDF (not modelled). Size indicates surface fuel consumption. Observations with black centres are documented wildfires; the remainder are experimental fires.*

Figure 4 shows the surface ROS observations plotted by overall fuel type (boreal conifer, deciduous, or PPDF) and SFC against ISI~sa~, along with three of the fitted models: M9 (calculated at SFC=1.5 kg m^-2^), M11, and M14 (boreal conifer only). PPDF fires adjusted to 95% curing conditions were used in model fitting, while the original observations (not included in models) are shown in grey. Observations with a black centre are wildfires; the remainder represent experimental fires. Fuel type (Con, PPDF, or Decid) was not significant in any form of model using ISI~sa~.

Figure 5 shows the observations and selected model predictions based on the ISI, along with certain benchmark models. Model 15 is shown separated by FT category, boreal conifer (Con), PPDF (95% cured), or deciduous (Decid) categories. For ROS prediction purposes, Decid \< Con \< PPDF (see Table 1 and Appendix 1); however, only the Con-PPDF and Decid-PPDF differences were significant (Tukey's HSD; $\alpha=0.05$ ). Also evident from Figure 5 are the noted overprediction tendencies of the C-6s and (especially) C-4s models.

As Table 1 indicates, 'aggregated' dataset models (e.g. M10, M15) performed generally worse (higher MAE, MAPE, lower Efron's R-squared) than the boreal conifer-based models (e.g. M13) when using ISI-based predictors, although M15 performed relatively well overall, with MAE \< 1 and ER2 of 0.585.

#### Influential observations #not sure if this is needed

Individual observations were evaluated for leverage in the best models using Cook's Distance for linearized models (Models 7 and 9#) and jackknife resampling for non-linear models ('nlstools' R package, v2.1; @baty2015). For non-linear models 13 and 14#, observations were flagged when the difference between model parameters calculated with and without individual estimates, $\Delta$, was $\Delta>\frac {2 s} {\sqrt{n}}$, where *s* is the standard error of the parameter estimate and *n* is the sample size [@baty2015]. For linearized models, observations with Cook's D \> 0.1 were flagged as influential. High influence observations are shown in Figures 4 and 5 (#to do), consisting generally of high *ISI*/*ISI~sa~* and high ROS observations, particularly wildfires. Due to the shortage of data at high fire danger conditions, there is no way of removing these observations without significantly affecting the models and range of inference. Primary source descriptions that exist for these fires [e.g. @vanwagner1965b] suggest low confidence in these observations, unsurprisingly.

### [Fig 5]

```{r label=Fig5, echo=FALSE}
lab4 <- 'M15'
lab5 <- 'M13'

fig5 + 
  stat_function(fun=ft.isi.fun, args=list(
    ft='Con', mod=2), color='red2') + #M15 FT mod
  stat_function(fun=ft.isi.fun, args=list(
    ft='PPDF', mod=2), color='blue4') + #M15 FT 
  stat_function(fun=ft.isi.fun, args=list(
    ft='Decid', mod=2), color='green3') + #M15 FT
  stat_function(fun=sf.crisiCon.fun, color='pink') +  
  geom_text(x=10, y=c4s(10)+3, label='C-4s', colour='turquoise') +
  geom_text(x=25, y=ft.isi.fun(isi=25, mod=2)+1, label=lab4) +
  geom_text(x=24, y=c3s(24)-1, label='C-3s', colour='purple') +
  geom_text(x=26, y=sf.crisiCon.fun(26)+1.2, label=lab5, colour='pink')+
  geom_text(x=19, y=c6s(19)+1.5, label='C-6s', colour='darkred') +
  stat_function(fun=c3, colour='gray') +
  geom_text(x=20, y=c3(20)-1.5, label='C-3', colour='gray') +
  coord_cartesian(x=c(1, 30), y=c(0, 25)) +
  labs(x='ISI', y='ROS (m/min)') +
  theme(legend.position='none')
#  geom_point(data=d1.missing, inherit.aes=TRUE)

```

*Caption: Figure 5. Surface fire observations by ISI, ROS, and fuel type (FT): green (deciduous; Decid), blue (Ponderosa pine-Douglas-fir; PPDF), or red (boreal conifer; Con), along with sigmoidal model M13 (Con only), fuel type (FT) category model M15 (Con, Decid and PPDF), and FBP-era models (C-3s, C-4s, C-6s, C-3). PPDF fires are shown both with their original observed ROS (gray, not modelled), and normalized to 95% cured condition (blue, modelled). Model labels are colour-coded to line colour except for M15.*

## 5. Discussion

### Operational surface ROS models

This analysis summarizes the findings from Canadian fire behaviour experiments, focusing on fires identified as surface fires by original observers. Since fires in conifer stands spreading under higher danger conditions tend to be crown fires [@vanwagner1977a; @beverly2020; @cruz2022], the majority of surface fires occurred during moderate-level fire danger indices and wind speeds. Crown fire occurrence in conifer forests also depends on other factors such as canopy base height and surface fuel consumption [@cruz2004; @perrakis2023], factors which help explain the existence of a few surface fires (in tall jack pine or ponderosa pine stands) in our database under high danger conditions (i.e., dry and windy). A small number of wildfires exhibiting surface fire behaviour were also included due to their obvious importance in representing 'high end' burning conditions (i.e., high ISI or ISI~sa~). Overall, these fires represent a range of ROS values (0.3â€“12.0 m min^-1^) previously described as 'slow' to 'fast', but primarily in the 'moderately slow' (1â€“3 m min^-1^) to 'moderately fast' (3â€“10 m min^-1^) category [@alexander1989].

There is therefore a paucity of surface fire observations under very dry and windy conditions (e.g, ISI \> 15, ROS \> 5 m min^-1^). As wildfire hazard reduction treatments become more popular, where stands with high CBH and low surface fuel loading are engineered to resist crown fire [e.g., @agee2005; @hirsch1999], there is a need to estimate sROS under higher danger conditions. The lack of data creates uncertainty that cannot be solved by these models alone.

While the ISI is old and familiar, it was the strongest ROS predictor, performing better than other combinations of weather or moisture index variables. The ISI was recently found to be the variable most closely correlated to area burned during the record-breaking 2023 Canadian wildfire season [@jain2024]. Database values used in the analysis represent indices that best represent burning conditions according to primary sources; for forecasting purposes, we expect hourly ISI values to perform better than daily values [@beck2002]. The ISI~sa~ adds some additional influences based on the stand-adjusted moisture estimate models [@wotton2007], including the ability to adjust for stand density and more persistent forest floor drought (as represented by the DMC).

The present surface fire models involve mainly weather and moisture-related inputs, with some influence from fuel type and SFC in some models. The primary value of such surface ROS models may be to inform varying fuel structure scenarios in modelling systems such as Conifer Pyrometrics [@perrakis2020a; @perrakis2024a], where tools such as calculators and graphical dashboards allow users to test various fuel structure and weather scenarios. There was little difference in ROS between most conifer fuel types (e.g., pine species, spruce); however, differences in experimental design (e.g. plot size, fuelbreak width, wind monitoring) preclude precise comparisons. Laboratory experiments have suggested that conifer litter characteristics, including species, affect flammability [@cornwell2015; @Campbell-Lochrie.etal2021]; however, differences are not always exhibited in real world examples given the complexity of fuebeds and diversity in natural forest ecosystems. Deciduous observations were included for simple comparison purposes; however, no new data was provided beyond the range of the original D-1 spread model, which matches the noisy deciduous fire experiment dataset adequately.

### Using final surface rate of spread models

Four or five models presented stand out as superior than the others (Table 1): Models 13 and 14, sigmoidal curves fitted to boreal and sub-boreal conifer stands with the highest ER2 and lowest MAE values; Model 9 [isim2SFC.agg#], the best 'aggregated data' model and one of the lowest MAPE values; Model 15, which showed some flexibility to fuel type, particularly between PPDF and the other conifer and deciduous fires; and perhaps the '25 % model', the simplest model for rapid or emergency use. Model 13 used the familiar ISI measure, based on open wind speed and the FFMC, while Models 9 and 14 took advantage of the additional flexibility of the stand-adjusted litter moisture model and the *ISI~sa~* index.

Although stand density class variables were not significant predictors of ROS on their own, the models using *ISI~sa~* incorporate effects of stand density and DMC indirectly via their influence on fuel moisture (the *mc~sa~*). This is in line with findings from physical modelling studies that suggest, for instance, that thinning treatments can increase surface ROS via higher effective in-stand wind speed in more open stands [e.g., @parsons2018; @marshall2020]. However, the effects of such differences are relatively small in the present models and more extreme changes (e.g. deforestation or severe density reductions) are unlikely to be well represented. For instance, in a pine stand under FFMC 92, DMC 100, WS~10~=15 km h^-1^ conditions in summer, decreasing density from 'high' (H) to 'moderate' (M) or 'low' (L) conditions would result in an increase from 3.5 to 3.7 to 4.6 m min^-1^, respectively, using Model 9 (assuming SFC of 1.5 kg m^-2^): a maximum density-dependent difference ($\Delta$) of 1.1 m min^-1^. Varying SFC between 0.5 and 3.5 kg m-2 would further stretch $\Delta$ to 1.8 m min^-1^, holding weather indices constant. This is a small difference for capturing the sometimes significant changes that can ensue from partial harvesting , for instance; tree density can potentially decrease by 70-80% or more as in certain hazard reduction treatments [@prichard2010; @Hirsch.Pengelly1999]. The present models are appropriate for moderately closed to closed conifer stands; a lower limit for crown closure would likely to be near 20 % (the level of opening of the more open PPDF and jack pine experiments). Below this limit, very open forests and parkland or savannah-type stand structure would have much greater wind penetration [@albini1979; @moon2019] and could potentially support significantly faster surface fire spread than appears in our data. For models that include the SFC factor, the SFC influence is greatest at low ISI or ISI~sa~ levels, and virtually disappears by ISI 15 or higher (Table 2).

The major limitation of the sROS models and dataset are the paucity of observations at higher danger conditions (ws or ISI) and the importance of various low-confidence data points. The reconstructions of various wildfires [@vanwagner1965b; @hummel1979a; @vanwagner1973] will necessarily result in less accurate ROS observations, including estimated predictors, than those from experimental fires. While we assumed that these observations were reconstructed as accurately as possible, monitoring techniques were very simplistic compared to modern methods [e.g. @valero2018; @hart2021]. In general, for improving empirical models, there is no substitute for additional high quality observations. Additional observations spreading under high indices, necessarily with high LCBH and-or low SFC to avoid crowning, would help greatly to improve the accuracy and utility of surface ROS models. At present, extrapolation beyond the range of data (i.e. beyond ISI 19.2 or ISI~sa~ 24.5 for conifer data) is not recommended. Should extrapolation be necessary, we recommend use of one of the sigmoidal-curve models (13 or 14), to avoid the more extreme results potentially generated by quadratic term models (with *ISI^2^* or *ISI~sa~^2^*). For example, the conditions in the previous example (pine stand in summer, density discussion) but with WS~10~=40 km h^-1^ (producing ISI of would produce predicted ROS of 51.4 m min^-1^ using Model 3. Model 13, a sigmoidal model, predicts much lower ROS (22.9 m min^-1^) under such conditions. While the actual sROS of this hypothetical example is unknown (and users might expect true ROS to be +/- 50 % of the predicted value), ROS \> 50 m min^-1^ in a conifer forest is much more likely to be encountered in fully developed active crown fires [Figure 2; see also @stocks1989; @cruz2005] than in any surface fire under a canopy.

Finally, the 25% model is presented in the same vein as the Cruz and Alexander '10% rule' [@cruz2019] and '20% rule' [@cruz2022a] models - as an approximate value suitable for mental arithmetic and rapid field use. However, the unit difference (km h^-1^ vs m min^-1^) is critical for proper usage. An equal comparison with, for instance, the 10% rule (same units) equates to 1.5 % of the WS~10~. This also suggests a finding of interest: on average, experimental conifer crown fires are 5.6 times faster than experimental surface fires under similar wind speeds, since the more accurate approximation for crown fires was 8.4 % of the WS~10~ [@cruz2019] (8.4/1.5=5.6).

```{r label=expectacc, echo=FALSE}

#MAPE
#sros.isim2SFC.mod
pred1 <- broom::augment(sros.isim2SFC.mod) %>% 
  select(ROS, `I(isi.m^2)`, .fitted) %>%
  rename(pred9=.fitted) %>%
  mutate(isi.m=sqrt(`I(isi.m^2)`),
         ape=abs((ROS-pred9)/ROS),
         diff=abs(pred9-ROS))

#MAPE table, M9
#sros.isim2SFC.mod
mape.m9 <- pred1 %>% #isi.m 12 appears to be a threshold
  group_by(ISI_sa=if_else(isi.m < 12, 'Low', 'High'), #group by hi/lo 
           Prediction=if_else(ROS < pred9, 'over', 'under')) %>% #over/under pred 
  summarize(MAPE=mean(ape) %>% round(2), 
            Q90APE=quantile(ape, 0.9) %>% round(2)) %>% #MAPE and 90th of APE
  ungroup() 

# mape.m9 %>% 
#  gt()

#MAE table, M9
mae.m9 <- pred1 %>% #isi.m 12 appears to be a threshold
  group_by(ISI_sa=if_else(isi.m < 12, 'Low', 'High'), #group by hi/lo 
           Prediction=if_else(ROS < pred9, 'over', 'under')) %>% #over/under pred 
  summarize(MAE=mean(diff) %>% round(2), 
            Q90AE=quantile(diff, 0.9) %>% round(2)) %>% #MAE and 90th of AE
  ungroup() 

pred.m9 <- full_join(mae.m9, mape.m9) 

pred.m9 %>%
  gt() %>%
  tab_style(
    style = cell_borders(
      sides = 'bottom',
      color = "black",
      weight = px(1)
    ), 
  locations=cells_column_labels() ) %>%
  tab_options(table_body.hlines.color = 'white') %>%
  tab_source_note(
    source_note = "Note: The threshold between 'High' and 'Low' ISI_sa values is 12"
  )

```

*Caption: Table 3. Expected model accuracy, Model 9.*

### Expected accuracy {#expected-accuracy-1}

The MAE and MAPE values (Table 1) can be used to calculate the mean and expected (e.g. 90th percentile or quantile) error associated with each model. Table 3 shows the mean and 90th quantile absolute error (MAE, Q90AE, respectively) and absolute percentage error (MAPE, Q90APE, respectively) using the example of Model 9, with $sROS=f(ISI_{sa}, SFC)$. Since there appeared to be a difference between the over- and under-prediction error potential at lower versus higher fire danger levels (e.g., Fig. 4), these categories are shown separately. Thus, Surface ROS errors of 1-2 m min^-1^ (approximate rounding of mean and Q90 absolute error of 0.6 â€“ 1.7; Table 3) should be expected below ISI~sa~ 12; and larger errors of perhaps 2-4 m min^-1^ (mean and Q90 absolute error of 1.7 â€“ 3.5) may be expected in real world use between ISI~sa~ 12 and 25. In approximate percentage terms, underprediction by 30-60 %, and overprediction by 70-170 % is to be expected with these models.

While it is perhaps unfair to compare the performance of fitted models to supposedly independently-derived models, it is apparent that some of the FBP-era models performed poorly. Negative values of Efron's R-squared suggest that the C-4s and C-6s models perform worse than a null model using only the mean of all observations; these models are not reccomended for any prediction purposes.

Under very low danger conditions (e.g., FFMC \< 75 or ISI \< 1), ignition in needle fuel substrates becomes highly unlikely [@beverly2007; @nadeem2020], so ROS is a minimal concern.

\# Log-transformation is a common technique to identify patterns across several orders of magnitude; however, this approach seemed unhelpful with present small and variable dataset, and ROS values between 0.3 and 12 m min^-1^.

It is expected that the quality and quantity of source data will improve over time, allowing for periodic reanalysis and improvement of these models. Finally, it is evident from the database presented here that there is a need for more experimental burns, particularly in conditions where ISI \> 12 or so. Given the current availability and familiarity with various fire behaviour models, it should not be an impossible task to plan for and execute moderate-speed and intensity experimental fires safely and fruitfully. Barring that, gleaning additional data from wildfires [@hart2021; @filkov2018] could provide many additional observations, albeit less precise with respect to fuels and weather.

## 6. References

::: {#refs}
:::

## 7. Appendices

### Appendix A: Fires in Ponderosa Pine-Douglas-fir stands in BC

Seven\* experimental fires were conducted in open Ponderosa pine-Douglas-fir forest stands in the Dewdrop Range near Kamloops, British Columbia, in 1978-79. These fires were documented in theses by Nyberg[@Nyberg1979] and Smaill [@Smaill1980], while summary information and photos were incorporated into the FBP System C-7 fuel type [@forestrycanadafiredangergroup1992; @DeGroot1993].

These documents were reanalyzed in order to merge these fires into the modelling database. Stand structure at Dewdrop consisted of a low density overstory and mostly herbaceous understory; mean canopy closure was 27.2 %. Litter and duff cover were described as patchy to nonexistent [@Nyberg1979]. In the FBP System database, surface fuel consumption (SFC) was reported for only one observation (Plot 9), with a very high total SFC value of 5.3 kg m^-2^, including \> 5 kg m^-2^ of woody fuel consumption.

The original SFC estimate for Plot 9 included consumption of all downed woody fuels, including from large diameter coarse woody debris (CWD; \> 7.6 cm). While methodologically consistent with other FBP experimental burns [@stocks1987b; @stocks1989], the Plot 9 CWD consumption represents the great majority of the total SFC and represents an outlier compared to other experiments. For instance, the mean CWD proportion of SFC at the Ontario Kenshoe Lake and Sharpsand Creek sites was 9.2 % [c.f. @stocks1987b; @stocks1989], compared with 50.2 % at Dewdrop (Mann-Whitney U-test: p \< 0.001). The difference is accounted by both higher seasonal drought conditions during the Dewdrop burns (mean Drought Code (DC): 394 at Dewdrop vs 111 at Kenshoe Lake and 161 at Sharpsand; see @vanwagner1987 for DC description), and probably the overall frequency of larger diameter trees at Dewdrop (\> 17 % of trees in the '\>25 cm' DBH class; cf. [@Nyberg1979]); compared with, e.g. \~ 1 % of trees in the '\> 23 cm' DBH class at Kenshoe Lake ('White River'); [@walker1975]).

Including contributions from CWD in surface fires is somewhat at odds with current understanding of flame front dynamics. Consumption studies suggest that most CWD consumption in PPDF stands occurs during post-frontal smoldering rather than during flaming combustion [@monsanto2008; @brown2003; @ottmar2014]. The high SFC at Dewdrop from CWD therefore could overpredict fire intensity and crown fire tendency [@vanwagner1977; @perrakis2023]. To compensate, new SFC values at Dewdrop were calculated excluding the CWD contribution. Including only consumption from finer fuels (grass and herbs, litter, duff, and woody debris \< 7.6 cm) resulted in a recalculated (notably lower: 2.01 kg m^-2^) value for Plot 9.\*\* SFC values calculated using the same methods for Plots 1-6 were 0.47 â€“ 1.39 kg m^-2^.

Also of interest was the summer weather pattern and understory condition during these fires. The 1978 season was described as unusually wet, with measurable rainfall received at the Dewdrop site nearly weekly from April-August [@Nyberg1979], an unusual occurrence in this summer-dry climate. Consequently, understory vegetation remained relatively green during the experimental fires. Relative proportions of live and dead grass and forb biomass were used to calculate percent curing values (% C) for these observations, in the same manner as used in Australian and Canadian grass fire models [@cheney1998; @wotton2009]:$$\% C = \frac {GB_D} {(GB_D + GB_L)} \cdot 100 $$ [B1], where % *C* is the percent curing, and *GB~D~* and *GB~L~* represent dead and live grass and forb biomass (kg m^-2^), respectively. Using mean values from experimental and control plot sampling on each given date [@nyberg1979] gave % *C* values of 56-66 for Plots 1-6. For Plot 9, reported values are unfortunately less explicit between live and dead biomass [@Smaill1980] and eq. B1 could not be used. Based on the slightly lower overall grass moisture value (22.7 %) and late season date, % C for that plot was estimated at 80%.

These analyses allowed us to incorporate the dry cordilleran Dewdrop experimental fires in our surface fire models (aggregated fuels), despite being somewhat distinct from the primarily boreal conifer and deciduous experiments.

\*Plot numbers 1â€“6, burned in 1978, are described by [@Nyberg1979]. Plot 9, burned in 1979, is described by [@Smaill1980]. Plot 8 from the same site was apparently burned in 1980, but no further description or details have been located.

\*\*SFC estimates represent the differences between pre-burn and post-burn fuel loading, including contributions from woody fuels, grasses and forbs, and litter (the site featured negligible duff quantities). Estimating litter consumption values required an estimate of pre-burn litter depth, which was not reported but was instead taken from Ducherer et al. [@ducherer2009], a series of experiments at the same site (mean litter depth from control sites across all years and canopy positions: 3.3 cm).

### 

### Appendix B: Final model coefficients

```{r echo=FALSE, warnings=FALSE}
#build table of coefficients for all final models in 
#acc.tab4 (including c6s, c4s, etc.)

#process model coefs from mod.list.long

#extract fitted models (not preexisting functions)
mod.list.models <- mod.list.long[1:15]

#assign model names with numbers
final.names <- as.data.frame(modnames) %>% 
  mutate(num=row_number(), 
         Model=str_c(num, '. ', modnames))

#produce tidy tables of model parameters

#tidy mod.list to create simple list object
param.list <- purrr::map(
  mod.list.models, tidy) #present clean table of model params and stats

names(param.list) <- slice(final.names, 1:15) %>% 
  pull(Model)

#change list to data frame
mod.params.df <- bind_rows(param.list, .id='Model') %>%
  rename(Term=term, Estimate=estimate) %>%
  mutate(Model=if_else(Model==lag(Model), '.', Model)) 
  #if name is same as previous, just write a dot .
mod.params.df$Model[1] <- names(param.list)[[1]] #fix first name

print(mod.params.df, n=nrow(mod.params.df))
         
  

```

### Appendix C: Extended SFC table

```{r label=ExtSFC, echo=FALSE}

extended.sfc.final
```
