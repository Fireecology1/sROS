---
title: "Simple spread models for understory surface fires"
author: "D.D.B. Perrakis and S.W. Taylor"
output:
  word_document: 
    fig_width: 6.3
    fig_height: 6.3
  pdf_document: default
bibliography: 'C:/Dan/Zotero/My library.bib'
csl: "multidisciplinary-digital-publishing-institute.csl"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,root.dir = 'c:/Dan/_Remote_projects/ccp-sROS')

#setwd("c:/Dan/_Remote_projects/ccp-sROS/files")

#.libPaths("C:/Dan/RPackages")

library(tidyverse)
library(broom)

#Get data frame, ready to query 
#Import data frame
fd <- read.csv('./files/fire_data_June2024.csv')  # with corrected SFC from McRae, Sharp p#16 to sharp.th, PNFI R5 MC.SA, Dewdrop SFC corrected

#FWI and moisture functions 
load(file='./files/wbmc5.rda')
load(file='./files/mcF.rda')
load(file='./files/ISI.rda')
load(file='./files/gr-cf.rda')

#set variables for modelling
fd4 <- mutate(fd, 
              CFI=CFI1, #lower CFI only for multi-story stands
              FSG=FSG1)  #same for FSG

#Deciduous data
d1.fires <- read.csv('./files/fire_data_d1_apr2024.csv')

#Combine conifer data with D1
fd.all <- bind_rows(fd4 %>% select(
  num:RH, Grass.Cure, Plot.Wd) %>%
    mutate(Date=ymd(Date)), 
  d1.fires %>% select(num:RH, Grass.Cure, Plot.Wd) %>%
    mutate(Date=ymd(Date)))  

```

## Abstract

Surface fire behaviour is frequently observed beneath the canopy of Canadian forests under moderate wind speed and moisture deficit conditions. Surface rate of spread (ROS) models can provide guidance for suppression crews and can be incorporated into fire management tools such as fire growth modelling systems. We used a database of primarily experimental surface fires in conifer and deciduous stands to fit simple empirical models of fire ROS that can be readily integrated within operational decision support systems. A variety of empirical models were tested based on variables including the Canadian Initial Spread Index (*ISI*) or a stand-adjusted ISI version (*ISI~sa~*), with options for including other predictors such as wind speed (*WS*), estimated surface fuel consumption (*SFC*) or fuel type class. The simplest model finds surface ROS equal to 1.5 % of the open 10 m *WS*, while other models predict nonlinear responses to increasing ISI or *ISI~sa~* in various forest stand types. While imprecise, these models are typically accurate within +/- 2–4 m min^-1^, satisfactory for many fire forecasting applications, including designing hazard reduction treatments.

### [Process - get SF data]

```{r label=site.indexes, echo=FALSE, message=FALSE}

#Index numbers for different sites
porters <- filter(fd4, str_detect(fire, "PORTER")) %>% pull(num)
sc <- filter(fd4, str_detect(fire, "PNFI SC")) %>% pull(num) #south corner fire is low dens.
pg.low <- filter(fd4, str_detect(fire, "PRINCE")) %>%
  filter(str_detect(fire, "# 4")) %>% pull(num)   #select shorter stands at PG site only
pg.high <- filter(fd4, str_detect(fire, "PRINCE")) %>% 
  filter(str_detect(fire, "# 1")) %>% pull(num)
kenshoe <- filter(fd4, str_detect(fire, "KENSHOE")) %>% pull(num)
sharp <- filter(fd4, str_detect(ExpProject, "Sharpsand IM")) %>% pull(num)  #original Sharpsand Immature stands only
sharp.th <- filter(fd4, str_detect(ExpProject, "Sharpsand TH")) %>% pull(num)
sharp.sm <- filter(fd4, str_detect(ExpProject, "Sharpsand SM")) %>% pull(num)
rp <- filter(fd4, str_detect(fire, "PNFI RP")) %>% pull(num)
darwin <- filter(fd4, str_detect(fire, "DARWIN")) %>% pull(num)  #1, 2, 6, 7 are  low density plots
darwin.low <- c(66, 67, 90, 91)
bigfish <- filter(fd4, str_detect(fire, "BIG FISH")) %>% pull(num)
icfme <- 77:87 #order is A, 1, 2, 3, 4, 5, 6, 7, 8a, 8b, 9; fixed in icfme process
icfme.hd <- c(77:79, 82:87)  #all but p3, p4
#archer <- 109:117
pelican <- 109:110  #Changed for Mar2023; was 123-124
#fpft <- c(119:122, 125:126)
dewdrop <- filter(fd4, str_detect(ExpProject, 'Dewdrop')) %>% pull(num)

#function to calculate isi.m
isi.mcsa <- function(mcsa, ws) {
  m=mcsa
  f_w= exp(0.05039*ws)
  f_f= (91.9*exp(-0.1386*m))*(1+(m^5.31)/(4.93*10^7))
  return(0.208*f_w*f_f)
}

#surface fires - extract all CFI1==0, calculate isi.m
s.fires <- mutate(rowwise(fd.all), 
                  isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>% #get ISI using MC.SA
  filter(CFI1==0) %>% 
  select(-CFI2) %>%
  mutate(FT=as.factor(case_when(
           str_detect(ExpProject, 'D1') ~ 'Decid',
           str_detect(ExpProject, 'Dewdrop') ~ 'PPDF',
           TRUE ~ 'Con'))
         ) %>%
  ungroup() %>% as.data.frame()
 
#Add FBP database missing VW fires: 2 C4, 2 C5
s.miss0 <- data.frame(num=122:125, 
                      fire=c('PNFI #1 13 yr ONT',
                             'PNFI #2 12 yr ONT',
                             'PNFI RW #1-41-2', 
                             'Carp Lk PNFI WF QC'),
                     CFI1=0, Fire.type='S', 
                     ROS=c(7.6, 4.3, 3, 7.5),
                     SFC=c(1.6, 0.59, 0.3, 0.9), #only 0.59 was meaasured
      #Estimated SFC for 3/4 obs: C4 est: 1.64 (BUI 57); C5 est: 0.28 (BUI 25), 0.85 (BUI 45)
                     CFC=c(0, 1.0, 0, 0), 
                     Date=c('1977-05-19', '1976-08-04', 
                            '1976-05-10', '1963-07-03') %>% ymd(),
      ws=c(19, 10, 18, 25),
      FFMC=c(91.7, 89.9, 90.4, 90.7), 
      ISI=c(14.2, 7, 11.2, 16.7), 
      DMC=c(57, 26, 20, 45), 
      DC=c(107, 276, 86, 81), 
      BUI=c(57, 42, 25, 45), 
      MC.SA_season=c(1, 2, 1, 2), 
      MC.SA_dens=2, 
      MC.SA_stand=4, 
      FT='Con', #all 4 considered pine stands (conifer type)
      ExpProject=c('PNFI (JP)', 'PNFI (JP)', 'PFNI (WRP)', 'PNFI (WRP)')) 

#with ISI.mcsa values for the first two C4 PNFI fires
s.miss <- mutate(rowwise(s.miss0), 
                 MC.SA=wbmc5(FFMC, DMC, MC.SA_stand, 
                             MC.SA_dens, MC.SA_season),
                 isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>%
  as.data.frame() 
  

s.fires2 <- bind_rows(s.fires, s.miss)
```

### [Fit main SF models and PPDF]

```{r label=sROS, echo=FALSE, message=FALSE, warning=FALSE}
#ROS models 

#original ccp (2019) sf formula
sros.st <- function(isi) {
  0.6308 + 0.056*isi + 0.0086*isi^2
}

#Original unaltered conifer SF only - excludes D1, PPDF fires
s.fires.con <- filter(s.fires2, FT=='Con') 

#conifer-only isi.mcsa^2 ROS model
m4.con.lm.mod <- lm(data=s.fires.con, formula=ROS~I(isi.m^2)-1)

#conifer-only ISI^2 model
m3.con.ISI.mod <- lm(data=s.fires.con, formula=ROS~I(ISI^2)-1)
#use for testing fuel type significance


#prediction function for simple lm using isi.m
sf.con.fun <- function(isim) {
  predict(m4.con.lm.mod, newdata=list(isi.m=isim))
}

#Noted - fires with some torching seem to be anomalous
#Exceptions: fires with torching, CFC >1
except <- filter(s.fires, CFC > 0.2 | num==48) %>%
  mutate(FT='Torch')  #using this in fuel type variable for graphs

wildfires <- filter(s.fires2, num %in% c(68, 69, 76,
                                        125, 232)) %>%
  mutate(FT='WF')
#filter out fires with CFC; somewhat anomalous
#first convert all NA CFC values to 0
s.fires3 <- s.fires2 %>% 
  mutate(
    CFC=ifelse(num==48, 0.2, CFC),   #assume R3 torching
    CFC=ifelse(is.na(CFC), 0, CFC)) %>%
            filter(CFC <= 0.2)

#Curing and C7 fires
ppdf <- filter(s.fires3, num %in% dewdrop & !is.na(Grass.Cure))

c7.fullcuring <- 95  #
fc.cf <- gr.cf(c7.fullcuring)

#grass curing function
#0.5 actual ROS plus 0.5 of 'full curing' ROS if it was all grass
#mean(0.67, 0.47, 0.83)
#set SFC p8 to mean above

s.fires.mod0 <- s.fires3 

#fire 8 gets mean SFC from fires close to same time of yr, BUI
s.fires.mod0$SFC[which(str_detect(s.fires.mod0$fire, 'JOHNSON EXP FIRE 8'))] <- 
  sum(0.67, 0.47, 0.83)/3

#Fire 9, Sept. 17
s.fires.mod0$Grass.Cure[
   which(str_detect(s.fires.mod0$fire, 'JOHNSON EXP FIRE 9'))] <- 
   80 #was 85

s.fires.mod <- s.fires.mod0 %>%
  mutate(CF=gr.cf(curing=Grass.Cure),  #calculate curing factor
         ROS=ifelse(is.na(Grass.Cure), ROS,  #obs with no %C are unchanged
            ROS/2+ROS*fc.cf*(1/CF)/2))   
#ROS is half from original, half increased using inverse of curing factor

#So far these models involve - 
# - Cutting out data with CFC > 1
# - 'Detrending' PIPO fires to simulate high grass curing, half
# - including substantial percentage of D1 fires

#linear model using ISI^2
m6.sros.ISI2.mod <- lm(ROS ~ I(ISI^2)-1, data=s.fires.mod)
#r^2=0.7217 with s.fires3
#r^2=0.692 with s.fires.mod

#wind speed squared only
m5.sros.ws2.mod <- lm(ROS ~ I(ws^2)-1, data=s.fires.mod)

#lm using isi.m^2
m8.sros.isim2.mod <- lm(ROS ~ I(isi.m^2)-1, data=s.fires.mod)
#r^2=0.708 with s.fires2
#r^2=0.7605 with s.fires.mod

#lm using isi.m AND SFC - best simple model overall
m9.sros.isim2SFC.mod <- lm(ROS ~ I(isi.m^2) + sqrt(SFC)-1, 
                        data=s.fires.mod)
#r^2=0.75 with s.fires2
#r^2=0.8025 with s.fires.mod
#r^2=0.617 with s.fires.con


#similar model with ISI (sros.ISI2SFC.mod) is also good, but not as good
m7.sros.ISI2SFC.mod <- lm(ROS ~ I(ISI^2) + sqrt(SFC) - 1, 
                       data=s.fires.mod)
#r^2=0.7501

#prediction functions
# sf.lin.fun <- function(ws) {
#   predict(sros.lin.mod, newdata=list(ws=ws))
# }

#nls model and prediction function: ax^b format
m12.sf.axb.isi.mod <- nls(data=s.fires.mod, formula= 
               ROS ~ a * ISI^b, start=list(a=1, b=2))

sf.axbisi.fun <- function(isi) {
  predict(m12.sf.axb.isi.mod, newdata=list(ISI=isi))
}


#fake data for lines - isim2SFC / IsaSFC model; fros1 is at SFC=1.34, fros2 is at SFC=2
#also ISI2SFC model and 
f.sfires0 <- data.frame(fisim=seq(0:30), fsfc1=1.34, fsfc2=2)
f.sfires <-mutate(rowwise(f.sfires0),
              fros1=predict(m9.sros.isim2SFC.mod, 
              newdata=list(isi.m=fisim, SFC=fsfc1)),
              fros2=predict(m9.sros.isim2SFC.mod, 
              newdata=list(isi.m=fisim, SFC=fsfc2)))

#FBP/Van Wagner models:
c6s <- function(isi) {
  ros=30 * (1-exp(-0.08*isi))^3
  return(ros)
}

#vw 1993 surface model for c4 immature pine stands; changed to c4s
#sf.vw93i
c4s <- function(isi) {
 20*(1-exp(-0.2*isi))^5 
}

#vw 1993 surface model for c3 mature pine stands
#sf.vw93m
c3s <- function(isi) {
 15*(1-exp(-0.05*isi))^2 
}

#D1
#sf.d1 
d1 <- function(isi) {
  30*(1-exp(-0.0232*isi))^1.6 
}

#c3 if needed
c3 <- function(isi) {
  110*(1-exp(-0.0444*isi))^3
}


#fit Chapman-Richards function to surface fire data
#This will be prediction model going forward
a.value <- 25 

sf.crisim.mod <- nls(data=s.fires.mod, formula= 
               ROS ~ a.value * (1-exp(-b*isi.m))^c, 
               start=list(b=0.08, c=3))


#just need to make a function from the model
sf.crisim.fun <- function(isim) {
  predict(sf.crisim.mod, newdata=list(isi.m=isim))
}
  
#Using ISI
sf.crisi.mod <-nls(data=s.fires.mod, formula= 
               ROS ~ a.value * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

#CR nls function using ISI
sf.crisi.fun <- function(isi) {
  predict(sf.crisi.mod, newdata=list(ISI=isi)) %>% unname()
}

#Conifer obs only!
###################
#recall con.lm.mod and con.ISI.mod
s.con <- s.fires.mod %>% filter(FT=='Con') #same as s.fires.con

sf.crisiCon.mod <-nls(data=s.con, 
                formula= 
               ROS ~ a.value * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

sf.crisiCon.fun <- function(isi) {
  predict(sf.crisiCon.mod, newdata=list(ISI=isi)) %>% unname()
}

#isi.m
sf.crisimCon.mod <-nls(data=s.con, 
                formula= 
               ROS ~ a.value * (1-exp(-b*isi.m))^c, 
               start=list(b=0.1, c=3))

sf.crisimCon.fun <- function(isim) {
  predict(sf.crisimCon.mod, newdata=list(isi.m=isim)) %>% unname()
}

#test for pine/spruce/other difference
s.con2 <- mutate(s.con, 
                 FT2=str_extract(ExpProject, "\\([^()]*\\)"), #all inside ()
                 FTsp=str_detect(FT2, 'S') %>% as.factor(),
                 FT3=case_when(
                   str_detect(FT2, '/') ~ 's',  #mix of pine /spruce
                   str_detect(FT2, 'S') ~ 's',  #spruce only
                   str_detect(FT2, '(JP)') ~ 'jp',         #jack pine only
                   TRUE ~ 'op') %>% as.factor())  #other pines
                 
#test for sig. of Fuel type factors
con.ft2 <- lm(ROS ~ I(ISI^2) + FTsp -1, data=s.con2) #NS
con.ft3 <- lm(ROS ~ I(ISI^2) + FT3 -1, data=s.con2) 
#FT3 is actually significant, with 'other pine sp' sig. lower ROS than jp
#testing contrast:
#emmeans_output <- emmeans(con.ft3, ~FT3)
#cld(emmeans_output, alpha=0.05, Letters=letters)
#shows op <> jp (op=s and s=jp though)

#summary(update(sros.ISI2SFC.mod, ~ I(ISI^2) + sqrt(SFC) + FT3 - 1, data=s.con2))
#SFC models are NS when applied to conifer-only dataset; Fuel type then also 
#becomes NS (P > 0.05)


#Add function for ISI2SFC and ISI.mSFC models
sf.isi2sfc.fun <- function(isi, sfc) {
  predict(m7.sros.ISI2SFC.mod, newdata=list(ISI=isi, SFC=sfc)) %>% 
    unname()
}

sf.isim2sfc.fun <- function(isim, sfc) {
  predict(m9.sros.isim2SFC.mod, newdata=list(isi.m=isim, 
                                          SFC=sfc)) %>%
    unname()
}

#SFC=0.75
sf.isim2sfc075.fun <- function(isim) {
  sfc_vals=rep(0.75, length(isim))  #required for stat_function
  predict(m9.sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=1.5
sf.isim2sfc15.fun <- function(isim) {
  sfc_vals=rep(1.5, length(isim))  #required for stat_function
  predict(m9.sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=3
sf.isim2sfc3.fun <- function(isim) {
  sfc_vals=rep(3.0, length(isim))  #required for stat_function
  predict(m9.sros.isim2SFC.mod, 
          newdata=list(isi.m=isim, SFC=sfc_vals))
}

#SFC=1.5 with ISI function
sf.isi2sfc15.fun <- function(isi) {
  sfc_vals=rep(1.5, length(isi))  #required for stat_function
  predict(m7.sros.ISI2SFC.mod, 
          newdata=list(ISI=isi, SFC=sfc_vals))
}

#FT model 15 below


#Fernandes sf (Fernandes et al. 2009) model for 
#maritime pine stands based on ws, litter mc, fuel depth
#not clear what height for ws measurements...
sf.fernandes <- function(ws, mc, fd) {
  ROS=0.773*ws^0.707*exp(-0.039*mc)*fd^0.188
  return(ROS)
}

#Add ISI-FT and isim-FT models
# sf.nope <- nls(data=s.fires.mod %>% filter(FT=='Con'), 
#                ROS ~ 0.5*ws^a*exp(-b*MC.SA)^c, 
#                start=list(a=0.7, b=0.1, c=3))  #gives error

#All this stuff to try to do a Tukey test but it's almost all NS anyway
#only sig. difference is between PPDF and other 2 FTs (but screwy because of 
#the 'normalizing' to 95% curing)
s.fires.mod2 <- mutate(s.fires.mod, FT=as.factor(FT))

sf.ft <- lm(ROS ~ I(isi.m^2) + SFC + FT -1, 
              data=s.fires.mod2) #SFC NS
sf.ftim <- lm(ROS ~ I(isi.m^2) + FT-1, 
              data=s.fires.mod2) #SFC NS

m15.sf.ftisi <- lm(ROS ~ ISI * FT -1, 
              data=s.fires.mod2) #linear w/ interaction

sf.ftisi2 <- lm(ROS ~ I(ISI^2) + FT -1, 
              data=s.fires.mod2) #squared, no interaction

sf.ftisi3 <- lm(ROS ~ I(ISI^2) * FT -1, 
              data=s.fires.mod2) #ISI squared, with interaction

#Multiple comparisons - Tukey test
#try 'emmeans' package
# require(emmeans)
# ##require(multcomp) #note - this screws up dplyr::select !!
# 
# emmeans_output <- emmeans(sf.ftisi, ~ FT)
# emmeans_output <- emmeans(sf.ftisi2, ~ FT)

# multcomp::cld(emmeans_output, alpha = 0.05, Letters = letters)
# or
# contrast(emmeans_output, method = "revpairwise", adjust = "tukey")

#FT differences sig. (sf.ftisi only) 


#Consider adding one:
# sf.ftisi  
ft.isi.fun <- function(isi, ft='Con', mod=1) {
  ft_vals=rep(ft, times=length(isi))
  mod_vals=rep(mod, times=length(isi))
  return(case_when(mod==1 
                   ~ predict(m15.sf.ftisi, newdata=list(
                     ISI=isi, FT=ft_vals)),
                   mod==2 
                   ~ predict(sf.ftisi2, newdata=list(
                     ISI=isi, FT=ft_vals)),
                   mod==3
                   ~ predict(sf.ftisi3, newdata=list(
                     ISI=isi, FT=ft_vals))))
  #FT levels: Con, PPDF, Decid
  #mod1: linear; mod2: squared, not inter; mod3: squared, with inter
}

# ft.isi2.fun <- function(isi, ft='Con') {
#   ft_vals=rep(ft, times=length(isi))
#   predict(sf.ftisi2, newdata=list(ISI=isi, FT=ft_vals))
#   #FT levels: Con, PPDF, Decid
# }

#save(sf.ftisi, file='C:/Dan/_Remote_projects/ccp-sROS/files/sf_ftisi.rda')
#save(ft.isi.fun, file='C:/Dan/_Remote_projects/ccp-sROS/files/ftisi_fun.rda')
#write.csv(s.fires.mod, file='C:/Dan/_Remote_projects/ccp-sROS/files/sfires_mod.csv')
#write.csv(s.fires3, file='C:/Dan/_Remote_projects/ccp-sROS/files/sfires3.csv')


```

### [Complex modelling attempts]

```{r fancy modeling attempts, echo=FALSE}

##Then try rpart models
rp.mods <-rpart::rpart(ROS ~ ., data=s.fires.mod %>% 
                  select(ROS, ws, FFMC, ISI, MC.SA, isi.m, SFC, FT),
                  method='anova')
#Hmmm. Tree models. Too complicated to make sense of

#leaps
#first make dataset with squared terms
s.fires.squared <- s.fires.mod %>%
  mutate(ws2=ws^2, 
         ISI2=ISI^2,
         isi.m2=isi.m^2,
         SFC2=SFC^2,
         SFC.sqrt=sqrt(SFC),
#         FT=as.factor(FT),
         MC.SA_dens=as.factor(MC.SA_dens)
         ) %>%
  select(ROS, ws, ws2, FFMC, ISI, ISI2, MC.SA, isi.m, isi.m2, 
         SFC, SFC2, SFC.sqrt, FT, MC.SA_dens, DMC, MC.FFMC)

lp.mods <- leaps::regsubsets(ROS ~ ., 
                             data=s.fires.squared, #force.out='DMC', 
                             nbest=1, nvmax=4)

lp.mods2 <- leaps::regsubsets(ROS ~ ., 
                             data=s.fires.squared,
                             method='exhaustive',
                             nbest=3, nvmax=4, intercept=FALSE)

lp.mods3 <- leaps::regsubsets(ROS ~ ., 
                             data=s.fires.squared, 
                             nbest=4, nvmax=5, 
                             method = 'exhaustive') #,
                            # intercept=FALSE)


#summary(lp.mods)

best2 <- lm(ROS ~ isi.m2+MC.SA_dens -1, data=s.fires.squared)
#density factor is illogical
linisimmod <- lm(ROS ~ isi.m-1, data=s.fires.squared) #linear isi.m
linwsfmmod <- lm(ROS ~ MC.SA + ws -1, data=s.fires.squared) #linear ws, mcSA

isimmod <- lm(ROS~ isi.m2 -1, data=s.fires.squared) #isi.m squared
wsfmmod <- lm(ROS~ MC.SA + ws2 -1, data=s.fires.squared) #ws2 + mcSA

linisi <- lm(ROS ~ ISI-1, data=s.fires.squared) #linear ISI 
linwsffmmod <- lm(ROS ~ ws + MC.FFMC -1, data=s.fires.squared) #lin ws, ffmc

isimod <- lm(ROS ~ ISI2-1, data=s.fires.squared) #ISI squared
wsffmmod <- lm(ROS ~ ws2 + MC.FFMC -1, data=s.fires.squared)  #ws squared and FFMC

wsmod <- lm(ROS ~ ws2-1, data=s.fires.squared)
linws <- lm(ROS ~ ws-1, data=s.fires.squared)

#based on RMSE, ER2, MAE, MAPE:
#ISI_sa2 better than ISI2 model
#ISI_sa better than ISI model

#rcompanion::accuracy(isimmodel)

#linear ISI_sa is better than ws + mcSA
#ISI_sa2 is better than ws2 + mcSA

#ISI2 is not clearly better or worse than ws2 + mcFFMC (ER2 and MAPE better, RMSE and MAE worse)
#linear ISI is not clearly better or worse than ws + mcFFMC (ER2 better, RMSE, MAE and MAPE worse)

#DMC factor was illogical, so excluded
#'exhaustive' search for all var combinations revealed models dominated by isi.m2; alone (1 var), with FFMC (2), with FFMC and ISI(3), or with FFMC, ISI, ws2 (4). Gains compared with isi.m2 model alone are very slight, suggesting overfitting. 


#con dataset
s.fires.cosquared <- s.fires.con %>%
  mutate(ws2=ws^2, 
         ISI2=ISI^2,
         isi.m2=isi.m^2,
         SFC2=SFC^2,
         SFC.sqrt=sqrt(SFC),
         ) %>%
  select(ROS, ws, ws2, FFMC, ISI, ISI2, MC.SA, isi.m, isi.m2, 
         SFC, SFC2, SFC.sqrt, MC.SA_dens, DMC)

lp.mods.con <- leaps::regsubsets(ROS ~ ., 
                        data=s.fires.cosquared, force.out='DMC',
                             nbest=3, nvmax=4, intercept=FALSE)  #DMC was bogus
#DMC estimate again negative, so excluded
#test MC.SA_season factor?

best2c <- lm(ROS ~ ISI2 + ISI -1, data=s.fires.cosquared) #no good

#Density class


```

### [graphs and functions]

```{r label=graphs, echo=FALSE}

fig4 <- ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=isi.m, y=ROS)) +  
  scale_colour_manual(values=c(
    'red2',
    'green3',
    'blue4')) +
  geom_point(aes(colour=FT, size=SFC), alpha=0.5) + #main fires, adj. PPDF
  geom_point(data=s.fires3 %>% filter(!is.na(SFC)) %>% 
               filter(FT=='PPDF'), 
             aes(size=SFC), shape=21, color='darkgray', 
             fill='darkgray', alpha=0.5) + #PPDF original
  geom_point(data=wildfires, colour='black', fill='black', size=1, 
             shape=21) +
#  geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray')+
  stat_function(fun=sf.isim2sfc15.fun, color='purple', 
                linetype='dashed') +
#  stat_function(fun=sf.isim2sfc3.fun, color='red') +
  stat_function(fun=sf.crisim.fun, color='purple') +
  stat_function(fun=sf.crisimCon.fun, colour='pink') +
  theme_classic()
#  stat_function(fun=sf.con.fun, colour='gray') +
  #geom_text(x=28, y=sf.isim2sfc075.fun(28)+3, 
  #          label='IsaSFC') +
  

#fig4

#Graph with vw functions, ISI
fig5 <- ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=ISI, y=ROS)) + 
    scale_colour_manual(values=c(
    'red2',
    'green3',
    'blue4')) +
  geom_point(aes(colour=FT, size=SFC), alpha=0.5) +    
  geom_point(data=s.fires3 %>% filter(FT=='PPDF'), aes(size=SFC), shape=21, size=4, fill='darkgray', alpha=0.5) + #PPDF original
  geom_point(data=wildfires, colour='black', fill='black', size=1, 
             shape=21) + #wildfires
  #geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray') + #IsaSFC model
#  stat_function(fun=sf.axbisi.fun, color='grey') +
  stat_function(fun=c4s, color='turquoise', linetype='dashed') +
  stat_function(fun=c3s, color='purple', linetype='dashed') +
  stat_function(fun=c6s, color='darkred', linetype='dashed') +
   # geom_text(x=21, y=c6s(21)-1, label='C6s') +
  theme_classic()

#fig5

```

## 1. Introduction

The rate of spread (ROS), or rate of forward advance, of a wildfire is probably its most important behaviour characteristic for fire managers [@vanwagner1965; @Sullivan.Gould2020]. Fire spread in Canadian forests is often a story about conifer crown fires, featuring high spread rate and intensity, a rain of lofted embers and few suppression options [@alexander2016]. And yet in the chronology of fire events, most days between ignition and extinction feature only ground or surface fire behaviour [@wang2014]. Surface fires can often be safely and routinely actioned by suppression crews and equipment [@wheatley2022], and managers need to be able to estimate the speed and intensity of fires even when crown fire activity is unlikely.

### Surface fire spread in the Canadian Fire Behavior Prediction System

Surface fire spread models have been incorporated into previous Canadian fire behaviour modelling studies, though they have rarely been the main focus. The present Fire Behavior Prediction (FBP) System features fuel-type specific models encompassing the full range of surface through crown fire behaviour for a small number of distinct conifer fuel complexes [@forestrycanadafiredangergroup1992; @tymstra2010]. Thus, the majority of conifer and mixedwood ROS models do not discriminate between surface and crown fire behaviour but rather assume a gradual transition between fire types – a deliberate decision discussed during the system's development [@vanwagner1989a]. However, a number of more flexible conifer modelling schemes have emerged since then that specify the type of fire predicted under given weather and moisture inputs. These include CFIS (Crown Fire Initiation and Spread), Conifer Pyrometrics, and the promise of dynamic fuels and specific crown fire transition in the forthcoming version of the Canadian FBP System, FBP2025 [@Alexander.etal2006a; @perrakis2020; @cfsfiredangergroup2021]. In the US, the Rothermel surface ROS model [@rothermel1972] has been used operationally for over 40 years [@andrews2018], though its required inputs and US-focus have largely kept it out of operational use in Canada. All of these systems attempt to address the question via empirical or quasi-empirical means [@sullivan2009] of what fire behaviour to expect (ROS, fire intensity, etc.) in a conifer stand when crown fire behaviour is not expected.

We first examine the pure surface fire models in the FBP System for fuel types lacking a flammable overstory: leafless deciduous forests (D-1), open vegetation (i.e. grassland; O-1), and scattered logging slash (S-1 through S-3) [@forestrycanadafiredangergroup1992; @wotton2009]. As with the conifer fuel types, surface ROS (sROS) equations are based on the sigmoidal Chapman-Richards function [@vanwagner1989a]:

$$ROS=a(1-e^{-b\cdot ISI})^c$$ [Eq.1],

with the *a* parameter representing the horizontal asymptote ('levelling off value'), b, and c parameters assigned or fitted from data [@forestrycanadafiredangergroup1992], and *ISI* representing the Initial Spread Index from the Fire Weather System [@vanwagner1987]. Newer surface fire models have also been developed for grass [@wotton2009d; @kidnie2015] and Atlantic shrublands [@Pepin.Wotton2020]. A few older sROS models were previously published based on individual field experiments [e.g., @Lawson1972], but these data were eventually incorporated into the broader-scope FBP fuel type functions.

### CE Van Wagner's surface fire models

As the FBP System was being developed, CE Van Wagner proposed a more flexible theoretical dual equilibrium conifer crown fire model concept. This involved two notional functions for a given conifer stand describing the expected ROS of crown fires, RSC, and "all possible surface fires", RSS [@vanwagner1989a], with the well known crown fire initiation model representing the transition point between the two [@vanwagner1977a]. The RSS function parameters appeared in the FBPS report in the form of the C-6s model, for the surface fire portion of the 'Conifer Plantation' fuel type: *a*=30, *b*=0.080, *c*=3 [@forestrycanadafiredangergroup1992]. Two additional RSS models and parameters were suggested shortly thereafter, associated with surface fire spread in immature and mature jack pine (*Pinus banksiana*) stands in Ontario [@vanwagner1993a]. The immature pine model was associated with experimental observations from what became the C-4 fuel type [@stocks1987b]; "C-4s": *a*=20, *b*=0.20, *c*=5; while a mature pine RSS model was associated with some of the experiments that were later incorporated into the C-3 model [C-3; @stocks1989]; "C-3s": *a*=15, *b*=0.05, *c*=2 [@vanwagner1993a]. No statistics or other source were provided for the origin of these models (C-3s, C-4s, C-6s). Figure 1 compares these RSS functions along with the D-1 and C-3 models for comparison (calculated from [@forestrycanadafiredangergroup1992]).

### [Fig1]

```{r label=Fig1, message=FALSE, echo=FALSE}

fig1 <- ggplot(data=s.fires, aes(x=ISI, y=ROS)) +
  stat_function(fun=c6s, colour='darkred') +
  stat_function(fun=c4s, colour='turquoise') +
  stat_function(fun=c3s, colour='purple') +
  stat_function(fun=d1, colour='green') +
  stat_function(fun=c3, colour='gray') +
  geom_text(x=10, y=c4s(10)+3, label='C-4s') +
  geom_text(x=15, y=c6s(15)-2, label='C-6s') +
  geom_text(x=24, y=d1(24)+1, label='D-1') +
  geom_text(x=22, y=c3s(22)-1, label='C-3s') +
  geom_text(x=20, y=c3(20)+1.5, label='C-3') +
  coord_cartesian(x=c(2, 25), y=c(0, 35)) +
  theme_classic() +
  labs(y='ROS (m/min)')
  

fig1

```

*Caption: Figure 1. Comparison of surface fire rate of spread (ROS) models from the FBP System and associated research; the C-3 model (continuum of surface to crown fire ROS) is included for comparison purposes. The D-1 and C-6s models are a core part of the FBP System. C-4s and C-3s refer to surface fire models proposed by C.E. Van Wagner for immature and mature jack pine fires, respectively. ISI refers to the Initial Spread Index.*

### Objectives

The objective of this study was to use the Canadian database of experimental fires to produce simple empirically-based models for estimating the ROS of surface fires burning beneath the canopy of boreal and sub-boreal forest stands. Such models can be incorporated into dynamic fire behaviour predictions systems, where surface fire, crown fire initiation, and crown fire spread are modelled as separate but related processes [@scott2001; @perrakis2020; @cfsfiredangergroup2021].

It has long been known that wind speed near the affected fuel is one of the most important predictors of ROS [e.g., @vanwagner1968; @catchpole1998; @rothermel1972]. However, beneath a forest canopy, predicting wind speed at the microclimate level involves detailed studies of wind interactions with fuel structure, including edge effects [@moon2019; @schlegel2015] as well as the influence of subcanopy vegetation. Although this approach has been used in the US and elsewhere, it demands a fine-scale landscape wind-vegetation analysis which is seldom available for Canadian forest types. The present models therefore rely only on the standard 10 m open wind speed, as was measured in field experiments and is typically used for wildfire weather forecasts [@lawson2008]. This is appropriate for operational use, but means that model predictions are expected to be noisy when applied across the spectrum of forest structure and density due to the effects of edges and openings on moisture and ground-level winds [@chen1999; @ma2010].

## 2. Methods

### Fire database

The source data for these analyses is a slowly growing database of field-scale experimental burns conducted at various sites across Canada since the 1960s. Most of these data have previously been described and analyzed [e.g. @alexander1990; @cruz1999a; @perrakis2023], but never before for the purpose of developing generalized surface fire models. Over 120 observations of fire behaviour in boreal and sub-boreal conifer experimental burns were conducted in stands of \~0.1-4.0 ha (median size: 0.4 ha), including both surface and crown fires. In addition to the conifer data, 39 additional experimental surface fire observations were available in other forest types and provide additional insight for general sub-canopy fires. These include fires in deciduous forests, originally described by Alexander and Sando [@alexander1989a], featuring 6 fires from northeastern US stands of trembling aspen (*Populus tremuloides*); 14 fires in aspen near Hondo, Alberta [@quintilio1991]; and aspen (9), oak (*Quercus* sp.) (2), and aspen-dominated mixedwood (1) fires at Petawawa, Ontario [@vanwagner1973]. Finally, seven experimental surface fires in Ponderosa pine (*P. ponderosa*) - Douglas-fir (*Pseudotsuga menziesii*) stands (PPDF) in British Columbia were also included [@nyberg1979], analyzed uniquely to simulate a fully cured grass condition, as discussed below. This generated a full database of `r nrow(fd.all)` observations, of which `r nrow(fd.all %>% filter(CFI1==0))` were surface fires, as described in primary sources, though with some nuances involving partial torching trees and partial crown involvement discussed below.

### Modelling and spread indices

Consistent with longstanding theoretical understanding of fire processes [@curry1940; @vanwagner1968; @campbell-lochrie2021] and the majority of existing empirical models [@fernandes2009; @sullivan2009], we anticipated that wind speed and dead fuel moisture content would be primary variables of interest. In particular, the aforementioned unitless *ISI* that combines empirical functions representing wind speed and fuel moisture influences [@vanwagner1987] was already the main independent variable used for predicting ROS in the FBP System [@forestrycanadafiredangergroup1992]. Other variables we examined for significance included moisture indices from the FWI System (the Fine Fuel Moisture Code, FFMC, and Duff Moisture Code, DMC), and surface fuel consumption (SFC), which must be estimated or modelled separately for prediction purposes. Fuel type was tested in the full aggregated dataset between conifer, deciduous/mixedwood, and PPDF categories. In the boreal conifer data subset, the lone surface fire observation in black spruce was grouped with five observations in mixed jack pine- black spruce in order to separate spruce-containing observations (S) from the pine and PPDF fires.

In addition to the basic ISI, we also explored a modification using a more flexible fuel moisture model, the stand-adjusted moisture content (*mc~sa~*) model of Wotton and Beverly [@wotton2007; @perrakis2023]. The *mc~sa~* combines the effects of the FFMC and DMC indices along with categorical stand type, density, and season variables for directly predicting the moisture content of dead litter. The *mc~sa~* was combined with wind speed using the identical formula as originally described for the ISI, but with the *mc~sa~* in place of *m*, the simple FFMC-based estimate for dead fuel moisture [@vanwagner1987]. The full *ISI~sa~* equation is provided here for completeness:

$$ ISI_{sa}=0.208\cdot (e^{0.05039\cdot WS_{10}}) \cdot (91.9 \cdot e^{-0.1386\cdot mc_{sa}}) \cdot \left[ 1+\frac{mc_{sa}^{~~~5.31}}{(4.93\cdot 10^7)}) \right]  $$ [Eq.2].

For model feature selection, we tested all combinations of predictors: *WS~10~*, *FFMC*, *mc~sa~*, *DMC*, *ISI*, *ISI~sa~*, *SFC*, fuel type, and stand density class ('light', 'moderate', and 'dense' classes, as defined by [@wotton2007]), as well as transformed terms: *WS~10~*^2^, *ISI^2^*, *ISI~sa~^2^*, *SFC^2^*, and *sqrt(SFC)*. All variable combinations (1-4 predictors) were tested using the 'leaps' package in R [@lumley2024]. After confirming the predictive value of ISI (see Results, below), we also tested two types of non-linear responses. The first was the simple nonlinear $a \cdot ISI ^{b}$ form. The second used a modification of the sigmoidal Chapman-Richards form previously described (eq. [1]). The horizontal asymptote, *a*, was replaced with a linear function, $y=m \cdot ISI+i$ [Eq.3], with *m* and *i* being assigned or fitted slope and y-intercept parameters, respectively. At high ISI values, ROS therefore approaches the value of *y*:

$$
ROS=(m \cdot ISI + i) \cdot (1-e^{-b \cdot ISI})^c
$$

[Eq.4].

This is believed to be more realistic for representing subcanopy ROS under more severe (drier, windier) conditions compared with the fixed asymptote value in the original function (eq. [1]).

Potential fitted models were compared using common evaluation metrics for linear and non-linear models: root mean squared error (RMSE), mean absolute error (MAE), mean absolute percentage error (MAPE), and Ephron's pseudo-r squared (ER2). ER2 is a measure that is appropriate for comparing the variability captured by a models when widely-divergent linear, non-linear, and forced-intercept models are being compared [@Mangiafico2015].

There were many observations at lower fire danger (i.e., ISI) levels and relatively fewer associated with higher wind and lower moisture conditions (ISI \> \~10); while this was not surprising for a dataset of conifer surface fires (most high-ISI fires were crown fires), it meant that a small number of high-ISI observations were disproportionally influential and there was insufficient data for independent validation. All analyses were performed in RStudio 2024.04 (Posit Software, Boston, MA, USA) with R version 4.2.1.

### Grass curing in Ponderosa Pine fires

For the PPDF fires, we sought to incorporate the effects of understory grass and herbaceous curing effects, as graminoids represent an important part of the understory fuelbed in these forests [@ducherer2009; @ducherer2013]. Since a predictive model incorporating the degree of curing (C) would require much more data, we estimated how fire spread in these stands under peak seasonal conditions based on certain assumptions from known grassland fire spread mechanisms. We first normalized all observations, following Cheney [@cheney1995], to a nearly fully cured grass condition (95% C) in order to represent early spring or late summer conditions associated with high fire danger. Although the grass biomass in these stands only represented a fraction (\~3 %) of the total available surface fuel [@nyberg1979], grass curing has been observed by operational practitioners to have a strong influence on ROS [@beck2003]. We assumed that understory grass and forb curing in these pine-Douglas-fir stands would be half as influential compared to curing influence in a true grassland, due to the larger portions of the litter load from needles and woody debris [@nyberg1979]. We therefore calculated new 95% C estimated ROS (*ROS'*) values for these plots as follows:

$$ ROS'=\frac {ROS_0}{2} \cdot \left[ {1 + \frac {cf(95)} {cf(C)}} \right]  $$

[Eq.5], where *ROS~0~* represents the observed rate of spread with measured curing *C* (see Appendix A), and *cf(C)* and *cf(95)* represent the calculated curing factors [@wotton2009] at measured % C values and 95% C, respectively. *ROS'* values for these seven PPDF fires were then used in model fitting.

## 4. Results

### Initial data exploration and model building

Simple inspection of surface and crown fires in our database revealed certain obvious patterns. Among `r nrow(fd.all)-nrow(d1)` fires, a clear, though noisy linear relationship is evident between ROS and wind speed that differs by type of fire behaviour: surface, passive crown, and active crown fires (Fig. 2).

### [Fig 2 simple ROS graph by fire type and eval for m25 and FBP mods]

```{r label=Fig2, message=FALSE, echo=FALSE, warning=FALSE}
#Call all 'midstory passive crown fires' surface fires if
#CFC is less than 0.1
fd.ros0 <- mutate(fd4,
                 FiT2=case_when(
                   Fire.type=='PCM' & CFC < 0.1 ~ 'S',
                   Fire.type=='PCM' & CFC >= 0.1 ~ 'PC',
                   TRUE ~ Fire.type)) %>%
  select(num, fire, ws, ROS, ISI, SFC, FiT2)
  
fd.ros1 <- bind_rows(
  fd.ros0, s.miss %>% select(num, fire, ws, 
                        ROS, ISI, SFC, FiT2=Fire.type))

#remove wildfires - don't do this
fd.ros <- fd.ros1 
#%>%
#  filter(!num %in% c(68, 69, 76, 125))

#25% rule?
m25 <- function(x) {0.25*x}

fig2 <-ggplot(fd.ros, aes(x=ws, y=ROS, colour=FiT2))+
  geom_point(alpha=0.7)+
  xlim(0, 35)+
  stat_function(fun= m25, colour='black') +
  scale_colour_manual(values=c('red', 'orange', 'green')) +
  geom_smooth(method='lm', se=FALSE, level=0.95) +
  theme_bw() +
  labs(x='WS (km/h)', y='ROS (m/min)', colour='Type of fire') +
  theme(legend.position=c(0.1, 0.8)) +
  theme(legend.background=element_rect(fill='white', colour='black'))


#simple linear sROS model from graph:
m1.sf.lin.ws <- lm(ROS ~ ws, data=fd.ros %>% filter(FiT2=='S'))

```

```{r label=m.25percent, echo=FALSE }

#get predictions for assigned function models:
#At this point, 65 obs from boreal conifer looks good
df.funs <- s.con %>%
#  fd.ros %>% filter(FiT2=='S') %>% 
  select(fire, ws, ISI, ROS) %>% 
  filter(!str_detect(fire, 'DEWDROP')) %>%
  mutate(num=row_number(),
         c3s = c3s(ISI),
         c4s=c4s(ISI),
         c6s=c6s(ISI),
         d1=d1(ISI),
         m25 = m25(ws)) %>%
  select(-c(fire, ws, ISI)) %>% select(num, everything()) #num then everything else


#spread data out for easy summarizing - used in Table 1
df.funs.longer <- tidyr::pivot_longer(df.funs, 
                                      cols=c(ROS, c3s, c4s, c6s, d1, m25), 
                                      names_to='model', values_to='value')

fig2
```

*Caption: Figure 2. Overview of experimental burn observations by wind speed (WS), rate of spread (ROS) and type of fire showing simple linear trends. S, PC, and AC refer to surface, passive crown, and active crown fire behaviour types, respectively. The black line represents the '25 % model' for surface fire behaviour: ROS=0.25 \* WS (ROS in m/min; WS in km/h).*

Surface fire ROS in conifer stands ranged from `r min(fd.ros$ROS)` – `r max(fd.ros %>% filter(FiT2=='S') %>% pull(ROS))` m min^-1^, with most fires' sROS values well below the maximum value (95th percentile sROS of `r quantile(filter(fd.ros, FiT2=='S')$ROS, 0.95)` m min^-1^.). Surface and passive crown fire observations overlapped for ROS \> \~4 m min^-1^. The fitted linear trend shown in Fig 2 (green line) represents a very simple baseline linear surface ROS model for conifer observations (Model 1, n= `r fd.ros %>% filter(FiT2=='S') %>% nrow()` ; adjusted *R^2^* = 0.319), with a slope of 0.2459. We note that this is quite close to a slope of 0.25, a potential model ('25%WS') forced through the intercept conducive to rapid mental calculation based on wind speed alone.

### Model evaluation and selection

The extensive search revealed *ISI* and *ISI~sa~* to be strong predictors of ROS, as expected. The best 1-4 variable sROS predictor combinations all contained one of these variables as linear or squared terms (Appendix B). These were forced through the origin due to the known lack of fire spread potential during low wind and high moisture conditions (e.g. ISI \< 2) and in order to produce models usable across a broad range of wildfire conditions (i.e., *ISI* or *ISI~sa~* values of 0–20 or higher). In particular, *ISI^2^* or *ISI~sa~^2^* were the best single predictors, with *ISI^2^* slightly superior using the conifer-only dataset and *ISI~sa~^2^* best using the aggregated forest types dataset.

In addition to evaluation statistics, we chose the most promising final models based on variable significance, known properties of weather and fuel with respect to fire, and operational simplicity for users. After the initial run with all variable predictors, terms that did not appear in any of the best 3 combinations were dropped. Certain predictor combinations were also rejected for illogical behaviour, though the significance of these relationships suggests further study (Appendix B).

Figure 3 shows the ROS of surface fires classified by fuel type (FT) and surface fuel consumption level, displayed by ISI value, along with a few simple fitted models and the D-1 FBP model. While all fires were initially classed as surface fires, several observations appeared anomalous, particularly those with significant levels of canopy fuel consumption (CFC), suggesting canopy fuel involvement. Fires with estimated CFC \> 0.2 kg m^-2^ (mean CFC: 0.35 kg m^-2^; Fig. 3) were then removed from the dataset as they appeared to include extensive torching of canopy trees and were considered transitional to crown fire. Figure 3 also shows a linear sROS model based on *ISI* (Model 2: RMSE=1.53; ER2=0.469), as well as the better-fitting model forced through the origin using *ISI^2^* (Model 3: RMSE=; ER2=0.613).

### [Prep for fig3]

```{r label=PrepFig3, echo=FALSE}
#Show data, exceptions (CFC >0.1), PPDF orig. 
s.fires4 <- s.fires3 %>%
  mutate(
                 FT2=str_extract(ExpProject, "\\([^()]*\\)"), #all inside ()
                 FTsp=str_detect(FT2, 'S') %>% as.factor(), #T/F spruce
                 FT3=case_when(
                   str_detect(FT2, '/') ~ '2. S',  #mix of pine /spruce
                   str_detect(FT2, 'S') ~ '2. S',  #spruce only
                   str_detect(FT2, '(JP)') ~ '1. JP',         #jack pine only
                   str_detect(FT2, 'PPDF') ~ '5. PPDF',  #dewdrop ppdf
                   str_detect(FT2, 'D1') ~ '4. Decid', #D1 stands
                   str_detect(FT2, 'P') ~ '3. OP') %>% #should cover other pines
    as.factor())


#asymtote function - not used; see 'slope asymptote' section below
# asym <- function(isi) {
#   0.33333*isi #ROS 10 at ISI 30
# }

```

### [slope asymtote CR models]

```{r label=slopeAsymtote, echo=FALSE}

#make asymtote as linear function
#For aggregate 'level off' (CR) model, Should cross ROS=20 at around ISI=65
#very similar to current sf.crisi.fun(65)
#combine that with a shallow slope, say 0.15
asy.slope1 <- 0.15 #m
asy.yInt1 <- 10 #i

asym1 <- function(isi) {
  asy.slope1*isi +asy.yInt1
}

# New Aggregate CR equation with slope asymptote
m10.sf.agg.asy<- nls(data=s.fires.mod, formula= #substitute for sf.crisi.mod
               ROS ~ (asy.slope1 * ISI + asy.yInt1) * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3))

#fitted asymptote?
sf.agg.asyfit<- nls(data=s.fires.mod, formula= #substitute for sf.crisi.mod
               ROS ~ (m1 * ISI + asy.yInt1) * (1-exp(-b*ISI))^c, 
               start=list(b=0.1, c=3, m1=0.15))
##fitted m and i didn't converge; fitted m1 gave NS model, with m1=~0.22


sf.asy.fun <- function(isi) {  #substitute for sf.crisi.fun; M10
  predict(m10.sf.agg.asy, newdata=list(ISI=isi))
}

#exploratory graph to show that this works - asymptote graph, aggregate data, ISI
ag <- ggplot(s.fires4, aes(x=ISI, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asy.fun, xlim=c(0, 70), colour='green') + 
  stat_function(fun=sf.crisi.fun, xlim=c(0, 70), colour='black') +
  stat_function(fun=asym1, xlim=c(0, 70), colour='blue') +
  coord_cartesian(ylim=c(0, 25))

#yessss!!

#Conifer, ISI
#For start, use same asymptote as Aggregate model- no, shift upwards a bit
asy.slope2 <-0.15
asy.yInt2 <-13

#New Conifer model with slope asymptote
m13.sf.con.asy <-nls(data=s.con, formula=
                 ROS ~ (asy.slope2 * ISI + asy.yInt2) * (1-exp(-b*ISI))^c,
                 start=list(b=0.1, c=3))

#fitted asymptote?
# sf.con.asyfit <-nls(data=s.con, formula=
#                  ROS ~ (asy.slope2 * ISI + i2) * (1-exp(-b*ISI))^c,
#                  start=list(b=0.1, c=3, i2=13))
#did not converge/infinity produced

#prediction function
sf.asyCon.fun <- function(isi) {  #substitute for sf.crisiCon.fun; M13
  predict(m13.sf.con.asy, newdata=list(ISI=isi))
}

asym2 <- function(isi) {
  asy.slope2*isi +asy.yInt2
}

#Exploratory asymptote graph
ag2 <- ggplot(s.con, aes(x=ISI, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asyCon.fun, xlim=c(0, 70), colour='green4') + 
  stat_function(fun=sf.crisiCon.fun, xlim=c(0, 70), colour='gray4') +
  stat_function(fun=asym2, xlim=c(0, 70), colour='blue') +
  coord_cartesian(ylim=c(0, 25))

#ISI.mcsa - Aggregate; same asymptote to start with
asy.slope3 <- 0.15
asy.yInt3 <- 10

asym3 <- function(isi.m) {
  asy.slope3*isi.m +asy.yInt3
}

# New Aggregate CR equation with slope asymptote
m11.sf.aggM.asy<- nls(data=s.fires.mod, formula= #substitute for sf.crisim.mod
               ROS ~ (asy.slope3 * isi.m + asy.yInt3) * (1-exp(-b*isi.m))^c, 
               start=list(b=0.1, c=3))

#fitted asymptote?
# sf.aggM.asyfit<- nls(data=s.fires.mod, formula= #substitute for sf.crisim.mod
#                ROS ~ (asy.slope3 * isi.m + i3) * (1-exp(-b*isi.m))^c, 
#                start=list(b=0.1, c=3, i3=10))
#did not converge/infitity produced when fitting m3 or i3

sf.asyM.fun <- function(isi.m) {  #substitute for sf.crisi.fun; M10
  predict(m11.sf.aggM.asy, newdata=list(isi.m=isi.m))
}

ag3 <- ggplot(s.fires4, aes(x=isi.m, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asyM.fun, xlim=c(0, 70), colour='green4') + 
  stat_function(fun=sf.crisim.fun, xlim=c(0, 70), colour='gray6') +
  stat_function(fun=asym3, xlim=c(0, 70), colour='blue3') +
  coord_cartesian(ylim=c(0, 30))


#ISI.mcsa - Conifer
asy.slope4 <-0.15
asy.yInt4 <-13

#New Conifer model with slope asymptote
m14.sf.conM.asy <-nls(data=s.con, formula=
                 ROS ~ (asy.slope4 * isi.m + asy.yInt4) * (1-exp(-b*isi.m))^c,
                 start=list(b=0.1, c=3))

#prediction function
sf.asyMCon.fun <- function(isi.m) {  #substitute for sf.crisiCon.fun; M13
  predict(m14.sf.conM.asy, newdata=list(isi.m=isi.m))
}

asym4 <- function(isi.m) {
  asy.slope4*isi.m +asy.yInt4
}

#Exploratory asymptote graph
ag4 <- ggplot(s.con, aes(x=isi.m, y=ROS)) + 
  geom_point() + 
  stat_function(fun=sf.asyMCon.fun, xlim=c(0, 70), colour='turquoise') + 
  stat_function(fun=sf.crisimCon.fun, xlim=c(0, 70), colour='gray5') +
  stat_function(fun=asym4, xlim=c(0, 70), colour='purple') +
  coord_cartesian(ylim=c(0, 30))

#new models to replace old CR (fixed asymptote mods):
#sf.agg.asy - aggregate, ISI
#sf.con.asy - conifer, ISI
#sf.aggM.asy - aggregate, isi.m
#sf.ConM.asy - conifer, isi.m

```

### [Fig3]

```{r label=Fig3, echo=FALSE}

Fig3 <- ggplot(s.fires4 %>% 
                 filter(!is.na(SFC)), 
       aes(x=ISI, y=ROS)) +  
  scale_colour_manual(values=c(
    'red3',
    'orange2',
    'yellow3', 
    'darkgreen',
    'turquoise4',
    'darkorchid4')) +
  geom_point(aes(colour=FT3, size=SFC), alpha=0.6) + #main fires    
  geom_point(data=except, aes(colour=FT, size=SFC), shape=22) + #torching
  geom_point(data=wildfires, colour='black', fill='black', size=1, 
             shape=21) + #wildfires
#  geom_point(data=ppdf, aes(size=SFC), shape=21) +
  stat_smooth(data=s.fires.con, method=lm, formula=y~I(x^2)-1, 
              se=FALSE, colour='black') + #same as sros.isi2.mod   
  stat_smooth(data=s.fires.con, method=lm, 
              formula=y~x, se=FALSE, colour='gray') + #linear fit
  stat_function(fun=d1, colour='green3', linewidth=1) +
  coord_cartesian(xlim=c(0, 30), ylim=c(0, 17)) +
  theme_bw() +
  scale_y_continuous(breaks=seq(0, 16, by=4),
                     minor_breaks=seq(0, 16, by=2)) +
  scale_x_continuous(breaks=seq(0, 30, by=5)) +
  guides(colour=guide_legend(order=1),
         size=guide_legend(order=2)) +
  theme(legend.position =  'inside', legend.position.inside= 
          c(0.02, 0.7),
        legend.justification = c(0, 0.5),
        legend.box = 'horizontal',
        legend.background = element_rect(fill='grey85')) +
  labs(y='ROS (m/min)', colour='Fuel Type & Torching')
  
  
Fig3


m2.sf.lin.isi <- lm(ROS~ISI, data=s.fires.con)
#linear ISI model like in graph



```

*Caption: Figure 3. Fire observations showing rate of spread (ROS) by ISI. Most symbols represent experimental fires except those with a black centre are wildfires. Colours indicate fuel type and fire characteristics as follows: JP: jack pine; S: black spruce or pine-spruce mix; OP: other pine; Decid: deciduous; PPDF: ponderosa pine-Douglas-fir; Torch: torching or passive crown fire behaviour (removed from surface model analysis). Size indicates relative surface fuel consumption (SFC, kg m^-2^). The lines represent linear (Model 2: gray) and squared (Model 3: black) ISI models fitted to conifer observations (JP, S, OP), along with the FBP D-1 model (green).*

### [DewdropWFC]

```{r label=DewdropLargeWFC, echo=FALSE, warnings=FALSE}
#difference between Stocks' sites and Dewdrop:
stockssfc <- filter(fd.all, num %in% c(sharp, kenshoe)) %>%
  filter(num !=40 & num !=24) %>% pull(SFC)

stocks.lwfc <- c(
0.049,
0.042,
0.086,
0,
0.047,
0.01,
0,
0,
0.231,
0.045,
0.074,
0.132, #end Kenshoe
  0.037,
0.024,
0.047,
0.085,
0.259,
0.153,
0.345,
#0.345,  #no duplicating p11
0.34,
0.374,
0.488,
0.061,
0.223  #end sharpsand
)

#large WFC proportion
stocks.prop <- stocks.lwfc/stockssfc

#Dewdrop burns - need to add 
dewdrop.lwfc <- c(
1.139,
0.061,
0.681,
1.545,
0.693,
2.188,
3.892
)

dewdropsfc <- filter(fd.all, num %in% dewdrop) %>%
  filter(num !=120)  %>% #filter out 1980 burn, no info
  pull(SFC) + dewdrop.lwfc

#large wfc proportion
dewdrop.prop <- dewdrop.lwfc/dewdropsfc

#Wilcoxon rank-sum test (Mann-Whitney U-test)
prop.data <- data.frame(LWFC.prop=c(
  stocks.prop, dewdrop.prop),
            site=as.factor(
            c(rep(1, times=length(stocks.prop)),
              rep(2, times=length(dewdrop.prop)))))
                        
# wilcox.result <- prop.data %>%
  # with(wilcox.test(LWFC.prop ~ site)) 
# W=9, p-value=0.0004296
                                       
                                       
```

In addition to *ISI*/*ISI~sa~*, conifer fuel type (FT) was also a significant predictor, in both the aggregate and conifer datasets. FT differences in the aggregate data were significant between all contrasts of conifer, deciduous, and PPDF fuels (Tukey HSD: α=0.05), with deciduous \< conifer \< PPDF in terms of main effects model ROS classes. Within the conifer dataset, FT was defined differently: in addition to 6 spruce observations, there were 19 fires in jack pine (JP), and 26 in stands dominated by other pine species (OP), primarily red pine (*P. resinosa*). From the conifer dataset, the only significant contrast was between OP and JP, with OP fires exhibiting slightly slower ROS compared with JP fires (Fig. 3).

While SFC did not initially stand out as significant, it was explored further due to its perceived usefulness. The best combinations appeared to be with the sqrt(SFC) predictor together with *ISI^2^* or *ISI~sa~^2^*. Most model forms using \> 2 predictors were non-significant (α=0.05) owing to the modest sample size and high variability. Density class was initially flagged as potentially significant, but was then dropped due to confounding behaviour with the *ISI~sa~* (Appendix C).

### [Table 1: Model summary]

```{r ModSumTable, echo=FALSE, warning=FALSE}
#Model list

#New CR replacements
#sf.agg.asy - aggregate, ISI
#sf.con.asy - conifer, ISI
#sf.aggM.asy - aggregate, isi.m
#sf.ConM.asy - conifer, isi.m


#add sros.st, 
mod.list.long <- list(m1.sf.lin.ws, #m1
              m2.sf.lin.isi, #m2
              m3.con.ISI.mod, #m3
              m4.con.lm.mod, #m4
              m5.sros.ws2.mod, #m5
              m6.sros.ISI2.mod, #m6
              m7.sros.ISI2SFC.mod, #m7
              m8.sros.isim2.mod, #m8
              m9.sros.isim2SFC.mod, #m9
              m10.sf.agg.asy,  #slope asymptote model, aggregate ISI
        #      sf.crisi.mod,
              m11.sf.aggM.asy, #slope asymptote for aggregate, isi.m
        #      sf.crisim.mod,  #
              m12.sf.axb.isi.mod, 
              m13.sf.con.asy, #slope asymptote, conifer ISI
        #      sf.crisiCon.mod,
              m14.sf.conM.asy, #slope asymptote, conifer isi.m     
        #      sf.crisimCon.mod, #
              m15.sf.ftisi,
              c3s,
              c4s, 
              c6s,
              d1,
              m25)

modnames <-c('wslin.con',
             'isilin.con',
             'ISI2.con',
              'isim2.con',
              'WS2.agg',
              'ISI2.agg',
              'ISI2SFC.agg',
              'isim2.agg',
              'isim2SFC.agg',
              'crisi.asy.agg', #replaces crisi.agg
              'crisim.asy.agg', #replaces crisim.agg
              'axb.isi.agg',
              'crisi.asy.con',  #replaces crisi.con
              'crisim.asy.con', #replaces crisim.con
             'ftisi',
             'c3s', 'c4s', 'c6s', 'd1', '25 perc') #last 5 are functions

#models only (not functions)
mod.list <- mod.list.long[1:(length(mod.list.long)-5)]

#formulae from model list
formulae0 <- lapply(mod.list, FUN=formula) %>% 
  as.character() %>%
  str_extract(pattern="~(.*)") %>% #keep everything right of the tilde
  str_remove('~ ') 

#edit formula strings
process_string <- function(s) {
  if (str_ends(s, "- 1")) { # Remove "- 1" from the end
    return(str_remove(s, "- 1$"))
  } else {
    if(str_ends(s, '\\^c') | str_ends(s, '\\^b'))
       {return(s)} else {
    return(str_c("b0 +", s))      # Add "b0 +" to the beginning
  }}
}

formulae <- sapply(formulae0, process_string) %>% unname() %>%
   #get ride of the tilde
  append(c(  #add the manual and Van Wagner models at the end
    'C-3s', #c3s
    'C-4s', #c4s
    'C-6s', #c6s
    'D-1', #d1
    '25 % WS_10')) %>% #m25 model
  str_replace_all('I\\(ISI\\^2\\)', 'ISI2') %>%  #clean up squared terms
  str_replace_all('I\\(isi.m\\^2\\)', 'ISIsa2') %>%
  str_replace_all('I\\(ws\\^2\\)', 'WS2') %>%
  str_replace_all('\\(asy[^)]*\\)', 'SlAsy') %>%
  # str_replace_all('a.value', str_c('Asy', as.character(a.value))) %>%
  # str_replace('b0 \\+Sl', 'Sl') %>% #fix extraneous  b0 term for m12
  str_replace_all('isi.m', 'ISIsa')

#generate table of evaluation metrics
#MAE, MAPE, MSE
acc.table2 <- rcompanion::accuracy(mod.list) %>% 
  as.data.frame() %>%
  mutate(num=1:length(mod.list))

#get AIC, num of obs - repeat glance function across all models
acc.glance <- lapply(mod.list, broom::glance)

#pull nobs and AIC from glance operation
acc.glance2 <- lapply(acc.glance, `[`, c('nobs', 'AIC' )) %>%
  list_rbind() %>% round(1) %>%
  mutate(num=1:length(acc.glance))

#metrics for pre-determined model functions:
#mae.manual(actual=df.m25$ROS, pred=df.m25$pred25) # etc.
load(file='./files/mae.rda')
load(file='./files/mape.rda')
load(file='./files/Efr2.rda')

#calculate some metrics for m25 and the FBP model functions:
#FBP/VW models
df.eval <- df.funs.longer %>% group_by(model) %>%
    summarize(MAE=mae.manual(actual=df.funs$ROS, pred=value) %>% round(2),
              MAPE=mape.manual(actual=df.funs$ROS, pred=value) %>% round(2),
              ER2=ef.r.squared(actual=df.funs$ROS, pred=value) %>% round(2)
              ) %>%
  filter(model != 'ROS') %>%
  mutate(num=(length(mod.list)+1):(length(mod.list)+5),nobs=NA, RMSE=NA) %>%
  rename(Model=model)

#combine the two column groups, two evaluation tables, clean up
acc.table3 <- left_join(acc.glance2, acc.table2, 
                        by='num') %>%
  mutate(Model=modnames[1:(length(modnames)-5)]) %>%
  rename(MAE=Fit.criteria.MAE,
         MAPE=Fit.criteria.MAPE,
         RMSE=Fit.criteria.RMSE,
         ER2=Fit.criteria.Efron.r.squared
        ) %>%
  select(num, Model, nobs, RMSE, MAE, MAPE, ER2, AIC) %>%
  #add FBP and m25 metrics
  bind_rows(df.eval)

#ROS table at ISI (ISIm)=5, 10, 15
isi.vals=c(5, 10, 15)
ffmc.val=91
ws.vals=c(1, 14, 22)
mod.order.isim<- c(1, 4, 7, 10)

#create blank list
pred.list <- vector('list', length(mod.list))
names(pred.list) <- modnames[1:(length(modnames)-5)]

for (i in seq_along(mod.list)) {  #predict all mods in mod.list
  pred.list[[i]] <- predict(mod.list[[i]], 
                            newdata=
                              data.frame(ISI=isi.vals,
                                        isi.m=isi.vals,
                                        FFMC=ffmc.val,
                                        ws=ws.vals,
                                        SFC=1.5,
                                        FT='Con'))
}

pred.df <- data.frame(ISI=isi.vals, pred.list) %>%
  mutate_all(round, 1)

#transpose
pred2.df <- as.matrix(pred.df) %>% 
  t() %>% as.data.frame() %>%
  mutate(Model=colnames(pred.df)) %>%
  slice(2:ncol(pred.df)) %>%
  select(Model, everything())

row.names(pred2.df) <- NULL
isi.colnames <- c('ISI=5', 'ISI=10', 'ISI=15' ) 
colnames(pred2.df)[2:4] <- isi.colnames

#get c6, c4s, c3s d1 predictions
#ws vals at FFMC 91: 0.2162, 13.972, 22.019
ws.vals <- c(0.2162, 13.972, 22.019)

#predict ROS at 5, 10, 15 for FBP models, 25% model
v1 <- c3s(isi.vals)
v2 <- c4s(isi.vals)
v3 <- c6s(isi.vals)
v4 <- d1(isi.vals)
v5 <- m25(ws.vals)

#transpose
v15vals <- data.frame(v1, v2, v3, v4, v5) %>%
  as.matrix %>% t() %>%
  as.data.frame()

#A lot of effort to make a table of predictions at 3 values, but it works
predAdd.df <- data.frame(Model=df.eval$Model, 
                         ISI.5=v15vals[,1] %>% round(1),
                         ISI.10=v15vals[,2] %>% round(1),
                         ISI.15=v15vals[,3] %>% round(1))
colnames(predAdd.df) <- c('Model', isi.colnames)

#combine sROS models, FBP models
pred3.df <- rbind(pred2.df, predAdd.df)

acc.tab4 <- left_join(pred3.df, acc.table3, by='Model') %>%
  mutate(Num=1:max(nrow(pred3.df), nrow(acc.table3)),
         Formula=formulae) %>%
  select(Num, Model, Formula, N=nobs, everything(), -num)

######################
#write.csv(acc.tab4, 'acc_table.csv')

#acc.tab4

#generate formatted table using gt
require(gt)

acc.tab4 %>% select(-Model) %>%
  #mutate(Formula = if_else(row_number() <= 9, 
  #                         map_chr(Formula, format_formula), 
  #                         Formula)) %>%
  gt() %>%
  tab_header(
    title = "Table 1" #,
#    subtitle = "Your subtitle (if needed)"
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  cols_width(
    Num ~ px(50),
    Formula ~ px(100),
    everything() ~ px(60)
  ) %>%
  tab_spanner(
    label='Predicted ROS (m/min)',
    columns=4:6
  ) %>%
  tab_spanner(
    label='Evaluation metrics',
    columns=7:11
  ) %>%
  tab_style(
    style = cell_borders(
      sides = 'bottom',
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(100),
    column_labels.border.top.width = 2,
    column_labels.border.top.color = "black",
    column_labels.border.bottom.width = 2,
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table.border.bottom.width = 2,
    data_row.padding = px(3),
    column_labels.border.bottom.style = 'none',
    table_body.hlines.color = 'white'
  ) %>%
  opt_horizontal_padding(scale = 0.5) %>%
  opt_vertical_padding(scale = 0.5) %>%
  tab_source_note(
    source_note = "Your source note or additional information here"
  ) %>%
  opt_table_font(font = "Arial") #%>% gtsave("your_table.html")


```

*Caption: Table 1. Model forms and evaluation metrics for the fitted sROS models. Formulae include variables representing 10-metre wind speed (WS~10~), initial spread index (ISI), stand-adjusted ISI (ISI~sa~), surface fuel consumption (SFC, kg m^-2^), and fuel type (FT). ISI/ISI~sa~ columns represent predicted ROS (m min^-1^) for given models at each predictor level. Constants used in prediction calculations include FFMC 91 (Models 1, 5, 19), SFC of 1.5 kg m^-2^ (Models 7 and 9), and fuel type 'Conifer' (Model 15). Evaluation metrics are unitless and include root mean squared error (RMSE), mean absolute error (MAE), mean absolute percentage error (MAPE), Efron's R-squared (ER2), and Akaike's Information Criterion (AIC). Predefined functions (not fitted) include C-3S, C-4S, C-6S, D-1, and M25, which were evaluated against the 51 boreal conifer fire observations.*

```{r ISIpreds, echo=FALSE}
#summary of ISI 5-15 vals
acc.extract<- filter(acc.tab4, !Num %in% c(16:19)) %>%
  select('ISI=5', 'ISI=10', 'ISI=15') %>% round(2)

min5 <- acc.extract %>% pull('ISI=5') %>% min()
max5 <- acc.extract %>% pull('ISI=5') %>% max()
mean5 <-acc.extract %>% pull('ISI=5') %>% mean() 

min10 <- acc.extract %>% pull('ISI=10') %>% min()
max10 <- acc.extract %>% pull('ISI=10') %>% max()
mean10 <-acc.extract %>% pull('ISI=10') %>% mean() 

min15 <- acc.extract %>% pull('ISI=15') %>% min()
max15 <- acc.extract %>% pull('ISI=15') %>% max()
mean15 <-acc.extract %>% pull('ISI=15') %>% mean()

```

### Final fitted models

Table 1 shows evaluation metrics for the list of final fitted models, as well as *ROS* predictions at three levels of *ISI* or *ISI~sa~*. Other variables (FFMC, SFC, FT) were assigned values for calculation purposes, as noted. As the table indicates, the datasets used varied from `r min(acc.tab4$N, na.rm=T)` to `r max(acc.tab4$N, na.rm=T)` observations. Models using the SFC predictor excluded observations without estimated SFC, resulting in slightly smaller datasets. 'Aggregated data' models included all surface fire observations; this included fires in boreal conifer, deciduous-mixed, and PPDF stands as well as three well-documented wildfires. Boreal conifer models used only the aforementioned fires in spruce, pine-spruce, or boreal/sub-boreal pine [for site and experimental descriptions see @perrakis2023]. Models 2–4 included all fires, while models 5–15 excluded fires that exhibited more significant torching, as noted. Excluding the FBP models (16 –19), *ISI* or *ISI~sa~* values of 5, 10, and 15 conditions predict ROS of `r min5` – `r max5` (mean: `r mean5`) m min^-1^; `r min10` – `r max10` (mean: `r mean10`) m min^-1^; and `r min15` – `r max15` (mean: `r mean15`) m min^-1^, respectively. Also shown are evaluation results using the previously described Van Wagner and FBP surface fire models. Models forms 1–4 and 13–14, using the boreal conifer observations, had lower variability and thus better performance (lower RMSE, higher ER2, lower MAE and MAPE) than analogous models fitted to the larger aggregated dataset (Models 5 – 12, 15).

Non-linear model forms had insufficient data to automatically fit the asymptote parameters, using either a fixed value (eq. [2]) or linear function asymptote (eq. [3]). Rather than setting an arbitrary asymptote value (e.g., a=20 was initially tested), we set an oblique asymptote (eq. [3]) based on visual inspection and an assumed gradual ROS rise beyond the range of data to account for extrapolation, as in the original FBP System [@forestrycanadafiredangergroup1992]. The asymptote parameters were similar in slope but translated slightly higher for conifer compared with aggregate models; aggregate: *m*=0.15, *i*=10; conifer: *m*=0.15, *i*=13. The remaining parameters were fitted to the data, producing relatively high-performing models, particularly for the boreal conifer dataset (Models 13, 14: RMSE \< 1.2, ER2 \> 0.7, MAE \< 0.9 m min^-1^). The corresponding aggregated forest data models performed adequately, but reflected greater variability in the source data at higher wind and *ISI* or *ISI~sa~* levels. The best aggregate data model included *ISI~sa~* and *SFC* predictors (Model 9: RMSE=1.32, ER2=0.662, MAE \<1 m min^-1^). The best nonlinear aggregate model was Model 11 (RMSE=1.43, ER2=0.589, MAE=1.05 m min^-1^). Extended predictions showing expected ROS at varying SFC and FT levels (Models 7, 9, and 15) are shown in Appendix C.

Table 1 also compares ROS predictions for conifer stands from the older Van Wagner [@vanwagner1993a] and FBP surface fire functions, as well as the M25% model, with the new fitted models. High MAE and MAPE values, and negative values for ER2, suggest very poor performance by (especially) the C-4s and C-6s models compared to the fire observations. The C-3s, D1, and M25% models, in contrast, are in the lower end of the range of model performance, but otherwise appear to produce unbiased results. When evaluated against the deciduous data alone, the D-1 model had the following diagnostics: RMSE=0.568; MAE=1.297; MAPE=0.988; ER2=0.543.[^1] There were no apparent advantages to the $a \cdot ISI ^{b}$ model (Model 12) over other model forms.

[^1]: Note: the dataset for the D-1 model originally described by [@forestrycanadafiredangergroup1992] differs only from present deciduous database by two additional wildfires, excluded here to a lack of documentation.

### [Table S2: Extended SFC prediction calcs]

```{r Table 2, echo=FALSE}
#
#extra table for SFC-based models
multiv.names <- c(rep(c('ISI2SFC.agg', 'isim2SFC.agg'), each=4), rep('ftISI', 3))
sfc.levels <- c(0.7, 1.5, 3, 5)
ft.levels <- c('Decid', 'Con', 'PPDF')

#sf.isi2sfc.fun and sf.isim2sfc.fun - calc ROS for 3 ISI vals, 4 SFC vals
sfc.isivals <- mapply(FUN=sf.isi2sfc.fun, isi=rep(isi.vals, 4), 
                 sfc=rep(sfc.levels, each=3)) %>%
  matrix(nrow=4, ncol=3, byrow=TRUE) %>%  #calculate ROS for each
  as.data.frame() 
colnames(sfc.isivals) <- isi.colnames

sfc.isimvals <- mapply(FUN=sf.isim2sfc.fun, #apply sf.isim2sfc function across isi.vals
                       isim=rep(isi.vals,4),
                sfc=rep(sfc.levels, each=3)) %>%
  matrix(nrow=4, ncol=3, byrow=TRUE) %>%
  as.data.frame()
colnames(sfc.isimvals) <- isi.colnames

ftisi.vals <- mapply(FUN=ft.isi.fun, #apply ft.isi.fun across isi.vals
                       isi=rep(isi.vals, 3),
                ft=rep(ft.levels, each=3)) %>%
  matrix(nrow=3, ncol=3, byrow=TRUE) %>%
  as.data.frame()
colnames(ftisi.vals) <- isi.colnames

#combine df for both models
sfc.allvals <- rbind(sfc.isivals, sfc.isimvals, ftisi.vals) %>%
  round(2)

ex.sfc.tab <- mutate(sfc.allvals, 
                     Model=multiv.names, 
                     SFC=c(rep(sfc.levels, 2),NA, NA, NA),
                     FT=c(rep('Agg', 8), ft.levels),
                     num=1:11) %>%
  select(num, Model, SFC, FT, everything())

#####################################



#ex.sfc.tab table, formatted using gt

extended.sfc.final <-ex.sfc.tab %>% 
  mutate(Model=c(rep(c('7 (ISI, SFC)', '9 (ISI_sa, SFC)'), each=4), 
                 rep('15 (ISI, FT)', 3))) %>%
  select(-num) %>%
  rename('SFC \n (kg/m2)'=SFC, 'Model (predictors)'=Model) %>%
  gt() %>%
  tab_header(
    title = "Extended prediction table for multivariate models" #,
#    subtitle = "Your subtitle (if needed)"
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  cols_width(
    'Model (predictors)' ~ px(100),
    everything() ~ px(60)
  ) %>%
  tab_spanner(
    label='Predicted ROS (m/min)',
    columns=4:6
  ) %>%
  tab_style(
    style = cell_borders(
      sides = 'bottom',
      color = "black",
      weight = px(1)
    ),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(100),
    column_labels.border.top.width = 2,
    column_labels.border.top.color = "black",
    column_labels.border.bottom.width = 2,
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table.border.bottom.width = 2,
    data_row.padding = px(3),
    column_labels.border.bottom.style = 'none',
    table_body.hlines.color = 'white'
  ) %>%
  opt_horizontal_padding(scale = 0.5) %>%
  opt_vertical_padding(scale = 0.5) %>%
  #tab_source_note(
  #  source_note = "Your source note or additional information here"
  #) %>%
  opt_table_font(font = "Arial") #%>% gtsave("your_table.html")

#compare SFC to sqrt(SFC)
ef.sfc.mod1 <- ef.r.squared(actual=augment(m7.sros.ISI2SFC.mod) %>% 
                              pull(ROS), 
             pred=augment(m7.sros.ISI2SFC.mod) %>% pull(.fitted))

ef.sfc.mod2 <- ef.r.squared(actual=augment(m9.sros.isim2SFC.mod) %>% 
                              pull(ROS), 
             pred=augment(m9.sros.isim2SFC.mod) %>% pull(.fitted))

ef.sfc.mod10 <- ef.r.squared(
  actual=augment(update(m7.sros.ISI2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(ROS),
  pred=augment(update(m7.sros.ISI2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(.fitted))

ef.sfc.mod20 <- ef.r.squared(
  actual=augment(update(m9.sros.isim2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(ROS), 
  pred=augment(update(m9.sros.isim2SFC.mod, ~.-sqrt(SFC) + SFC)) %>% 
    pull(.fitted))

```

### [Figure 4, high influence]

```{r label=Fig4, echo=FALSE}
#Do nlstools jackknife resampling to identify overly influential obs
#do this on crisiCon, crisimCon, 

#jack.crisiCon <- nlstools::nlsJack(sf.con.mod)  #old, fixed a
jack.crisiCon <- nlstools::nlsJack(m13.sf.con.asy)
#summary(jack.crisiCon)
#crisiCon: rows 10, 28, 49, 51 (s.con2)

jack.crisimCon <-nlstools::nlsJack(m14.sf.conM.asy)
#jack.crisimCon <-nlstools::nlsJack(sf.crisimCon.mod)
#summary(jack.crisimCon)
#crisimCon: rows 10, 28, 51

jack.crisimAgg <-nlstools::nlsJack(m11.sf.aggM.asy) #s.fires.mod
#28, 52, 54, 60, 83, 88, 89, 91  #omit 83; no SFC

jack.crisiAgg <-nlstools::nlsJack(m10.sf.agg.asy) 
#28, 58, 59, 60, 88, 91  #only points sig. to both b and c

#for lm models, use broom::augment to run Cook's D
#high influence: D >1, or 0.5, or 4/n
#n=84 #aggregate with SFC
#n=91 #aggregate full
#n=51 #con no torch
#4/n = 0.04 - 0.08

#Just pull high cook's D values
cook.isim2sfc <- broom::augment(m9.sros.isim2SFC.mod) %>%
  select(1:4, .cooksd) %>%
  filter(.cooksd > 0.07) %>% #good enough for 4/n for n=51
  mutate(isi.m=sqrt(`I(isi.m^2)`) %>% as.numeric(), 
         SFC=`sqrt(SFC)`^2)
#needs the 'as.numeric' to plot

cook.ISI2sfc <- broom::augment(m7.sros.ISI2SFC.mod) %>%
  select(1:4, .cooksd) %>%
  filter(.cooksd > 0.077) %>%
  mutate(ISI= sqrt(`I(ISI^2)`) %>% as.numeric(), 
         SFC=`sqrt(SFC)`^2)

#cook.isim2sfc %>% top_n(.cooksd, n=10) %>% arrange(desc(.cooksd)) %>% select(1:3, .cooksd)
#cook.ISI2sfc %>% top_n(.cooksd, n=10) %>% arrange(desc(.cooksd))
#isim2sfc: rows 52, 28, 88, 60
#num: 117, 68, 232, 204
#ISI2sfc: rows 58, 28, 88, 59, 60

#model labels
lab1 <- 'M9' #change to dynamic label 
lab2 <- 'M11'
lab3 <- 'M14'  #crisim.con


fig4 +
  # geom_point(data=cook.isim2sfc, shape=5, colour='black', 
  #            size=5) + #diamonds around high Cook's D vals
  geom_point(data=s.fires.mod %>% slice(c(28, 52, 54, 60, 88, 
                                          89, 91)) %>% 
              select(fire, ISI, isi.m, ROS, FT, SFC), shape=2,
             colour='black', size=5) + #triangles - influential to agg mods
  geom_point(data=s.con2 %>% slice(c(10, 28, 51)) %>% 
              select(fire, ISI, isi.m, ROS, FT), shape=5,
              colour='black', size=5) + #diamongs - influ to con mods
  geom_text(x=23, y=sf.isim2sfc15.fun(23)+1, label=lab1, 
            colour='purple', size=4) +
  geom_text(x=24, y=sf.crisim.fun(24)-1, label=lab2,
            colour='purple') +
  geom_text(x=19, y=sf.crisimCon.fun(19)+1, label=lab3,
            colour='pink') +
  labs(x=expression(ISI[sa]), y='ROS (m/min)', size=expression(SFC~(kg/m^{2})), ## ~ is space; ^{2} is superscript 2 for squared term
       colour='Fuel type') +
  theme(legend.position='none')
  
```

*Caption: Figure 4. Surface fire rate of spread (ROS) observations and selected fitted models, using the stand-adjusted initial spread index (ISI~sa~). Colours indicate fuel type as follows: red: boreal conifer; blue: ponderosa pine-Douglas-fir (PPDF) adjusted to 95 %-cured condition; green: deciduous; gray: original PPDF (not modelled). Size indicates surface fuel consumption. Observations with black centres are documented wildfires; the remainder are experimental fires. Observations with diamonds and triangles are high influence observations (both fitted parameters) associated with nonlinear conifer (M14) and aggregate (M11) models, respectively, based on jackknife resampling.*

Figure 4 shows the surface ROS observations plotted by overall fuel type (boreal conifer, deciduous, or PPDF) and SFC against *ISI~sa~*, along with three of the fitted models: M9 (calculated at SFC=1.5 kg m^-2^), M11, and M14 (boreal conifer only). PPDF fires adjusted to 95% curing conditions were used in model fitting, while the original observations (not included in models) are also shown.

Figure 5 shows the observations based on the ISI, along with selected fitted and benchmark models. Model 15 is shown separated by FT class – boreal conifer (Con), PPDF (95% cured), or deciduous (Decid). For ROS prediction purposes, Decid \< Con \< PPDF (see Table 1 and Appendix 1); however, only the Con-PPDF and Decid-PPDF differences were significant (Tukey's HSD; $\alpha=0.05$ ). Figure 5 also shows are the noted overprediction tendencies of the C-6s and C-4s models.

As Table 1 indicates, 'aggregated' dataset models (e.g. M10, M15) performed generally worse (higher MAE, MAPE, lower Efron's R-squared) than the boreal conifer-based models (e.g. M13) when using ISI-based predictors, although M15 performed relatively well overall, with MAE \~ 1 and ER2 of 0.629.

#### Influential observations #not sure if this is needed

Individual observations were evaluated for leverage in the best models using Cook's Distance and jackknife resampling. For non-linear models 10, 11, 13 and 14#, observations were flagged when the difference between model parameters calculated with and without individual estimates, $\Delta$, was $\Delta>\frac {2 s} {\sqrt{n}}$, where *s* is the standard error of the parameter estimate and *n* is the sample size [@baty2015]. For linearized models (Models 7 and 9#), observations with Cook's D \> 0.78 were flagged as influential, based on the 'high influence' threshold of 4/n, using n=51 from the conifer dataset (not shown; see Appendix#). High influence observations are shown in Figures 4 and 5 and consist mainly of high *ISI*/*ISI~sa~* and high ROS observations, particularly wildfires.

### [Fig 5]

```{r label=Fig5, echo=FALSE}
lab4 <- 'M15'
lab5 <- 'M13'

fig5 + 
  geom_point(data=s.con2 %>% slice(c(10, 28, 49, 51)) %>% #con mods jackknife
               select(ROS, ISI, SFC, FT), shape=5, size=5, colour='black') +
  # geom_point(data=s.fires.mod %>% slice(c(28, 58, 59, 60, 88, 91)) %>% #agg jk
  #              select(ROS, ISI, SFC, FT), shape=2, size=5, colour='black') +
  geom_point(data=cook.ISI2sfc, shape=2, size=5, 
             colour='black') + #triangles around high cooks D vals
  stat_function(fun=ft.isi.fun, args=list(
    ft='Con', mod=2), color='red2') + #M15 FT mod
  stat_function(fun=ft.isi.fun, args=list(
    ft='PPDF', mod=2), color='blue4') + #M15 FT 
  stat_function(fun=ft.isi.fun, args=list(
    ft='Decid', mod=2), color='green3') + #M15 FT
  stat_function(fun=sf.crisiCon.fun, color='pink') +  
  geom_text(x=10, y=c4s(10)+3, label='C-4s', colour='turquoise') +
  geom_text(x=25, y=ft.isi.fun(isi=25, mod=2)+1, label=lab4) +
  geom_text(x=24, y=c3s(24)-1, label='C-3s', colour='purple') +
  geom_text(x=26, y=sf.crisiCon.fun(26)+1.2, label=lab5, colour='pink')+
  geom_text(x=19, y=c6s(19)+1.5, label='C-6s', colour='darkred') +
  stat_function(fun=c3, colour='gray') +
  geom_text(x=20, y=c3(20)-1.5, label='C-3', colour='gray') +
  coord_cartesian(x=c(1, 30), y=c(0, 25)) +
  labs(x='ISI', y='ROS (m/min)') +
  theme(legend.position='none')
#  geom_point(data=d1.missing, inherit.aes=TRUE)

```

*Caption: Figure 5. Surface fire observations by ISI, ROS, and fuel type (FT): green (deciduous; Decid), blue (Ponderosa pine-Douglas-fir; PPDF), or red (boreal conifer; Con), along with sigmoidal model M13 (Con only), fuel type (FT) category model M15 (Con, Decid and PPDF), and FBP-era models (C-3s, C-4s, C-6s, C-3). PPDF fires are shown both with their original observed ROS (gray, not modelled), and normalized to 95% cured condition (blue, modelled). Model labels are colour-coded to line colour except for M15. Observations with diamonds represent high influence observations (for both fitted parameters) associated with M13, based on jackknife resampling.*

## 5. Discussion

### Operational surface ROS models

Since wildfires in conifer stands spreading under higher danger conditions tend to be crown fires [@vanwagner1977a; @beverly2020; @cruz2022], the majority of surface fires occurred during moderate-level fire danger indices and wind speeds. Crown fire occurrence in conifer forests has long been modeled using canopy base height and surface fire intensity [@vanwagner1977], or more recently, surface fuel consumption as a surrogate [@cruz2004; @perrakis2023]. This explains the existence of a few surface fires (in tall pine stands) in our database under high danger conditions (i.e., dry and-or windy: ISI \> 10). Due to the risk associated with experimental burning under high danger conditions, a small number of wildfires exhibiting surface fire behaviour were also included to populate this range of *ISI*/*ISI~sa~* values. Due to the lack of data and high variability, individual high danger observations tended to be highly influential in regression models. Despite this warning, there is no way of removing these observations without significantly affecting the models and their range of inference. Primary source descriptions that exist for these fires [e.g. @vanwagner1965b] reflect their age and simple estimation methods, unsurprisingly. Overall, our surface fire database represent a range of ROS values (0.3–12.0 m min^-1^) described as 'slow' to 'fast', but primarily in the 'moderately slow' (1–3 m min^-1^) to 'moderately fast' (3–10 m min^-1^) category [@alexander1989].

As wildfire hazard reduction treatments become more widespread, where stands with high CBH and low surface fuel loading are engineered to resist crown fire [e.g., @agee2005; @hirsch1999], there is a need to estimate sROS under higher danger conditions. The lack of data under more extreme conditions creates uncertainty that cannot be solved by these models alone but will require additional observations for validation, from experimental burns or high quality wildfire observations where surface fire behaviour can be identified. These might come from fires in tall pine or Douglas-fir stands with CBH \> 10 m, for instance [@perrakis2025].

### Predictors of surface ROS

While the *ISI* is old and familiar, it was the strongest ROS predictor, performing better than other combinations of weather or moisture index variables. The *ISI* was recently found to be the variable most closely correlated to area burned during the record-breaking 2023 Canadian wildfire season [@jain2024]. Database values used in the analysis represent indices that best represent burning conditions according to primary sources; for forecasting purposes, we expect hourly *ISI* values to perform better than daily values [@beck2002]. The *ISI~sa~* adds some additional influences based on the stand-adjusted moisture estimate models [@wotton2007], including the ability to adjust for stand density and more persistent forest floor drought (as represented by the DMC).

The present surface fire models involve mainly weather and moisture-related inputs, with some influence from fuel type and SFC in some models. In-stand ground-level wind speed ('mid-flame') is used in several empirical models due to its apparent direct influence on flame propagation [@rothermel1972; @anderson2015]. We might therefore expect overstory vegetation density or structure to influence ROS considerably in our models, due to the vegetation influence on ground-level wind speed, turbulence, and other aspects of micrometeorology [@amiro1990; @dupont2008; @moon2019]. However, the variability in our data did not lend itself to strong fuel type differences, and fuel type was mainly a useful covariate for reflecting the difference between transformed PPDF fires and other fuel types under low-moderate danger conditions. As for density class, it was only significant in *ISI~sa~*-based models where density class already influences fuel moisture through the @wotton2007 model; as such, it was considered confounded and likely overfitted. SFC was a useful second ROS predictor (Models 7, 9), though it itself must be modelled from fuel loading or fuel type and indices of moisture deficit. Practical methods include the FBP fuel type-based models using the buildup index [@forestrycanadafiredangergroup1992] or other similar empirical consumption models [@degroot2009]. Importantly, the influence of SFC in Models 7 and 9 was highest at low *ISI* (or *ISI~sa~*) values, and became negligible under higher *ISI* conditions (Appendix C).

### Using final surface rate of spread models

The primary value of such surface ROS models may be to inform varying fuel structure scenarios in dynamic modelling systems [e.g., @perrakis2020; @perrakis2024b; @cfsfiredangergroup2021], where tools such as calculators and lookup tables enable users to test various fuel structure and weather scenarios. As noted, conifer species was generally not a significant ROS predictor; however, differences in experimental design (e.g. plot size, fuelbreak width, frequency of wind monitoring) may mask small but significant differences. Laboratory experiments have suggested that a range of conifer litterbed characteristics, including species and bulk density, can affect heat fluxes and overall flammability [@cornwell2015; @wilson1990; @campbell-lochrie2021]; however, laboratory results can be challenging to apply to complex natural forest fuelbeds, requiring a high number of replicates as heterogeneity increases [@mulvaney2016]. In our models, deciduous observations were included for simple comparison purposes; however, no new data was provided beyond the range of the original D-1 spread model, which matches the noisy deciduous fire experiment dataset adequately.

Four or five models presented stand out as superior than the others (Table 1). These include Models 13 and 14, nonlinear curves fitted to boreal and sub-boreal conifer stands with the highest ER2 and lowest MAE values, for use with *ISI* (M13) and *ISI~sa~* (M14) inputs; Model 9, a good 'aggregated data' model suitable for a range of forest types, featuring several user input options thanks to its *ISI~sa~* and *SFC* predictors; Model 15, which showed the influence of fuel type, would be particularly suitable for contrasting between conifer, deciduous and PPDF (at 95% cured) stands; and perhaps the '25 % model', the simplest model for rapid or emergency use.

Although stand density class variables were not significant on their own, the models using *ISI~sa~* incorporate fuel moisture differences via the *mc~sa~*. This allows for some ability to represent, for instance, thinning treatments, where physical modelling studies have suggested that reducing stand density can increase surface ROS [e.g., @parsons2018; @marshall2020]. However, the effects of such differences are relatively small in the present models as the only relationship being simulated is the effects of large density category differences on fuel moisture in the *mc~sa~* model. More significant changes (e.g. clearcutting or severe density reductions) are unlikely to be adequately represented. For instance, in a pine stand under FFMC 92, DMC 100, WS~10~=15 km h^-1^ conditions in summer, decreasing density from 'high' (H) to 'moderate' (M) or 'low' (L) conditions would result in an increase from 3.5 to 3.7 to 4.6 m min^-1^, respectively, using Model 9 (assuming SFC of 1.5 kg m^-2^): a maximum density-dependent difference ($\Delta$) of 1.1 m min^-1^. Varying SFC between 0.5 and 3.5 kg m-2 could further stretch $\Delta$ to 1.8 m min^-1^, holding weather indices constant. This is a small difference for capturing the full range of silvicultural management options. For instance; tree density is often reduced by 70-80% in hazard reduction treatments [@prichard2010; @hirsch1999]. The present models are likely most appropriate for moderately open to closed conifer stands; a lower limit for crown closure would likely to be near 20 % (the level of opening of the more open PPDF and jack pine experiments). Below this limit, very open forests and parkland or savannah-type stand structure would have much greater wind penetration [@albini1979; @moon2019] and could potentially support significantly faster surface fire spread than appears in our data.

As noted, the major limitation of these ROS models and underlying data dataset are the paucity of observations at higher danger conditions (ws or *ISI*). For improving these empirical models, there is no substitute for additional high quality observations. Surface fire observations spreading under high indices would necessarily have high LCBH and-or low SFC; else they would be expected to exhibit crown fire behaviour. Additional surface fire observations under such conditions (high wind, low moisture) are unlikely to come from experimental burning, but could be detected from opportunistic imaging of spreading wildfires [e.g., @hart2021; @valero2018]. Until such data are acquired , predictions beyond the range of data (i.e., *ISI* \> 19.2 or *ISI~sa~* \> 24.5 in conifer stands) constitute extrapolation. While never recommended, extrapolation is often necessary in operational settings [e.g., @forestrycanadafiredangergroup1992]. For such purposes, we suggest the modified Chapman-Richards models (10, 11, 13 or 14) to avoid the more extreme results generated by quadratic term models (with *ISI^2^* or *ISI~sa~^2^*). For example, the conditions in the previous paragraph example (pine stand in summer) but with WS~10~=40 km h^-1^ (producing ISI of `r ISI(92, 40) %>% round(1)` ) would predict ROS of `r predict(m3.con.ISI.mod, newdata=list(ISI=ISI(92, 40))) %>% round(1)` m min^-1^ using Model 3, with its *ISI^2^* term. Model 13, a semi-sigmoidal model, predicts much lower ROS (`r sf.asyCon.fun(ISI(92, 40)) %>% round(1)` m min^-1^) under such conditions. While the actual sROS of this hypothetical example is unknown (expected ROS could be +/- 50 % or more of the predicted value; see below), a surface fire with ROS \> 50 m min^-1^ in conifer forest is highly unlikely [Figure 2; see also @cruz2005; @cruz2019].

Finally, the 25% model is presented in the same vein as the Cruz and Alexander '10% rule' [@cruz2019] and '20% rule' [@cruz2022a] models - as an approximate value suitable for mental arithmetic and rapid field use. However, the unit difference (km h^-1^ vs m min^-1^) is critical in the present case for proper usage. An equal comparison with, for instance, the 10% rule (same units) equates to 1.5 % of the *WS~10~*. This also presents a finding of interest: on average, experimental conifer crown fires in Canada are 5.6 times faster than experimental surface fires under similar wind speeds, since the most accurate approximation for crown fires was 8.4 % of the *WS~10~* [@cruz2019]; (8.4/1.5=5.6).

### [Table 3: Expected accuracy]

```{r label=expectAcc, echo=FALSE, warnings=FALSE}

#MAPE
#sros.isim2SFC.mod
pred1 <- broom::augment(m9.sros.isim2SFC.mod) %>% 
  select(ROS, `I(isi.m^2)`, .fitted) %>%
  rename(pred9=.fitted) %>%
  mutate(isi.m=sqrt(`I(isi.m^2)`),
         ape=abs((ROS-pred9)/ROS),
         diff=abs(pred9-ROS))

#MAPE table, M9
#sros.isim2SFC.mod
mape.m9 <- pred1 %>% #isi.m 12 appears to be a threshold
  group_by(ISI_sa=if_else(isi.m < 12, 'ISI<12', 'ISI>12'), #group by hi/lo 
           Prediction=if_else(ROS < pred9, 'Over', 'Under')) %>% #over/under pred 
  summarize(MAPE=mean(ape) %>% round(2), 
            Q90APE=quantile(ape, 0.9) %>% round(2)) %>% #MAPE and 90th of APE
  ungroup() 

# mape.m9 %>% 
#  gt()

#MAE table, M9
mae.m9 <- pred1 %>% #isi.m 12 appears to be a threshold
  group_by(ISI_sa=if_else(isi.m < 12, 'ISI<12', 'ISI>12'), #group by hi/lo 
           Prediction=if_else(ROS < pred9, 'Over', 'Under')) %>% #over/under pred 
  summarize(MAE=mean(diff) %>% round(2), 
            Q90AE=quantile(diff, 0.9) %>% round(2)) %>% #MAE and 90th of AE
  ungroup() 

pred.m9 <- full_join(mae.m9, mape.m9) 

pred.m9 %>%
  gt() %>%
  tab_style(
    style = cell_borders(
      sides = 'bottom',
      color = "black",
      weight = px(1)
    ), 
  locations=cells_column_labels() ) %>%
  tab_options(table_body.hlines.color = 'white') %>%
  tab_source_note(
    source_note = "Note: The threshold between 'High' and 'Low' ISI_sa values is 12"
  )

```

*Caption: Table 3. Expected model accuracy, Model 9.*

### Expected accuracy {#expected-accuracy-1}

The MAE and MAPE values (Table 1) can be used to calculate the mean and expected (e.g. 90th percentile or quantile) error associated with each model. Table 3 shows the mean and 90th quantile absolute error (MAE, Q90AE, respectively) and absolute percentage error (MAPE, Q90APE, respectively) using the example of Model 9, with $sROS=f(ISI_{sa}, SFC)$. Since there appeared to be a difference between the over- and under-prediction error potential at lower versus higher fire danger levels (e.g., Fig. 4), these categories are shown separately. Thus, Surface ROS errors of 1-2 m min^-1^ (approximate rounding of mean and Q90 absolute error of 0.6 – 1.7; Table 3) should be expected at *ISI~sa~* \< 12; and larger errors of perhaps 2-4 m min^-1^ (MAE and Q90AE of 1.7 – 3.5) may be expected in real world use at *ISI~sa~* of 12 – 25. In approximate percentage terms, underprediction by 30-60 %, and overprediction by 70-170 % is to be expected with these models.

While it may be inappropriate to compare the performance of fitted models in their native dataset with that of supposedly independently-derived models, it is apparent that some of the FBP-era models performed very poorly in predicting surface ROS. Negative ER2 values and MAPE of 150 – 380 % suggest that the C-4s and C-6s models perform worse than a null model using only the mean of all observations. These models are therefore not recommended for predicting surface fire behaviour.

Under very low danger conditions (e.g., FFMC \< 75 or ISI \< 1), ignition in needle fuel substrates becomes highly unlikely [@beverly2007; @nadeem2020], so ROS is a minimal concern. It is expected that the quality and quantity of source data will improve over time, allowing for periodic reanalysis and improvement of these models.

## 6. References

::: {#refs}
:::

## 7. Appendices

### Appendix A: Fires in Ponderosa Pine-Douglas-fir stands in BC

Seven\* experimental fires were conducted in open Ponderosa pine-Douglas-fir forest stands in the Dewdrop Range near Kamloops, British Columbia, in 1978-79. These fires were well documented in theses by Nyberg[@nyberg1979] and Smaill [@smaill1980]. Summary information and photos were incorporated into the FBP System C-7 fuel type, where these observations were combined with several wildfires to complete the fuel type [@forestrycanadafiredangergroup1992; @degroot1993].

The Dewdrop observations were reanalyzed in order to merge these fires into the modelling database with common units and analysis methods. Stand structure at Dewdrop consisted of a low density overstory and mostly herbaceous understory; mean canopy closure was 27.2 %. Litter and duff cover were described as patchy to nonexistent [@nyberg1979]. In the FBP System database, surface fuel consumption (SFC) was reported for only one observation (Plot 9), with a very high total SFC value of 5.3 kg m^-2^, including \> 5 kg m^-2^ of woody fuel consumption.

The original SFC estimate for Plot 9 included consumption of all downed woody fuels, including from large diameter coarse woody debris (CWD; \> 7.6 cm). While methodologically consistent with other FBP experimental burns [@stocks1987b; @stocks1989], the Plot 9 CWD consumption represents the great majority of the total SFC and represents an outlier compared to other experiments. For instance, the mean CWD proportion of SFC at the Ontario Kenshoe Lake and Sharpsand Creek sites was 9.2 % [c.f. @stocks1987b; @stocks1989], significantly different from the 50.2 % proportion of consumption at Dewdrop (Mann-Whitney U-test: p \< 0.001). The difference is explained by both higher seasonal drought conditions during the Dewdrop burns (mean Drought Code (DC): 394 at Dewdrop vs 111 at Kenshoe Lake and 161 at Sharpsand; see @vanwagner1987 for DC description), and probably the overall frequency of larger diameter standing trees at Dewdrop, the source of the CWD (\> 17 % of trees in the '\>25 cm' DBH class; cf. [@nyberg1979]); compared with, e.g. \~ 1 % of trees in the '\> 23 cm' DBH class at Kenshoe Lake ('White River'); [@walker1975]).

Including contributions from CWD in surface fires is somewhat at odds with current understanding of flame front dynamics. Consumption studies suggest that most CWD consumption in PPDF stands occurs during post-frontal smoldering rather than during flaming combustion [@monsanto2008; @brown2003; @ottmar2014]. The high SFC at Dewdrop from smoldering CWD could therefore overpredict fire intensity as well as crown fire tendency [@vanwagner1977; @perrakis2023]. To compensate, new SFC values at Dewdrop were calculated excluding the CWD contribution. The updated SFC included only consumption from finer fuels (grass and herbs, litter, duff, and woody debris \< 7.6 cm) and resulted in a new (notably lower: 2.01 kg m^-2^) value for Plot 9.\*\* SFC values calculated using the same methods for Plots 1-6 were 0.47 – 1.39 kg m^-2^.

Also of interest was the summer weather pattern and understory condition during these fires. The 1978 season was described as unusually wet, with measurable rainfall received at the Dewdrop site nearly weekly from April-August [@nyberg1979], an unusual occurrence in this summer-dry climate. Consequently, understory vegetation remained relatively green during the experimental fires. Relative proportions of live and dead grass and forb biomass were used to calculate percent curing values (% C) for these observations, in the same manner as used in Australian and Canadian grass fire models [@cheney1998; @wotton2009]:
$$\% C = \frac {GB_D} {(GB_D + GB_L)} \cdot 100 $$ 
[Eq.A1], where % *C* is the percent curing, and *GB~D~* and *GB~L~* represent dead and live grass and forb biomass (kg m^-2^), respectively. Using mean values from experimental and control plot sampling on each given date [@nyberg1979] gave % *C* values of 56-66 for Plots 1-6. For Plot 9, reported values are unfortunately less explicit between live and dead biomass [@smaill1980] and equation [A1] could not be used. Based on the slightly lower overall grass moisture value (22.7 %) and late season date, % C for that plot was estimated at 80%.

These analyses allowed us to incorporate the dry cordilleran Dewdrop experimental fires in our surface fire models (aggregated fuel type), despite being somewhat distinct from the primarily boreal conifer and deciduous experiments.

\*Plot numbers 1–6, burned in 1978, are described by [@nyberg1979]. Plot 9, burned in 1979, is described by [@smaill1980]. Plot 8 from the same site was apparently burned in 1980, but no further description or details have been located.

\*\*SFC estimates represent the differences between pre-burn and post-burn fuel loading, including contributions from woody fuels, grasses and forbs, and litter (the site featured negligible duff quantities). Estimating litter consumption values required an estimate of pre-burn litter depth, which was not reported but was instead taken from Ducherer et al. [@ducherer2009], a later series of experiments at a nearby site, < 5 km away. The mean litter depth from control sites across all years and canopy positions: 3.3 cm).

### Appendix B: Matrix of predictors for model building

In comparing ISI-type models with FFMC- (or mcSA-) and wind speed-based models, the single predictor models using *ISI~sa~* (*ISI~sa~*/*ISI~sa~^2^*) were superior based on RMSE, ER2, MAE and MAPE; however, using ISI (ISI/ISI^2^), results were equivocal, with better (higher) ER2 for the ISI/ISI^2^ models, but also higher (worse) RMSE and MAE for single predictor models. For MAPE, the ISI model was superior to the ws + mc~FFMC~ combination.

###[Table A1: Variable matrix]

```{r label=VarMatrix, echo=FALSE, warnings=FALSE}
lp.mods.lst2 <- summary(lp.mods2)[[7]] 
lp.mods.lst3 <- summary(lp.mods3)[[7]] 
#uses lp.mods2 from the 'Complex modelling attempts' section

#following Perplexity code
wh <- summary(lp.mods3)$which  #generates rows=models, cols=(intercept, preds)

wh.df0 <- as.data.frame(wh) %>% select(-1) %>%  #get rid of intercept
  rownames_to_column('model_label') %>%
  mutate(model_id=row_number())

#identify which columns are predictors (all except model_id)
pred_cols <- setdiff(names(wh.df0), c('model_label', 'model_id'))

#model size per model
wh.df <- wh.df0 %>%
  mutate(
    mod_size = rowSums(across(all_of(pred_cols))))

#rank models within each size by current order
wh.models <- wh.df %>%
  distinct(model_id, mod_size) %>%
  group_by(mod_size) %>%
  arrange(model_id, .by_group=TRUE) %>%
  mutate(model_rank=row_number()) %>%
  ungroup() %>%
  filter(mod_size <= 5, model_rank <=4) # keep only sizes up to 4, best 3 #chg

#expand to predictor level
wh.long <- wh.df %>%
  inner_join(wh.models, by=c('model_id', 'mod_size')) %>%
  pivot_longer(
    cols=all_of(pred_cols),
    names_to = 'predictor',
    values_to = 'included') %>%
  filter(included)
  
#for each (mod_size, predictor), keep the *best* model
#based on frequency and best rank among those
by.size.pred <- wh.long %>%
  group_by(mod_size, predictor) %>%
  summarize(
    freq = n_distinct(model_rank),
    best_model_rank = min(model_rank),
    .groups = 'drop'
  )

#Build a score - higher freq is better, lower best_model_rank is better
#use min_rank on that score to deal with ties, and make gaps after ties
ranked <- by.size.pred %>%
  group_by(mod_size) %>%
  mutate(
    score = (-freq) * 10 + best_model_rank,  #any monotone transform is ok
    pred_rank = min_rank(score)  #for ties: 1, 1, 3 pattern
  ) %>%
  ungroup()

#keep only top 3 preds per size
# rank.top3 <- ranked %>%
#   group_by(mod_size) %>%
#  # filter(pred_rank <=3) %>%
#   ungroup()

#label columns by size only: best1, etc.
rank.top3b <- ranked %>%
  mutate(
    col_name=case_when(
    mod_size==1 ~ 'Best1v',
    mod_size==2 ~ 'Best2v',
    mod_size==3 ~ 'Best3v',
    mod_size==4 ~ 'Best4v',
    mod_size==5 ~ 'Best5v',
    TRUE ~ NA_character_)
  ) %>%
  filter(!is.na(col_name))

nice_table <- rank.top3b %>%
  select(predictor, col_name, pred_rank) %>%
  distinct() %>%
  pivot_wider(
    names_from = col_name,
    values_from = pred_rank)

nice_table %>% arrange(Best1v, Best2v)


#finally seems to work well.   

#Old 2
# #assign model position
# long.pos <- wh.long %>%
#   group_by(mod_size, model_id) %>%
#   arrange(predictor, .by_group = TRUE) %>%
#   mutate(position = row_number()) %>%
#   ungroup()
# 
# wh.pred.rank <- long.pos %>%
#   group_by(mod_size, position) %>% 
#   arrange(model_rank, predictor, .by_group=TRUE) %>%
#   mutate(pos_rank=row_number()) %>% #rank among top3 of same size containing predictor
#   ungroup() %>%
#   filter(pos_rank <=3)
# 
# #label columns by size and position
# ranked <- wh.pred.rank %>%
#   mutate(
#     col_name=case_when(
#     mod_size==1 ~ 'Best1',
#     mod_size==2 ~ paste0('Best2-v', model_rank),
#     mod_size==3 ~ paste0('Best3-v', model_rank),
#     mod_size==4 ~ paste0('Best4-v', model_rank),
#     TRUE ~ NA_character_)
#   ) %>%
#   filter(!is.na(col_name))
# 
# nice_table <- ranked %>%
#   select(predictor, col_name, pos_rank) %>%
#   distinct() %>%
#   pivot_wider(
#     names_from = col_name,
#     values_from = pos_rank
#   )
# #test
# 
# #old
# #create desired column names
# wh.cols <- wh.pred.rank %>%
#   mutate(col_name=case_when(
#     mod_size==1 ~ 'Best1',
#     mod_size==2 ~ paste0('Best2-', model_rank),
#     mod_size==3 ~ paste0('Best3-', model_rank),
#     mod_size==4 ~ paste0('Best4-', model_rank),
#     TRUE ~ NA_character_)
#   ) %>%
#   filter(!is.na(col_name))
# 
# wh.rank.cols <- wh.cols %>%
#   group_by(col_name) %>%
#   arrange(model_rank, predictor, .by_group=TRUE) %>%
#   mutate(
#     col_rank=row_number()
#   ) %>%
#   ungroup()
# 
# nice_table <- wh.rank.cols %>%
#   select(predictor, col_name, col_rank) %>%
#   distinct() %>%
#   pivot_wider(
#     names_from = col_name,
#     values_from = col_rank
#   )
# 
# 
# wide.df <- wh.cols %>%
#   select(predictor, col_name, rank_within) %>%
#   distinct() %>%
#   pivot_wider(
#    names_from=col_name,
#    values_from=rank_within
#   ) 
# 
# 
# nice_table0 <- wh.pred.rank %>%
#   transmute(
#     predictor,
#     mod_size,
#     model_rank,
#     col_name=paste0('Best', mod_size, 'var'), #Best1, Best2...
#     rank.index=paste0(mod_size, '-', model_rank))
# #  distinct() %>%
# nice_table <- nice_table0 %>% 
#   pivot_wider(
#     names_from=col_name,
#     values_from=rank.index) %>%
#   arrange(rank.index)


```

### Appendix C: Final model coefficients

```{r label=FinalMods, echo=FALSE, warnings=FALSE}
#build table of coefficients for all final models in 
#acc.tab4 (including c6s, c4s, etc.)

#process model coefs from mod.list.long

#extract fitted models (not preexisting functions)
mod.list.models <- mod.list.long[1:15]

#assign model names with numbers
final.names <- as.data.frame(modnames) %>% 
  mutate(num=row_number(), 
         Model=str_c(num, '. ', modnames))

#produce tidy tables of model parameters

#tidy mod.list to create simple list object
param.list <- purrr::map(
  mod.list.models, tidy) #present clean table of model params and stats

names(param.list) <- slice(final.names, 1:15) %>% 
  pull(Model)

#change list to data frame
mod.params.df <- bind_rows(param.list, .id='Model') %>%
  rename(Term=term, Estimate=estimate) %>%
  mutate(Model=if_else(Model==lag(Model), '.', Model)) 
  #if name is same as previous, just write a dot .
mod.params.df$Model[1] <- names(param.list)[[1]] #fix first name

print(mod.params.df, n=nrow(mod.params.df))
         
  

```

### Table A2: Extended SFC table

Extended ROS predictions were compared for the three aggregated data models with two predictors, Models 7, 9 and 15: *ISI* (or *ISI~sa~*) and *SFC,* and *ISI* and fuel type (Table S2). SFC-based models used a *sqrt(SFC)* term, which performed slightly better (*ISI*: Efron's R^2^=`r ef.sfc.mod1 %>% round(4)`); *ISI~sa~*: adjusted R^2^=`r ef.sfc.mod2 %>% round(4)`) than an untransformed *SFC* term (*ISI*: `r ef.sfc.mod10 %>% round(4)` ; *ISI~sa~*: `r ef.sfc.mod20 %>% round(4)` , respectively).

```{r label=ExtSFC, echo=FALSE}

extended.sfc.final
```

*Caption: Table A2. Extended predictions for models 7 and 9, using varying values of predicted Surface Fuel Consumption (SFC; Models 7 and 9) from 0.7 kg m^-2^ to 5.0 kg m^-2^, fuel types (FT; Model 15) Deciduous (Decid), Conifer (Con) or Ponderosa pine-Douglas-fir (PPDF, adjusted to 95% cured), and ISI or ISI~sa~ values from 5 to 15. See Table 1 for model predictor forms.*
